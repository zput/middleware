<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="mysql知识思维分类,浅入浅出"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="锁"><meta property="og:description" content="mysql知识思维分类,浅入浅出"><meta property="og:type" content="article"><meta property="og:url" content="https://zput.github.io/middleware/docs/mysql/business_facing/innodb_lock/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-01-24T10:33:00+00:00"><meta property="article:modified_time" content="2020-01-24T10:33:00+00:00"><title>锁 | 常用中间件分析</title><link rel=manifest href=/middleware/manifest.json><link rel=icon href=/middleware/favicon.png type=image/x-icon><link rel=stylesheet href=/middleware/book.min.76f6dbe75c94e688c018dd8b54e7f880916b14ab4cf3881b81f75d6bb916603c.css integrity="sha256-dvbb51yU5ojAGN2LVOf4gJFrFKtM84gbgfdda7kWYDw=" crossorigin=anonymous><script defer src=/middleware/flexsearch.min.js></script>
<script defer src=/middleware/en.search.min.31150800969b9bd8dffb5ce66949a704f91d058d1025f8b51a41ac48e40a77df.js integrity="sha256-MRUIAJabm9jf+1zmaUmnBPkdBY0QJfi1GkGsSOQKd98=" crossorigin=anonymous></script>
<script defer src=/middleware/sw.min.f609352e1b128d348128bfdb614a37fe64cd10a16425cbece15ecafa5115c45a.js integrity="sha256-9gk1LhsSjTSBKL/bYUo3/mTNEKFkJcvs4V7K+lEVxFo=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/middleware/><span>常用中间件分析</span></a></h2><div class=magic><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64><div class="book-search-spinner spinner hidden"></div><ul id=book-search-results></ul></div><div class=book-switch><label class=switch><input id=dark-mode-checkbox type=checkbox onchange=darkmode()>
<span class=slider></span></label></div></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>Zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><hr><ul><li><span>Mysql</span><ul><li><a href=/middleware/docs/mysql/init/>开始篇</a><ul><li><a href=/middleware/docs/mysql/init/install/>初始化</a></li></ul></li><li><a href=/middleware/docs/mysql/business_facing/>面向业务篇</a><ul><li><a href=/middleware/docs/mysql/business_facing/sql/>写好sql</a></li><li><a href=/middleware/docs/mysql/business_facing/innodb_index/>索引</a></li><li><a href=/middleware/docs/mysql/business_facing/innodb_lock/ class=active>锁</a></li></ul></li><li><span>高级篇</span><ul><li><a href=/middleware/docs/mysql/advanced/page_lock_log/>底层结构</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script><script src=/middleware/magic.js></script>
<script src=/middleware/dark.js></script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/middleware/svg/menu.svg class=book-icon alt=Menu></label>
<strong>锁</strong>
<label for=toc-control><img src=/middleware/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#表锁偏读>表锁(偏读)</a><ul><li><a href=#环境准备>环境准备</a></li><li><a href=#锁表的命令>锁表的命令</a></li><li><a href=#读锁案例>读锁案例</a></li><li><a href=#写锁案例>写锁案例</a></li><li><a href=#案例结论>案例结论</a></li><li><a href=#表锁分析>表锁分析</a></li></ul></li><li><a href=#行锁偏写>行锁(偏写)</a><ul><li><a href=#环境准备-1>环境准备</a></li><li><a href=#行锁案例>行锁案例</a></li><li><a href=#索引失效行锁变表锁>索引失效行锁变表锁</a></li><li><a href=#间隙锁的危害>间隙锁的危害</a></li><li><a href=#如何锁定一行>如何锁定一行</a></li><li><a href=#案例结论-1>案例结论</a></li><li><a href=#行锁分析>行锁分析</a></li></ul></li><li><a href=#死锁>死锁</a></li><li><a href=#数据一致性>数据一致性</a></li></ul></nav></aside></header><article class=markdown><h1 id=表锁偏读>表锁(偏读)
<a class=anchor href=#%e8%a1%a8%e9%94%81%e5%81%8f%e8%af%bb>#</a></h1><p><strong>表锁特点：</strong></p><ul><li>表锁偏向<code>MyISAM</code>存储引擎，开销小，加锁快，无死锁，锁定粒度大，发生锁冲突的概率最高，并发度最低。</li></ul><h2 id=环境准备>环境准备
<a class=anchor href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e># 1、创建表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>INT</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> <span style=color:#66d9ef>AUTO_INCREMENT</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>VARCHAR</span>(<span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>)<span style=color:#66d9ef>ENGINE</span><span style=color:#f92672>=</span>MYISAM <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CHARSET</span><span style=color:#f92672>=</span>utf8 COMMENT<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;测试表锁&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2、插入数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;ZhangSan&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;LiSi&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;WangWu&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;ZhaoLiu&#39;</span>);
</span></span></code></pre></div><h2 id=锁表的命令>锁表的命令
<a class=anchor href=#%e9%94%81%e8%a1%a8%e7%9a%84%e5%91%bd%e4%bb%a4>#</a></h2><blockquote><p>1、查看数据库表锁的命令。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e># 查看数据库表锁的命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SHOW</span> OPEN <span style=color:#66d9ef>TABLES</span>;
</span></span></code></pre></div><blockquote><p>2、给<code>mylock</code>表上读锁，给<code>book</code>表上写锁。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e># 给mylock表上读锁，给book表上写锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>LOCK</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span> <span style=color:#66d9ef>READ</span>, <span style=color:#f92672>`</span>book<span style=color:#f92672>`</span> <span style=color:#66d9ef>WRITE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看当前表的状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SHOW</span> OPEN <span style=color:#66d9ef>TABLES</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+------------------------------------------------------+--------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>Database</span>           <span style=color:#f92672>|</span> <span style=color:#66d9ef>Table</span>                                                <span style=color:#f92672>|</span> In_use <span style=color:#f92672>|</span> Name_locked <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+------------------------------------------------------+--------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> sql_analysis       <span style=color:#f92672>|</span> book                                                 <span style=color:#f92672>|</span>      <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span>           <span style=color:#ae81ff>0</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> sql_analysis       <span style=color:#f92672>|</span> mylock                                               <span style=color:#f92672>|</span>      <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span>           <span style=color:#ae81ff>0</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+------------------------------------------------------+--------+-------------+</span>
</span></span></code></pre></div><blockquote><p>3、释放表锁。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e># 释放给表添加的锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>UNLOCK</span> <span style=color:#66d9ef>TABLES</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看当前表的状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SHOW</span> OPEN <span style=color:#66d9ef>TABLES</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+------------------------------------------------------+--------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> <span style=color:#66d9ef>Database</span>           <span style=color:#f92672>|</span> <span style=color:#66d9ef>Table</span>                                                <span style=color:#f92672>|</span> In_use <span style=color:#f92672>|</span> Name_locked <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+------------------------------------------------------+--------+-------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> sql_analysis       <span style=color:#f92672>|</span> book                                                 <span style=color:#f92672>|</span>      <span style=color:#ae81ff>0</span> <span style=color:#f92672>|</span>           <span style=color:#ae81ff>0</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> sql_analysis       <span style=color:#f92672>|</span> mylock                                               <span style=color:#f92672>|</span>      <span style=color:#ae81ff>0</span> <span style=color:#f92672>|</span>           <span style=color:#ae81ff>0</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+--------------------+------------------------------------------------------+--------+-------------+</span>
</span></span></code></pre></div><h2 id=读锁案例>读锁案例
<a class=anchor href=#%e8%af%bb%e9%94%81%e6%a1%88%e4%be%8b>#</a></h2><blockquote><p>1、打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加读锁。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e># 为mylock表添加读锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>LOCK</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span> <span style=color:#66d9ef>READ</span>;
</span></span></code></pre></div><blockquote><p>2、打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># SESSION1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题1：SESSION1为mylock表加了读锁，可以读mylock表！</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>mylock<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>+----+----------+
</span></span><span style=display:flex><span>| id | name     |
</span></span><span style=display:flex><span>+----+----------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | ZhangSan |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>2</span> | LiSi     |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>3</span> | WangWu   |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>4</span> | ZhaoLiu  |
</span></span><span style=display:flex><span>+----+----------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题2：SESSION1为mylock表加了读锁，不可以修改mylock表！</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>mylock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>name<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;abc&#39;</span> WHERE <span style=color:#e6db74>`</span>id<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1099</span> <span style=color:#f92672>(</span>HY000<span style=color:#f92672>)</span>: Table <span style=color:#e6db74>&#39;mylock&#39;</span> was locked with a READ lock and can<span style=color:#e6db74>&#39;t be updated
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 问题3：SESSION1为mylock表加了读锁，不可以读其他的表！
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mysql&gt; SELECT * FROM `book`;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ERROR 1100 (HY000): Table &#39;</span>book<span style=color:#e6db74>&#39; was not locked with LOCK TABLES
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># SESSION2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 问题1：SESSION1为mylock表加了读锁，SESSION2可以读mylock表！
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mysql&gt; SELECT * FROM `mylock`;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+----+----------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>| id | name     |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+----+----------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>|  1 | ZhangSan |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>|  2 | LiSi     |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>|  3 | WangWu   |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>|  4 | ZhaoLiu  |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+----+----------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>4 rows in set (0.00 sec)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 问题2：SESSION1为mylock表加了读锁，SESSION2修改mylock表会被阻塞，需要等待SESSION1释放mylock表！
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mysql&gt; UPDATE `mylock` SET `name` = &#39;</span>abc<span style=color:#960050;background-color:#1e0010>&#39;</span> WHERE <span style=color:#e6db74>`</span>id<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>^C^C -- query aborted
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1317</span> <span style=color:#f92672>(</span>70100<span style=color:#f92672>)</span>: Query execution was interrupted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题3：SESSION1为mylock表加了读锁，SESSION2可以读其他表！</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>book<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>+--------+------+
</span></span><span style=display:flex><span>| bookid | card |
</span></span><span style=display:flex><span>+--------+------+
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>1</span> |    <span style=color:#ae81ff>1</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>7</span> |    <span style=color:#ae81ff>4</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>8</span> |    <span style=color:#ae81ff>4</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>9</span> |    <span style=color:#ae81ff>5</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>5</span> |    <span style=color:#ae81ff>6</span> |
</span></span><span style=display:flex><span>|     <span style=color:#ae81ff>17</span> |    <span style=color:#ae81ff>6</span> |
</span></span><span style=display:flex><span>|     <span style=color:#ae81ff>15</span> |    <span style=color:#ae81ff>8</span> |
</span></span><span style=display:flex><span>+--------+------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>24</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=写锁案例>写锁案例
<a class=anchor href=#%e5%86%99%e9%94%81%e6%a1%88%e4%be%8b>#</a></h2><blockquote><p>1、打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加写锁。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e># 为mylock表添加写锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>LOCK</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>mylock<span style=color:#f92672>`</span> <span style=color:#66d9ef>WRITE</span>;
</span></span></code></pre></div><blockquote><p>2、打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># SESSION1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题1：SESSION1为mylock表加了写锁，可以读mylock的表！</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>mylock<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>+----+----------+
</span></span><span style=display:flex><span>| id | name     |
</span></span><span style=display:flex><span>+----+----------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | ZhangSan |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>2</span> | LiSi     |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>3</span> | WangWu   |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>4</span> | ZhaoLiu  |
</span></span><span style=display:flex><span>+----+----------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题2：SESSION1为mylock表加了写锁，可以修改mylock表!</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>mylock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>name<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;abc&#39;</span> WHERE <span style=color:#e6db74>`</span>id<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Rows matched: <span style=color:#ae81ff>1</span>  Changed: <span style=color:#ae81ff>1</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题3：SESSION1为mylock表加了写锁，不能读其他表!</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>book<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1100</span> <span style=color:#f92672>(</span>HY000<span style=color:#f92672>)</span>: Table <span style=color:#e6db74>&#39;book&#39;</span> was not locked with LOCK TABLES
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题1：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>mylock<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>^C^C -- query aborted
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1317</span> <span style=color:#f92672>(</span>70100<span style=color:#f92672>)</span>: Query execution was interrupted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题2：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>mylock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>name<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;abc&#39;</span> WHERE <span style=color:#e6db74>`</span>id<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>^C^C -- query aborted
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1317</span> <span style=color:#f92672>(</span>70100<span style=color:#f92672>)</span>: Query execution was interrupted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 问题3：SESSION1为mylock表加了写锁，SESSION2可以读其他表！</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>book<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>+--------+------+
</span></span><span style=display:flex><span>| bookid | card |
</span></span><span style=display:flex><span>+--------+------+
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>1</span> |    <span style=color:#ae81ff>1</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>7</span> |    <span style=color:#ae81ff>4</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>8</span> |    <span style=color:#ae81ff>4</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>9</span> |    <span style=color:#ae81ff>5</span> |
</span></span><span style=display:flex><span>|      <span style=color:#ae81ff>5</span> |    <span style=color:#ae81ff>6</span> |
</span></span><span style=display:flex><span>|     <span style=color:#ae81ff>17</span> |    <span style=color:#ae81ff>6</span> |
</span></span><span style=display:flex><span>|     <span style=color:#ae81ff>15</span> |    <span style=color:#ae81ff>8</span> |
</span></span><span style=display:flex><span>+--------+------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>24</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=案例结论>案例结论
<a class=anchor href=#%e6%a1%88%e4%be%8b%e7%bb%93%e8%ae%ba>#</a></h2><p><strong><code>MyISAM</code>引擎在执行查询语句<code>SELECT</code>之前，会自动给涉及到的所有表加读锁，在执行增删改之前，会自动给涉及的表加写锁。</strong></p><p>MySQL的表级锁有两种模式：</p><ul><li><p>表共享读锁（Table Read Lock）。</p></li><li><p>表独占写锁（Table Write Lock）。</p></li></ul><p>対<code>MyISAM</code>表进行操作，会有以下情况：</p><ul><li>対<code>MyISAM</code>表的读操作（加读锁），不会阻塞其他线程対同一表的读操作，但是会阻塞其他线程対同一表的写操作。只有当读锁释放之后，才会执行其他线程的写操作。</li><li>対<code>MyISAM</code>表的写操作（加写锁），会阻塞其他线程対同一表的读和写操作，只有当写锁释放之后，才会执行其他线程的读写操作。</li></ul><h2 id=表锁分析>表锁分析
<a class=anchor href=#%e8%a1%a8%e9%94%81%e5%88%86%e6%9e%90>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; SHOW STATUS LIKE <span style=color:#e6db74>&#39;table%&#39;</span>;
</span></span><span style=display:flex><span>+----------------------------+-------+
</span></span><span style=display:flex><span>| Variable_name              | Value |
</span></span><span style=display:flex><span>+----------------------------+-------+
</span></span><span style=display:flex><span>| Table_locks_immediate      | <span style=color:#ae81ff>173</span>   |
</span></span><span style=display:flex><span>| Table_locks_waited         | <span style=color:#ae81ff>0</span>     |
</span></span><span style=display:flex><span>| Table_open_cache_hits      | <span style=color:#ae81ff>5</span>     |
</span></span><span style=display:flex><span>| Table_open_cache_misses    | <span style=color:#ae81ff>8</span>     |
</span></span><span style=display:flex><span>| Table_open_cache_overflows | <span style=color:#ae81ff>0</span>     |
</span></span><span style=display:flex><span>+----------------------------+-------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>可以通过<code>Table_locks_immediate</code>和<code>Table_locks_waited</code>状态变量来分析系统上的表锁定。具体说明如下：</p><p><code>Table_locks_immediate</code>：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1。</p><p><code>Table_locks_waited</code>：出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加1），此值高则说明存在较严重的表级锁争用情况。</p><p><strong>此外，<code>MyISAM</code>的读写锁调度是写优先，这也是<code>MyISAM</code>不适合作为主表的引擎。因为写锁后，其他线程不能进行任何操作，大量的写操作会使查询很难得到锁，从而造成永远阻塞。</strong></p><h1 id=行锁偏写>行锁(偏写)
<a class=anchor href=#%e8%a1%8c%e9%94%81%e5%81%8f%e5%86%99>#</a></h1><p><strong>行锁特点：</strong></p><ul><li>偏向<code>InnoDB</code>存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度最高。</li></ul><p><strong><code>InnoDB</code>存储引擎和<code>MyISAM</code>存储引擎最大不同有两点：一是支持事务，二是采用行锁。</strong></p><p>事务的ACID：</p><ul><li><code>Atomicity [ˌætəˈmɪsəti] </code>。</li><li><code>Consistency [kənˈsɪstənsi] </code>。</li><li><code>Isolation [ˌaɪsəˈleɪʃn]</code>。</li><li><code>Durability [ˌdjʊərəˈbɪlɪti] </code>。</li></ul><h2 id=环境准备-1>环境准备
<a class=anchor href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87-1>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#75715e># 建表语句
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>a<span style=color:#f92672>`</span> <span style=color:#66d9ef>INT</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>b<span style=color:#f92672>`</span> <span style=color:#66d9ef>VARCHAR</span>(<span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>)<span style=color:#66d9ef>ENGINE</span><span style=color:#f92672>=</span>INNODB <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CHARSET</span><span style=color:#f92672>=</span>utf8 COMMENT<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;测试行锁&#39;</span>; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 插入数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;b2&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;3&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;4000&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#39;5000&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>5</span>, <span style=color:#e6db74>&#39;6000&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>6</span>, <span style=color:#e6db74>&#39;7000&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>7</span>, <span style=color:#e6db74>&#39;8000&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>a<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>b<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>&#39;9000&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建索引
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_test_a <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(a);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_test_b <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>test_innodb_lock<span style=color:#f92672>`</span>(b);
</span></span></code></pre></div><h2 id=行锁案例>行锁案例
<a class=anchor href=#%e8%a1%8c%e9%94%81%e6%a1%88%e4%be%8b>#</a></h2><blockquote><p>1、开启手动提交</p></blockquote><p>打开<code>SESSION1</code>和<code>SESSION2</code>两个会话，都开启手动提交。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 开启MySQL数据库的手动提交</span>
</span></span><span style=display:flex><span>mysql&gt; SET autocommit<span style=color:#f92672>=</span>0;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> rows affected <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><blockquote><p>2、读几知所写</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># SESSION1 </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION1対test_innodb_lock表做写操作，但是没有commit。</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行修改SQL之后，查询一下test_innodb_lock表，发现数据被修改了。</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>b<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;88&#39;</span> WHERE <span style=color:#e6db74>`</span>a<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Rows matched: <span style=color:#ae81ff>1</span>  Changed: <span style=color:#ae81ff>1</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>+------+------+
</span></span><span style=display:flex><span>| a    | b    |
</span></span><span style=display:flex><span>+------+------+
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>1</span> | <span style=color:#ae81ff>88</span>   |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>2</span> | <span style=color:#ae81ff>3</span>    |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>3</span> | <span style=color:#ae81ff>4000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>4</span> | <span style=color:#ae81ff>5000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>5</span> | <span style=color:#ae81ff>6000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>6</span> | <span style=color:#ae81ff>7000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>7</span> | <span style=color:#ae81ff>8000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>8</span> | <span style=color:#ae81ff>9000</span> |
</span></span><span style=display:flex><span>+------+------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION2 </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION2这时候来查询test_innodb_lock表。</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 发现SESSION2是读不到SESSION1未提交的数据的。</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>+------+------+
</span></span><span style=display:flex><span>| a    | b    |
</span></span><span style=display:flex><span>+------+------+
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>1</span> | b2   |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>2</span> | <span style=color:#ae81ff>3</span>    |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>3</span> | <span style=color:#ae81ff>4000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>4</span> | <span style=color:#ae81ff>5000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>5</span> | <span style=color:#ae81ff>6000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>6</span> | <span style=color:#ae81ff>7000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>7</span> | <span style=color:#ae81ff>8000</span> |
</span></span><span style=display:flex><span>|    <span style=color:#ae81ff>8</span> | <span style=color:#ae81ff>9000</span> |
</span></span><span style=display:flex><span>+------+------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span> rows in set <span style=color:#f92672>(</span>0.00 se
</span></span></code></pre></div><blockquote><p>3、行锁两个SESSION同时対一条记录进行写操作</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># SESSION1 対test_innodb_lock表的`a`=1这一行进行写操作，但是没有commit</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>b<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;99&#39;</span> WHERE <span style=color:#e6db74>`</span>a<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Rows matched: <span style=color:#ae81ff>1</span>  Changed: <span style=color:#ae81ff>1</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION2 也对test_innodb_lock表的`a`=1这一行进行写操作，但是发现阻塞了！！！</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 等SESSION1执行commit语句之后，SESSION2的SQL就会执行了</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>b<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;asdasd&#39;</span> WHERE <span style=color:#e6db74>`</span>a<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1205</span> <span style=color:#f92672>(</span>HY000<span style=color:#f92672>)</span>: Lock wait timeout exceeded; try restarting transaction
</span></span></code></pre></div><blockquote><p>4、行锁两个SESSION同时对不同记录进行写操作</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># SESSION1 対test_innodb_lock表的`a`=6这一行进行写操作，但是没有commit</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>b<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;8976&#39;</span> WHERE <span style=color:#e6db74>`</span>a<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 6;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Rows matched: <span style=color:#ae81ff>1</span>  Changed: <span style=color:#ae81ff>1</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION2 対test_innodb_lock表的`a`=4这一行进行写操作，没有阻塞！！！</span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION1和SESSION2同时对不同的行进行写操作互不影响</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>b<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span> WHERE <span style=color:#e6db74>`</span>a<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 4;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Rows matched: <span style=color:#ae81ff>1</span>  Changed: <span style=color:#ae81ff>1</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=索引失效行锁变表锁>索引失效行锁变表锁
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88%e8%a1%8c%e9%94%81%e5%8f%98%e8%a1%a8%e9%94%81>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># SESSION1 执行SQL语句，没有执行commit。</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 由于`b`字段是字符串，但是没有加单引号导致索引失效</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>a<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>888</span> WHERE <span style=color:#e6db74>`</span>b<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 8000;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>1</span> row affected, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Rows matched: <span style=color:#ae81ff>1</span>  Changed: <span style=color:#ae81ff>1</span>  Warnings: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SESSION2 和SESSION1操作的并不是同一行，但是也被阻塞了？？？</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 由于SESSION1执行的SQL索引失效，导致行锁升级为表锁。</span>
</span></span><span style=display:flex><span>mysql&gt; UPDATE <span style=color:#e6db74>`</span>test_innodb_lock<span style=color:#e6db74>`</span> SET <span style=color:#e6db74>`</span>b<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;1314&#39;</span> WHERE <span style=color:#e6db74>`</span>a<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>ERROR <span style=color:#ae81ff>1205</span> <span style=color:#f92672>(</span>HY000<span style=color:#f92672>)</span>: Lock wait timeout exceeded; try restarting transaction
</span></span></code></pre></div><blockquote><blockquote><blockquote><p>where条件里面没有使用索引，那么就变成了全表扫描，update 语句也变成了表锁.</p></blockquote></blockquote></blockquote><h2 id=间隙锁的危害>间隙锁的危害
<a class=anchor href=#%e9%97%b4%e9%9a%99%e9%94%81%e7%9a%84%e5%8d%b1%e5%ae%b3>#</a></h2><blockquote><p>什么是间隙锁？</p></blockquote><p>当我们用范围条件而不是相等条件检索数据，并请求共享或者排他锁时，<code>InnoDB</code>会给符合条件的已有数据记录的索引项加锁，对于键值在条件范文内但并不存在的记录，叫做"间隙(GAP)"。</p><p><code>InnoDB</code>也会对这个"间隙"加锁，这种锁的机制就是所谓的"间隙锁"。</p><blockquote><p>间隙锁的危害</p></blockquote><p>因为<code>Query</code>执行过程中通过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值不存在。</p><p>间隙锁有一个比较致命的缺点，就是**当锁定一个范围的键值后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。**在某些场景下这可能会対性能造成很大的危害。</p><h2 id=如何锁定一行>如何锁定一行
<a class=anchor href=#%e5%a6%82%e4%bd%95%e9%94%81%e5%ae%9a%e4%b8%80%e8%a1%8c>#</a></h2><p><img src="https://img-blog.csdnimg.cn/2020080616050355.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt=锁定一行></p><p><code>SELECT .....FOR UPDATE</code>在锁定某一行后，其他写操作会被阻塞，直到锁定的行被<code>COMMIT</code>。</p><h2 id=案例结论-1>案例结论
<a class=anchor href=#%e6%a1%88%e4%be%8b%e7%bb%93%e8%ae%ba-1>#</a></h2><p><code>InnoDB</code>存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于<code>MyISAM</code>的表级锁定的。当系统并发量较高的时候，<code>InnoDB</code>的整体性能和<code>MyISAM</code>相比就会有比较明显的优势了。</p><p>但是，<code>InnoDB</code>的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让<code>InnoDB</code>的整体性能表现不仅不能比<code>MyISAM</code>高，甚至可能会更差。</p><h2 id=行锁分析>行锁分析
<a class=anchor href=#%e8%a1%8c%e9%94%81%e5%88%86%e6%9e%90>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; SHOW STATUS LIKE <span style=color:#e6db74>&#39;innodb_row_lock%&#39;</span>;
</span></span><span style=display:flex><span>+-------------------------------+--------+
</span></span><span style=display:flex><span>| Variable_name                 | Value  |
</span></span><span style=display:flex><span>+-------------------------------+--------+
</span></span><span style=display:flex><span>| Innodb_row_lock_current_waits | <span style=color:#ae81ff>0</span>      |
</span></span><span style=display:flex><span>| Innodb_row_lock_time          | <span style=color:#ae81ff>124150</span> |
</span></span><span style=display:flex><span>| Innodb_row_lock_time_avg      | <span style=color:#ae81ff>31037</span>  |
</span></span><span style=display:flex><span>| Innodb_row_lock_time_max      | <span style=color:#ae81ff>51004</span>  |
</span></span><span style=display:flex><span>| Innodb_row_lock_waits         | <span style=color:#ae81ff>4</span>      |
</span></span><span style=display:flex><span>+-------------------------------+--------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>対各个状态量的说明如下：</p><ul><li><code>Innodb_row_lock_current_waits</code>：当前正在等待锁定的数量。</li><li><code>Innodb_row_lock_time</code>：从系统启动到现在锁定总时间长度（重要）。</li><li><code>Innodb_row_lock_time_avg</code>：每次等待所花的平均时间（重要）。</li><li><code>Innodb_row_lock_time_max</code>：从系统启动到现在等待最长的一次所花的时间。</li><li><code>Innodb_row_lock_waits</code>：系统启动后到现在总共等待的次数（重要）。</li></ul><p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化策略。</p><h1 id=死锁>死锁
<a class=anchor href=#%e6%ad%bb%e9%94%81>#</a></h1><p>InnoDB 实现了以下两种类型的行锁：</p><ul><li><ol><li>共享锁（S）：允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。</li></ol></li><li><ol start=2><li>排他锁（X）：允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享读锁和排他写锁。</li></ol></li></ul><p>为了允许行锁和表锁共存，实现多粒度锁机制，InnoDB 还有两种内部使用的意向锁（Intention Locks），这两种意向锁都是表锁：</p><ul><li><ol start=3><li>意向共享锁（IS）：事务打算给数据行加行共享锁，事务在给一个数据行加共享锁前必须先取得该表的 IS 锁。</li></ol></li><li><ol start=4><li>意向排他锁（IX）：事务打算给数据行加行排他锁，事务在给一个数据行加排他锁前必须先取得该表的 IX 锁。</li></ol></li></ul><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20201204193446.png alt=20201204193446></p><blockquote><blockquote><p>（如果一个事务请求的锁模式与当前的锁兼容， InnoDB 就将请求的锁授予该事务； 反之， 如果两者不兼容，该事务就要等待锁释放。）</p></blockquote></blockquote><ul><li>InnoDB加锁方法：<ul><li>对于普通<code>SELECT</code>语句，InnoDB 不会加<strong>任何锁</strong>；</li><li>对于 <code>UPDATE、 DELETE 和 INSERT</code> 语句， InnoDB会自动给涉及数据集加<strong>排他锁（X)</strong>；</li><li>事务可以通过以下语句显式给记录集加共享锁或排他锁：<ul><li>共享锁（S）：<code>SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE</code>。 其他 session 仍然可以查询记录，并也可以对该记录加 share mode 的共享锁。但是如果当前事务需要对该记录进行更新操作，则很有可能造成死锁。</li><li>排他锁（X)：<code>SELECT * FROM table_name WHERE ... FOR UPDATE</code>。其他 session 可以查询该记录，但是不能对该记录加共享锁或排他锁，而是等待获得锁</li></ul></li><li><del>意向锁是 InnoDB 自动加的， 不需用户干预。</del></li></ul></li></ul><blockquote><p>死锁有三种情况</p><blockquote><ul><li>第一种情况，用户1访问表A(锁住A表)，然后访问表B，用户2，访问表B(锁住B),然后访问表A,这样用户1等待用户2释放表B上的锁，用户2等待用户1释放表A上的锁！</li></ul><blockquote><blockquote><p>解决方法：
主要由于逻辑程序bug产生，在事务的执行顺序上，如果有多个资源，保证代码执行资源顺序的一致性，比如事务A和事务B都是更新A表后然后执行B表，那么都按这个顺序执行，如操作A和B两张表时，总是按先A后B的顺序处理， 必须同时锁定两个资源时，要保证在任何时刻都应该按照相同的顺序来锁定资源。</p></blockquote></blockquote></blockquote></blockquote><blockquote><blockquote><ul><li>第二种情况，事务a查询一条记录，然后准备更新这条记录，事务b进行同样的操作，但由于速度过快，事务a没来来得及commit,那么事务a查询获得这条记录的共享锁，并且事务a准备更新获得排他锁，此时b同样获得该条记录的共享锁，事务a等待事务b释放锁，进行更新，同样事务b等待事务a执行完进行更新，产生死锁！场景如下，如果一个按钮没有失效设置，用户一直点，就会出现上述情况
<img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20201204185457.png alt=20201204185457></li></ul><blockquote><blockquote><p>解决方法：</p></blockquote><ol><li>按钮点击置灰</li><li>使用悲观锁，select for update  在查询的时候就加排他锁，那么事务b就不能进行查询获得共享锁</li><li>使用乐观锁，在每条数据加版本号version字段，对所读操作的数据都不加锁，事务a和事务b第一部查出相应的版本号v，在更新前在把提交数据与数据库版本比较，例如，update set where (v+1)>version,如果不大于认为过期就不进行更新了</li></ol></blockquote></blockquote></blockquote><blockquote><blockquote><ul><li>第三种情况，如果使用一条update不满足条件的sql语句，那么行锁变成了表锁，</li></ul><blockquote><p>比如索引失效情况，用了<code>is null</code>或者<code>type</code>建立索引或者使用了<code>like %</code>，或者的话<code>where</code>条件里面没有使用索引，那么就变成了全表扫描，update 语句也变成了表锁，那么这样的事务过多，造成死锁或阻塞！</p></blockquote></blockquote></blockquote><p><a href=https://zhuanlan.zhihu.com/p/29150809>InnoDB加锁方法</a></p><h1 id=数据一致性>数据一致性
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7>#</a></h1><blockquote><p>假设有A、B两个用户同时各购买一件 id=1 的商品，用户A获取到的库存量为 1000，用户B获取到的库存量也为 1000，用户A完成购买后修改该商品的库存量为 999，用户B完成购买后修改该商品的库存量为 999，此时库存量数据产生了不一致。</p></blockquote><blockquote><blockquote><p>有两种解决方案：</p><blockquote><p>悲观锁方案：每次获取商品时，对该商品加排他锁。也就是在用户A获取获取 id=1 的商品信息时对该行记录加锁，期间其他用户阻塞等待访问该记录。悲观锁适合写入频繁的场景。</p></blockquote></blockquote></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>begin</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> goods <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>update</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>update</span> goods <span style=color:#66d9ef>set</span> stock <span style=color:#f92672>=</span> stock <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>commit</span>;
</span></span></code></pre></div><blockquote><blockquote><blockquote><p>乐观锁方案：每次获取商品时，不对该商品加锁。在更新数据的时候需要比较程序中的库存量与数据库中的库存量是否相等，如果相等则进行更新，反之程序重新获取库存量，再次进行比较，直到两个库存量的数值相等才进行数据更新。乐观锁适合读取频繁的场景。</p></blockquote></blockquote></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>不加锁获取</span> id<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#960050;background-color:#1e0010>的商品对象</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> goods <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>begin</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>更新</span> stock <span style=color:#960050;background-color:#1e0010>值，这里需要注意</span> <span style=color:#66d9ef>where</span> <span style=color:#960050;background-color:#1e0010>条件</span> <span style=color:#960050;background-color:#1e0010>“</span>stock <span style=color:#f92672>=</span> cur_stock<span style=color:#960050;background-color:#1e0010>”，只有程序中获取到的库存量与数据库中的库存量相等才执行更新</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>update</span> goods <span style=color:#66d9ef>set</span> stock <span style=color:#f92672>=</span> stock <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>and</span> stock <span style=color:#f92672>=</span> cur_stock;
</span></span><span style=display:flex><span><span style=color:#66d9ef>commit</span>;
</span></span></code></pre></div><blockquote><p>如果我们需要设计一个商城系统，该选择以上的哪种方案呢？</p><blockquote><p>查询商品的频率比下单支付的频次高，基于以上我可能会优先考虑第二种方案（当然还有其他的方案，这里只考虑以上两种方案）。</p></blockquote></blockquote><p>但是第二种的话，要注意下它的先开始查询，然后开始事物，可能事物里面有许多的其他查询耗时。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#表锁偏读>表锁(偏读)</a><ul><li><a href=#环境准备>环境准备</a></li><li><a href=#锁表的命令>锁表的命令</a></li><li><a href=#读锁案例>读锁案例</a></li><li><a href=#写锁案例>写锁案例</a></li><li><a href=#案例结论>案例结论</a></li><li><a href=#表锁分析>表锁分析</a></li></ul></li><li><a href=#行锁偏写>行锁(偏写)</a><ul><li><a href=#环境准备-1>环境准备</a></li><li><a href=#行锁案例>行锁案例</a></li><li><a href=#索引失效行锁变表锁>索引失效行锁变表锁</a></li><li><a href=#间隙锁的危害>间隙锁的危害</a></li><li><a href=#如何锁定一行>如何锁定一行</a></li><li><a href=#案例结论-1>案例结论</a></li><li><a href=#行锁分析>行锁分析</a></li></ul></li><li><a href=#死锁>死锁</a></li><li><a href=#数据一致性>数据一致性</a></li></ul></nav></div></aside></main></body></html>