<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="mysql知识思维分类,浅入浅出"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="索引"><meta property="og:description" content="mysql知识思维分类,浅入浅出"><meta property="og:type" content="article"><meta property="og:url" content="https://zput.github.io/middleware/docs/mysql/business_facing/innodb_index/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-01-24T10:33:00+00:00"><meta property="article:modified_time" content="2020-01-24T10:33:00+00:00"><title>索引 | 常用中间件分析</title><link rel=manifest href=/middleware/manifest.json><link rel=icon href=/middleware/favicon.png type=image/x-icon><link rel=stylesheet href=/middleware/book.min.76f6dbe75c94e688c018dd8b54e7f880916b14ab4cf3881b81f75d6bb916603c.css integrity="sha256-dvbb51yU5ojAGN2LVOf4gJFrFKtM84gbgfdda7kWYDw=" crossorigin=anonymous><script defer src=/middleware/flexsearch.min.js></script>
<script defer src=/middleware/en.search.min.31150800969b9bd8dffb5ce66949a704f91d058d1025f8b51a41ac48e40a77df.js integrity="sha256-MRUIAJabm9jf+1zmaUmnBPkdBY0QJfi1GkGsSOQKd98=" crossorigin=anonymous></script>
<script defer src=/middleware/sw.min.f609352e1b128d348128bfdb614a37fe64cd10a16425cbece15ecafa5115c45a.js integrity="sha256-9gk1LhsSjTSBKL/bYUo3/mTNEKFkJcvs4V7K+lEVxFo=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/middleware/><span>常用中间件分析</span></a></h2><div class=magic><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64><div class="book-search-spinner spinner hidden"></div><ul id=book-search-results></ul></div><div class=book-switch><label class=switch><input id=dark-mode-checkbox type=checkbox onchange=darkmode()>
<span class=slider></span></label></div></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>Zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><hr><ul><li><span>Mysql</span><ul><li><a href=/middleware/docs/mysql/init/>开始篇</a><ul><li><a href=/middleware/docs/mysql/init/install/>初始化</a></li></ul></li><li><a href=/middleware/docs/mysql/business_facing/>面向业务篇</a><ul><li><a href=/middleware/docs/mysql/business_facing/sql/>写好sql</a></li><li><a href=/middleware/docs/mysql/business_facing/innodb_index/ class=active>索引</a></li><li><a href=/middleware/docs/mysql/business_facing/innodb_lock/>锁</a></li></ul></li><li><span>高级篇</span><ul><li><a href=/middleware/docs/mysql/advanced/page_lock_log/>底层结构</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script><script src=/middleware/magic.js></script>
<script src=/middleware/dark.js></script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/middleware/svg/menu.svg class=book-icon alt=Menu></label>
<strong>索引</strong>
<label for=toc-control><img src=/middleware/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#索引>索引</a><ul><li><a href=#索引简介>索引简介</a></li><li><a href=#索引分类>索引分类</a></li><li><a href=#索引数据结构>索引数据结构</a></li><li><a href=#哪些情况需要建索引>哪些情况需要建索引</a></li><li><a href=#那些情况不要建索引>那些情况不要建索引</a></li></ul></li><li><a href=#索引分析>索引分析</a><ul><li><a href=#单表索引分析--范围之后的索引会失效>单表索引分析&ndash;>范围之后的索引会失效</a><ul><li></li></ul></li><li><a href=#两表索引分析---左连接将索引创建在右表上更合适>两表索引分析&mdash;>左连接将索引创建在右表上更合适</a><ul><li></li></ul></li><li><a href=#三张表索引分析>三张表索引分析</a><ul><li></li></ul></li><li><a href=#结论>结论</a></li></ul></li><li><a href=#索引失效>索引失效</a><ul><li><a href=#索引失效的情况>索引失效的情况</a></li><li><a href=#最佳左前缀法则>最佳左前缀法则</a></li><li><a href=#索引列上不计算>索引列上不计算</a></li><li><a href=#范围之后全失效>范围之后全失效</a></li><li><a href=#覆盖索引尽量用>覆盖索引尽量用</a></li><li><a href=#不等有时会失效>不等有时会失效</a></li><li><a href=#like百分加右边>like百分加右边</a></li><li><a href=#字符要加单引号>字符要加单引号</a></li><li><a href=#索引相关题目>索引相关题目</a></li><li><a href=#面试题分析>面试题分析</a></li><li><a href=#总结>总结</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=索引>索引
<a class=anchor href=#%e7%b4%a2%e5%bc%95>#</a></h1><h2 id=索引简介>索引简介
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e7%ae%80%e4%bb%8b>#</a></h2><blockquote><p>索引是什么？</p></blockquote><p><a href=https://www.tutorialspoint.com/mysql/mysql-indexes.htm>A database index is a data structure that improves the speed of operations in a table</a>
MySQL官方对索引的定义为：<strong>索引（INDEX）是帮助MySQL对表高效操作的数据结构。</strong></p><p>从而可以获得索引的本质：<strong>索引是排好序的快速查找<code>数据结构</code>。</strong></p><p>索引的目的在于提高查询效率，可以类比字典的目录。如果要查<code>mysql</code>这个这个单词，我们肯定要先定位到<code>m</code>字母，然后从上往下找<code>y</code>字母，再找剩下的<code>sql</code>。如果没有索引，那么可能需要<code>a---z</code>，这样全字典扫描，如果我想找<code>Java</code>开头的单词呢？如果我想找<code>Oracle</code>开头的单词呢？？？</p><p><strong>重点：索引会影响到MySQL查找(WHERE的查询条件)和排序(ORDER BY)两大功能！</strong></p><p><strong>除了数据本身之外，数据库还维护着一个满足特定查找算法的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现高级查找算法，这种数据结构就是索引。</strong></p><p>一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Linux下查看磁盘空间命令 df -h </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@Ringo ~<span style=color:#f92672>]</span><span style=color:#75715e># df -h</span>
</span></span><span style=display:flex><span>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span style=display:flex><span>/dev/vda1        40G   16G   23G  41% /
</span></span><span style=display:flex><span>devtmpfs        911M     <span style=color:#ae81ff>0</span>  911M   0% /dev
</span></span><span style=display:flex><span>tmpfs           920M     <span style=color:#ae81ff>0</span>  920M   0% /dev/shm
</span></span><span style=display:flex><span>tmpfs           920M  480K  920M   1% /run
</span></span><span style=display:flex><span>tmpfs           920M     <span style=color:#ae81ff>0</span>  920M   0% /sys/fs/cgroup
</span></span><span style=display:flex><span>overlay          40G   16G   23G  41% 
</span></span></code></pre></div><p>我们平时所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种数据结构的索引之外，还有哈希索引（Hash Index）等。</p><blockquote><p>索引的优势和劣势</p></blockquote><p>优势：</p><ul><li>查找：类似大学图书馆的书目索引，提高数据检索的效率，降低数据库的IO成本。</li><li>排序：通过索引対数据进行排序，降低数据排序的成本，降低了CPU的消耗。</li></ul><p>劣势：</p><ul><li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要占用空间的。</li><li>虽然索引大大提高了查询速度，但是同时会降低表的更新速度，例如对表频繁的进行<code>INSERT</code>、<code>UPDATE</code>和<code>DELETE</code>。因为更新表的时候，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加的索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</li><li>索引只是提高效率的一个因素，如果MySQL有大数据量的表，就需要花时间研究建立最优秀的索引。</li></ul><h2 id=索引分类>索引分类
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e5%88%86%e7%b1%bb>#</a></h2><p>索引分类：</p><ul><li>单值索引：一个索引只包含单个列，一个表可以有多个单列索引。</li><li>唯一索引：索引列的值必须唯一，但是允许<strong>空值</strong>。</li><li>复合索引：一个索引包含多个字段。</li></ul><p><strong>建议：一张表建的索引最好不要超过5个！</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 基本语法 */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 1、创建索引 [UNIQUE]可以省略*/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 如果只写一个字段就是单值索引，写多个字段就是复合索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> [<span style=color:#66d9ef>UNIQUE</span>] <span style=color:#66d9ef>INDEX</span> indexName <span style=color:#66d9ef>ON</span> tabName(columnName(<span style=color:#66d9ef>length</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 2、删除索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>INDEX</span> [indexName] <span style=color:#66d9ef>ON</span> tabName;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 3、查看索引 */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 加上\G就可以以列的形式查看了 不加\G就是以表的形式查看 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>FROM</span> tabName <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>;
</span></span></code></pre></div><p>使用<code>ALTER</code>命令来为数据表添加索引</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 1、该语句添加一个主键，这意味着索引值必须是唯一的，并且不能为NULL */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> tabName <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>(column_list);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 2、该语句创建索引的键值必须是唯一的(除了NULL之外，NULL可能会出现多次) */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> tabName <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>UNIQUE</span> indexName(column_list);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 3、该语句创建普通索引，索引值可以出现多次 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> tabName <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>INDEX</span> indexName(column_list);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 4、该语句指定了索引为FULLTEXT，用于全文检索 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> tabName <span style=color:#66d9ef>ADD</span> FULLTEXT indexName(column_list);
</span></span></code></pre></div><h2 id=索引数据结构>索引数据结构
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84>#</a></h2><p>索引数据结构：</p><ul><li><code>BTree</code>索引。</li><li><code>Hash</code>索引。</li><li><code>Full-text</code>全文索引。</li><li><code>R-Tree</code>索引。</li></ul><p><code>BTree</code>索引检索原理：</p><p><img src="https://img-blog.csdnimg.cn/20200801233134931.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt=BTree></p><h2 id=哪些情况需要建索引>哪些情况需要建索引
<a class=anchor href=#%e5%93%aa%e4%ba%9b%e6%83%85%e5%86%b5%e9%9c%80%e8%a6%81%e5%bb%ba%e7%b4%a2%e5%bc%95>#</a></h2><ul><li>主键:主键自动建立主键索引（唯一 + 非空）。</li><li>where/order by:<ul><li>频繁作为查询条件的字段应该创建索引。</li><li>查询中统计或者分组字段（group by也和索引有关）。</li><li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度。</li></ul></li><li>查询中与其他表关联的字段，<strong>外键关系</strong>建立索引。</li></ul><h2 id=那些情况不要建索引>那些情况不要建索引
<a class=anchor href=#%e9%82%a3%e4%ba%9b%e6%83%85%e5%86%b5%e4%b8%8d%e8%a6%81%e5%bb%ba%e7%b4%a2%e5%bc%95>#</a></h2><ul><li>记录太少的表。</li><li>经常增删改的表。</li><li>频繁更新的字段不适合创建索引。</li><li>Where条件里用不到的字段不创建索引。<ul><li>假如一个表有10万行记录，有一个字段A只有true和false两种值，并且每个值的分布概率大约为50%，那么对A字段建索引一般不会提高数据库的查询速度。索引的选择性是指索引列中不同值的数目与表中记录数的比。如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980/2000=0.99。一个索引的选择性越接近于1，这个索引的效率就越高。</li></ul></li></ul><h1 id=索引分析>索引分析
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e5%88%86%e6%9e%90>#</a></h1><h2 id=单表索引分析--范围之后的索引会失效>单表索引分析&ndash;>范围之后的索引会失效
<a class=anchor href=#%e5%8d%95%e8%a1%a8%e7%b4%a2%e5%bc%95%e5%88%86%e6%9e%90--%e8%8c%83%e5%9b%b4%e4%b9%8b%e5%90%8e%e7%9a%84%e7%b4%a2%e5%bc%95%e4%bc%9a%e5%a4%b1%e6%95%88>#</a></h2><h4 id=数据准备>数据准备
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>article<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>article<span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;作者id&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>category_id<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;分类id&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>views<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;被查看的次数&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>comments<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;回帖的备注&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>title<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;标题&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>content<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;正文内容&#39;</span>
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;文章&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>article<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>category_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>views<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>comments<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>content<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>,<span style=color:#e6db74>&#39;1&#39;</span>,<span style=color:#e6db74>&#39;1&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>article<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>category_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>views<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>comments<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>content<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>2</span>,<span style=color:#e6db74>&#39;2&#39;</span>,<span style=color:#e6db74>&#39;2&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>article<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>category_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>views<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>comments<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>content<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>3</span>,<span style=color:#e6db74>&#39;3&#39;</span>,<span style=color:#e6db74>&#39;3&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>article<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>category_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>views<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>comments<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>content<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>3</span>,<span style=color:#e6db74>&#39;3&#39;</span>,<span style=color:#e6db74>&#39;3&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>article<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>author_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>category_id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>views<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>comments<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>content<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>4</span>,<span style=color:#e6db74>&#39;4&#39;</span>,<span style=color:#e6db74>&#39;4&#39;</span>);
</span></span></code></pre></div><blockquote><p>案例：查询<code>category_id</code>为1且<code>comments</code>大于1的情况下，<code>views</code>最多的<code>article_id</code>。</p></blockquote><h4 id=编写sql语句并查看sql执行计划>编写SQL语句并查看SQL执行计划。
<a class=anchor href=#%e7%bc%96%e5%86%99sql%e8%af%ad%e5%8f%a5%e5%b9%b6%e6%9f%a5%e7%9c%8bsql%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 1、sql语句</span>
</span></span><span style=display:flex><span>SELECT id,author_id FROM article WHERE category_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> AND comments &gt; <span style=color:#ae81ff>1</span> ORDER BY views DESC LIMIT 1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2、sql执行计划</span>
</span></span><span style=display:flex><span>mysql&gt; EXPLAIN SELECT id,author_id FROM article WHERE category_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> AND comments &gt; <span style=color:#ae81ff>1</span> ORDER BY views DESC LIMIT 1<span style=color:#ae81ff>\G</span>
</span></span><span style=display:flex><span>*************************** 1. row ***************************
</span></span><span style=display:flex><span>           id: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  select_type: SIMPLE
</span></span><span style=display:flex><span>        table: article
</span></span><span style=display:flex><span>   partitions: NULL
</span></span><span style=display:flex><span>         type: ALL
</span></span><span style=display:flex><span>possible_keys: NULL
</span></span><span style=display:flex><span>          key: NULL
</span></span><span style=display:flex><span>      key_len: NULL
</span></span><span style=display:flex><span>          ref: NULL
</span></span><span style=display:flex><span>         rows: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>     filtered: 20.00
</span></span><span style=display:flex><span>        Extra: Using where; Using filesort  <span style=color:#75715e># 产生了文件内排序，需要优化SQL</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=创建索引idx_article_ccv>创建索引<code>idx_article_ccv</code>。
<a class=anchor href=#%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95idx_article_ccv>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_article_ccv <span style=color:#66d9ef>ON</span> article(category_id,comments,views);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; show index from article;
</span></span><span style=display:flex><span>+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span><span style=display:flex><span>| Table   | Non_unique | Key_name        | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
</span></span><span style=display:flex><span>+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span><span style=display:flex><span>| article |          <span style=color:#ae81ff>0</span> | PRIMARY         |            <span style=color:#ae81ff>1</span> | id          | A         |           <span style=color:#ae81ff>5</span> |     NULL | NULL   |      | BTREE      |         |               |
</span></span><span style=display:flex><span>| article |          <span style=color:#ae81ff>1</span> | idx_article_ccv |            <span style=color:#ae81ff>1</span> | category_id | A         |           <span style=color:#ae81ff>3</span> |     NULL | NULL   |      | BTREE      |         |               |
</span></span><span style=display:flex><span>| article |          <span style=color:#ae81ff>1</span> | idx_article_ccv |            <span style=color:#ae81ff>2</span> | comments    | A         |           <span style=color:#ae81ff>5</span> |     NULL | NULL   |      | BTREE      |         |               |
</span></span><span style=display:flex><span>| article |          <span style=color:#ae81ff>1</span> | idx_article_ccv |            <span style=color:#ae81ff>3</span> | views       | A         |           <span style=color:#ae81ff>5</span> |     NULL | NULL   |      | BTREE      |         |               |
</span></span><span style=display:flex><span>+---------+------------+-----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=查看现在sql语句的执行计划>查看现在SQL语句的执行计划。
<a class=anchor href=#%e6%9f%a5%e7%9c%8b%e7%8e%b0%e5%9c%a8sql%e8%af%ad%e5%8f%a5%e7%9a%84%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt;  EXPLAIN SELECT id,author_id FROM article WHERE category_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> AND comments &gt; <span style=color:#ae81ff>1</span> ORDER BY views DESC LIMIT 1;
</span></span><span style=display:flex><span>+----+-------------+---------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+
</span></span><span style=display:flex><span>| id | select_type | table   | partitions | type  | possible_keys   | key             | key_len | ref  | rows | filtered | Extra                                 |
</span></span><span style=display:flex><span>+----+-------------+---------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | article | NULL       | range | idx_article_ccv | idx_article_ccv | <span style=color:#ae81ff>8</span>       | NULL |    <span style=color:#ae81ff>2</span> |   100.00 | Using index condition; Using filesort |
</span></span><span style=display:flex><span>+----+-------------+---------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><blockquote><blockquote><blockquote><p>我们发现，创建符合索引<code>idx_article_ccv</code>之后，虽然解决了全表扫描的问题，但是在<code>order by</code>排序的时候没有用到索引，MySQL居然还是用的<code>Using filesort</code>，为什么？</p></blockquote></blockquote></blockquote><h4 id=我们试试把sql修改为select-idauthor_id-from-article-where-category_id--1-and-comments--1-order-by-views-desc-limit-1看看sql的执行计划>我们试试把SQL修改为<code>SELECT id,author_id FROM article WHERE category_id = 1 AND comments = 1 ORDER BY views DESC LIMIT 1;</code>看看SQL的执行计划。
<a class=anchor href=#%e6%88%91%e4%bb%ac%e8%af%95%e8%af%95%e6%8a%8asql%e4%bf%ae%e6%94%b9%e4%b8%baselect-idauthor_id-from-article-where-category_id--1-and-comments--1-order-by-views-desc-limit-1%e7%9c%8b%e7%9c%8bsql%e7%9a%84%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; EXPLAIN SELECT id,author_id FROM article WHERE category_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> AND comments <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> ORDER BY views DESC LIMIT 1;
</span></span><span style=display:flex><span>+----+-------------+---------+------------+------+-----------------+-----------------+---------+-------------+------+----------+-------------+
</span></span><span style=display:flex><span>| id | select_type | table   | partitions | type | possible_keys   | key             | key_len | ref         | rows | filtered | Extra       |
</span></span><span style=display:flex><span>+----+-------------+---------+------------+------+-----------------+-----------------+---------+-------------+------+----------+-------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | article | NULL       | ref  | idx_article_ccv | idx_article_ccv | <span style=color:#ae81ff>8</span>       | const,const |    <span style=color:#ae81ff>1</span> |   100.00 | Using where |
</span></span><span style=display:flex><span>+----+-------------+---------+------------+------+-----------------+-----------------+---------+-------------+------+----------+-------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><blockquote><blockquote><blockquote><p>推论：当<code>comments > 1</code>的时候<code>order by</code>排序<code>views</code>字段索引就用不上，但是当<code>comments = 1</code>的时候<code>order by</code>排序<code>views</code>字段索引就可以用上！！！<strong>所以，范围之后的索引会失效。</strong></p></blockquote></blockquote></blockquote><h4 id=我们现在知道范围之后的索引会失效原来的索引idx_article_ccv最后一个字段views会失效那么我们如果删除这个索引创建idx_article_cv索引呢>我们现在知道<strong>范围之后的索引会失效</strong>，原来的索引<code>idx_article_ccv</code>最后一个字段<code>views</code>会失效，那么我们如果删除这个索引，创建<code>idx_article_cv</code>索引呢？？？？
<a class=anchor href=#%e6%88%91%e4%bb%ac%e7%8e%b0%e5%9c%a8%e7%9f%a5%e9%81%93%e8%8c%83%e5%9b%b4%e4%b9%8b%e5%90%8e%e7%9a%84%e7%b4%a2%e5%bc%95%e4%bc%9a%e5%a4%b1%e6%95%88%e5%8e%9f%e6%9d%a5%e7%9a%84%e7%b4%a2%e5%bc%95idx_article_ccv%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%ad%97%e6%ae%b5views%e4%bc%9a%e5%a4%b1%e6%95%88%e9%82%a3%e4%b9%88%e6%88%91%e4%bb%ac%e5%a6%82%e6%9e%9c%e5%88%a0%e9%99%a4%e8%bf%99%e4%b8%aa%e7%b4%a2%e5%bc%95%e5%88%9b%e5%bb%baidx_article_cv%e7%b4%a2%e5%bc%95%e5%91%a2>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>index</span> idx_article_ccv <span style=color:#66d9ef>on</span> article;
</span></span><span style=display:flex><span><span style=color:#75715e>/* 创建索引 idx_article_cv */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_article_cv <span style=color:#66d9ef>ON</span> article(category_id,views);
</span></span><span style=display:flex><span><span style=color:#66d9ef>show</span> <span style=color:#66d9ef>index</span> <span style=color:#66d9ef>from</span> article;
</span></span></code></pre></div><p>查看当前的索引</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; show index from article;
</span></span><span style=display:flex><span>+---------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span><span style=display:flex><span>| Table   | Non_unique | Key_name       | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
</span></span><span style=display:flex><span>+---------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span><span style=display:flex><span>| article |          <span style=color:#ae81ff>0</span> | PRIMARY        |            <span style=color:#ae81ff>1</span> | id          | A         |           <span style=color:#ae81ff>5</span> |     NULL | NULL   |      | BTREE      |         |               |
</span></span><span style=display:flex><span>| article |          <span style=color:#ae81ff>1</span> | idx_article_cv |            <span style=color:#ae81ff>1</span> | category_id | A         |           <span style=color:#ae81ff>3</span> |     NULL | NULL   |      | BTREE      |         |               |
</span></span><span style=display:flex><span>| article |          <span style=color:#ae81ff>1</span> | idx_article_cv |            <span style=color:#ae81ff>2</span> | views       | A         |           <span style=color:#ae81ff>5</span> |     NULL | NULL   |      | BTREE      |         |               |
</span></span><span style=display:flex><span>+---------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> rows in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=当前索引是idx_article_cv来看一下sql执行计划>当前索引是<code>idx_article_cv</code>，来看一下SQL执行计划。
<a class=anchor href=#%e5%bd%93%e5%89%8d%e7%b4%a2%e5%bc%95%e6%98%afidx_article_cv%e6%9d%a5%e7%9c%8b%e4%b8%80%e4%b8%8bsql%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; EXPLAIN SELECT id,author_id FROM article WHERE category_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> AND comments &gt; <span style=color:#ae81ff>1</span> ORDER BY views DESC LIMIT 1;
</span></span><span style=display:flex><span>+----+-------------+---------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------+
</span></span><span style=display:flex><span>| id | select_type | table   | partitions | type  | possible_keys  | key            | key_len | ref  | rows | filtered | Extra                              |
</span></span><span style=display:flex><span>+----+-------------+---------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | article | NULL       | range | idx_article_cv | idx_article_cv | <span style=color:#ae81ff>4</span>       | NULL |    <span style=color:#ae81ff>3</span> |    33.33 | Using index condition; Using where |
</span></span><span style=display:flex><span>+----+-------------+---------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=两表索引分析---左连接将索引创建在右表上更合适>两表索引分析&mdash;>左连接将索引创建在右表上更合适
<a class=anchor href=#%e4%b8%a4%e8%a1%a8%e7%b4%a2%e5%bc%95%e5%88%86%e6%9e%90---%e5%b7%a6%e8%bf%9e%e6%8e%a5%e5%b0%86%e7%b4%a2%e5%bc%95%e5%88%9b%e5%bb%ba%e5%9c%a8%e5%8f%b3%e8%a1%a8%e4%b8%8a%e6%9b%b4%e5%90%88%e9%80%82>#</a></h2><h4 id=数据准备-1>数据准备
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87-1>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span><span style=color:#66d9ef>class</span><span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>book<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span><span style=color:#66d9ef>class</span><span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>card<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;分类&#39;</span> 
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;商品类别&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>book<span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>bookid<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>card<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;分类&#39;</span>
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;书籍&#39;</span>;
</span></span></code></pre></div><blockquote><p>两表连接查询的SQL执行计划</p></blockquote><p>1、不创建索引的情况下，SQL的执行计划。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; EXPLAIN <span style=color:#66d9ef>select</span> * from book left join class on book.card <span style=color:#f92672>=</span> class.card;
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span>| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    <span style=color:#ae81ff>1</span> |   100.00 | NULL                                               |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    <span style=color:#ae81ff>1</span> |   100.00 | Using where; Using join buffer <span style=color:#f92672>(</span>Block Nested Loop<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> rows in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><blockquote><blockquote><blockquote><p><code>book</code>和<code>class</code>两张表都是没有使用索引，全表扫描，那么如果进行优化，索引是创建在<code>book</code>表还是创建在<code>class</code>表呢？下面进行大胆的尝试！</p></blockquote></blockquote></blockquote><h4 id=左表book表创建索引>左表(<code>book</code>表)创建索引。
<a class=anchor href=#%e5%b7%a6%e8%a1%a8book%e8%a1%a8%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95>#</a></h4><p>创建索引<code>idx_book_card</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 在book表创建索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_book_card <span style=color:#66d9ef>ON</span> book(card);
</span></span></code></pre></div><p>在<code>book</code>表中有<code>idx_book_card</code>索引的情况下，查看SQL执行计划</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; EXPLAIN <span style=color:#66d9ef>select</span> * from book left join class on book.card <span style=color:#f92672>=</span> class.card;
</span></span><span style=display:flex><span>+----+-------------+-------+------------+-------+---------------+---------------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span>| id | select_type | table | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                                              |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+-------+---------------+---------------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | book  | NULL       | index | NULL          | idx_book_card | <span style=color:#ae81ff>4</span>       | NULL |    <span style=color:#ae81ff>1</span> |   100.00 | Using index                                        |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | class | NULL       | ALL   | NULL          | NULL          | NULL    | NULL |    <span style=color:#ae81ff>1</span> |   100.00 | Using where; Using join buffer <span style=color:#f92672>(</span>Block Nested Loop<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+-------+---------------+---------------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> rows in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=删除book表的索引右表class表创建索引>删除<code>book</code>表的索引，右表(<code>class</code>表)创建索引。
<a class=anchor href=#%e5%88%a0%e9%99%a4book%e8%a1%a8%e7%9a%84%e7%b4%a2%e5%bc%95%e5%8f%b3%e8%a1%a8class%e8%a1%a8%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95>#</a></h4><p>创建索引<code>idx_class_card</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>index</span> idx_book_card <span style=color:#66d9ef>on</span> book;
</span></span><span style=display:flex><span><span style=color:#75715e>/* 在class表创建索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_class_card <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>class</span>(card);
</span></span></code></pre></div><p>在<code>class</code>表中有<code>idx_class_card</code>索引的情况下，查看SQL执行计划</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; EXPLAIN <span style=color:#66d9ef>select</span> * from book left join class on book.card <span style=color:#f92672>=</span> class.card;
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+----------------+----------------+---------+--------------------+------+----------+-------------+
</span></span><span style=display:flex><span>| id | select_type | table | partitions | type | possible_keys  | key            | key_len | ref                | rows | filtered | Extra       |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+----------------+----------------+---------+--------------------+------+----------+-------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | book  | NULL       | ALL  | NULL           | NULL           | NULL    | NULL               |    <span style=color:#ae81ff>1</span> |   100.00 | NULL        |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | class | NULL       | ref  | idx_class_card | idx_class_card | <span style=color:#ae81ff>4</span>       | zxc_test.book.card |    <span style=color:#ae81ff>1</span> |   100.00 | Using index |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+----------------+----------------+---------+--------------------+------+----------+-------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> rows in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><p><strong>由此可见，左连接将索引创建在右表上更合适，右连接将索引创建在左表上更合适。</strong></p><h2 id=三张表索引分析>三张表索引分析
<a class=anchor href=#%e4%b8%89%e5%bc%a0%e8%a1%a8%e7%b4%a2%e5%bc%95%e5%88%86%e6%9e%90>#</a></h2><h4 id=数据准备-2>数据准备
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87-2>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>phone<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>phone<span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>phone_id<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>card<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) UNSIGNED <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;分类&#39;</span> 
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;手机&#39;</span>;
</span></span></code></pre></div><blockquote><p>三表连接查询SQL优化</p></blockquote><h4 id=不加任何索引查看sql执行计划>不加任何索引，查看SQL执行计划。
<a class=anchor href=#%e4%b8%8d%e5%8a%a0%e4%bb%bb%e4%bd%95%e7%b4%a2%e5%bc%95%e6%9f%a5%e7%9c%8bsql%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; EXPLAIN <span style=color:#66d9ef>select</span> * from class left join book on class.card <span style=color:#f92672>=</span> book.card left join phone on book.card <span style=color:#f92672>=</span> phone.card;
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span>| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    <span style=color:#ae81ff>1</span> |   100.00 | NULL                                               |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    <span style=color:#ae81ff>1</span> |   100.00 | Using where; Using join buffer <span style=color:#f92672>(</span>Block Nested Loop<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | phone | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    <span style=color:#ae81ff>1</span> |   100.00 | Using where; Using join buffer <span style=color:#f92672>(</span>Block Nested Loop<span style=color:#f92672>)</span> |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> rows in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=根据两表查询优化的经验左连接需要在右表上添加索引所以尝试在book表和phone表上添加索引>根据两表查询优化的经验，左连接需要在右表上添加索引，所以尝试在<code>book</code>表和<code>phone</code>表上添加索引。
<a class=anchor href=#%e6%a0%b9%e6%8d%ae%e4%b8%a4%e8%a1%a8%e6%9f%a5%e8%af%a2%e4%bc%98%e5%8c%96%e7%9a%84%e7%bb%8f%e9%aa%8c%e5%b7%a6%e8%bf%9e%e6%8e%a5%e9%9c%80%e8%a6%81%e5%9c%a8%e5%8f%b3%e8%a1%a8%e4%b8%8a%e6%b7%bb%e5%8a%a0%e7%b4%a2%e5%bc%95%e6%89%80%e4%bb%a5%e5%b0%9d%e8%af%95%e5%9c%a8book%e8%a1%a8%e5%92%8cphone%e8%a1%a8%e4%b8%8a%e6%b7%bb%e5%8a%a0%e7%b4%a2%e5%bc%95>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 在book表创建索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_book_card <span style=color:#66d9ef>ON</span> book(card);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 在phone表上创建索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_phone_card <span style=color:#66d9ef>ON</span> phone(card);
</span></span></code></pre></div><blockquote><blockquote><blockquote><p>再次执行SQL的执行计划</p></blockquote></blockquote></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ysql&gt; /* book */
</span></span><span style=display:flex><span>mysql&gt; CREATE INDEX idx_book_card ON book<span style=color:#f92672>(</span>card<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> rows affected <span style=color:#f92672>(</span>0.01 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Records: <span style=color:#ae81ff>0</span>  Duplicates: <span style=color:#ae81ff>0</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql&gt;
</span></span><span style=display:flex><span>mysql&gt; /* phone */
</span></span><span style=display:flex><span>mysql&gt; CREATE INDEX idx_phone_card ON phone<span style=color:#f92672>(</span>card<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>0</span> rows affected <span style=color:#f92672>(</span>0.01 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Records: <span style=color:#ae81ff>0</span>  Duplicates: <span style=color:#ae81ff>0</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql&gt;
</span></span><span style=display:flex><span>mysql&gt;
</span></span><span style=display:flex><span>mysql&gt; EXPLAIN <span style=color:#66d9ef>select</span> * from class left join book on class.card <span style=color:#f92672>=</span> book.card left join phone on book.card <span style=color:#f92672>=</span> phone.card;
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+----------------+----------------+---------+---------------------+------+----------+-------------+
</span></span><span style=display:flex><span>| id | select_type | table | partitions | type | possible_keys  | key            | key_len | ref                 | rows | filtered | Extra       |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+----------------+----------------+---------+---------------------+------+----------+-------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | class | NULL       | ALL  | NULL           | NULL           | NULL    | NULL                |    <span style=color:#ae81ff>1</span> |   100.00 | NULL        |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | book  | NULL       | ref  | idx_book_card  | idx_book_card  | <span style=color:#ae81ff>4</span>       | zxc_test.class.card |    <span style=color:#ae81ff>1</span> |   100.00 | Using index |
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | SIMPLE      | phone | NULL       | ref  | idx_phone_card | idx_phone_card | <span style=color:#ae81ff>4</span>       | zxc_test.book.card  |    <span style=color:#ae81ff>1</span> |   100.00 | Using index |
</span></span><span style=display:flex><span>+----+-------------+-------+------------+------+----------------+----------------+---------+---------------------+------+----------+-------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> rows in set, <span style=color:#ae81ff>1</span> warning <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=结论>结论
<a class=anchor href=#%e7%bb%93%e8%ae%ba>#</a></h2><p><code>JOIN</code>语句的优化：</p><ul><li>尽可能减少<code>JOIN</code>语句中的<code>NestedLoop</code>（嵌套循环）的总次数：<strong>永远都是小的结果集驱动大的结果集</strong>。</li><li>优先优化<code>NestedLoop</code>的内层循环。</li><li>保证<code>JOIN</code>语句中被驱动表上<code>JOIN</code>条件字段已经被索引。</li><li>当无法保证被驱动表的<code>JOIN</code>条件字段被索引且内存资源充足的前提下，不要太吝惜<code>Join Buffer</code> 的设置。</li></ul><h1 id=索引失效>索引失效
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88>#</a></h1><blockquote><p>数据准备</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>24</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;姓名&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> INT(<span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;年龄&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;职位&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>add_time<span style=color:#f92672>`</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CURRENT_TIMESTAMP</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;入职时间&#39;</span>
</span></span><span style=display:flex><span>)<span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;员工记录表&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;Ringo&#39;</span>, <span style=color:#ae81ff>18</span>, <span style=color:#e6db74>&#39;manager&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;张三&#39;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#e6db74>&#39;dev&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;李四&#39;</span>, <span style=color:#ae81ff>21</span>, <span style=color:#e6db74>&#39;dev&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 创建索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_staffs_name_age_pos <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span>);
</span></span></code></pre></div><h2 id=索引失效的情况>索引失效的情况
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88%e7%9a%84%e6%83%85%e5%86%b5>#</a></h2><ul><li>全值匹配我最爱。</li><li>最佳左前缀法则。</li><li>不在<strong>索引列</strong>上做任何操作（计算、函数、(自动or手动)类型转换），会导致索引失效而转向全表扫描。</li><li>索引中<strong>范围条件</strong>右边的字段会全部失效。</li><li>尽量使用覆盖索引（只访问索引的查询，索引列和查询列一致），减少<code>SELECT *</code>。</li><li>MySQL在使用<code>!=</code>或者<code>&lt;></code>的时候无法使用索引会导致全表扫描。</li><li><code>is null</code>、<code>is not null</code>也无法使用索引。</li><li><code>like</code>以通配符开头<code>%abc</code>索引失效会变成全表扫描。</li><li>字符串不加单引号索引失效。</li><li>少用<code>or</code>，用它来连接时会索引失效。</li></ul><h2 id=最佳左前缀法则>最佳左前缀法则
<a class=anchor href=#%e6%9c%80%e4%bd%b3%e5%b7%a6%e5%89%8d%e7%bc%80%e6%b3%95%e5%88%99>#</a></h2><blockquote><p>案例</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 用到了idx_staffs_name_age_pos索引中的name字段 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 用到了idx_staffs_name_age_pos索引中的name, age字段 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;manager&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 索引没用上，ALL全表扫描 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;manager&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 索引没用上，ALL全表扫描 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;manager&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 用到了idx_staffs_name_age_pos索引中的name字段，pos字段索引失效 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;manager&#39;</span>;
</span></span></code></pre></div><blockquote><p>概念</p></blockquote><p><strong>最佳左前缀法则：如果索引是多字段的复合索引，要遵守最佳左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的字段。</strong></p><p><strong>口诀：带头大哥不能死，中间兄弟不能断。</strong></p><h2 id=索引列上不计算>索引列上不计算
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e5%88%97%e4%b8%8a%e4%b8%8d%e8%ae%a1%e7%ae%97>#</a></h2><blockquote><p>案例</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 现在要查询`name` = &#39;Ringo&#39;的记录下面有两种方式来查询！</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1、直接使用 字段 = 值的方式来计算</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>staffs<span style=color:#e6db74>`</span> WHERE <span style=color:#e6db74>`</span>name<span style=color:#e6db74>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span>;
</span></span><span style=display:flex><span>+----+-------+-----+---------+---------------------+
</span></span><span style=display:flex><span>| id | name  | age | pos     | add_time            |
</span></span><span style=display:flex><span>+----+-------+-----+---------+---------------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | Ringo |  <span style=color:#ae81ff>18</span> | manager | 2020-08-03 08:30:39 |
</span></span><span style=display:flex><span>+----+-------+-----+---------+---------------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2、使用MySQL内置的函数</span>
</span></span><span style=display:flex><span>mysql&gt; SELECT * FROM <span style=color:#e6db74>`</span>staffs<span style=color:#e6db74>`</span> WHERE LEFT<span style=color:#f92672>(</span><span style=color:#e6db74>`</span>name<span style=color:#e6db74>`</span>, 5<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span>;
</span></span><span style=display:flex><span>+----+-------+-----+---------+---------------------+
</span></span><span style=display:flex><span>| id | name  | age | pos     | add_time            |
</span></span><span style=display:flex><span>+----+-------+-----+---------+---------------------+
</span></span><span style=display:flex><span>|  <span style=color:#ae81ff>1</span> | Ringo |  <span style=color:#ae81ff>18</span> | manager | 2020-08-03 08:30:39 |
</span></span><span style=display:flex><span>+----+-------+-----+---------+---------------------+
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>我们发现以上两条SQL的执行结果都是一样的，但是执行效率有没有差距呢？？？</p><p>通过分析两条SQL的执行计划来分析性能。</p><p><img src="https://img-blog.csdnimg.cn/20200803171857325.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt=explain></p><p><strong>由此可见，在索引列上进行计算，会使索引失效。</strong></p><p><strong>口诀：索引列上不计算。</strong></p><h2 id=范围之后全失效>范围之后全失效
<a class=anchor href=#%e8%8c%83%e5%9b%b4%e4%b9%8b%e5%90%8e%e5%85%a8%e5%a4%b1%e6%95%88>#</a></h2><blockquote><p>案例</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;manager&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 用到了idx_staffs_name_age_pos索引中的name，age字段，pos字段索引失效 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;张三&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>18</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;dev&#39;</span>;
</span></span></code></pre></div><p>查看上述SQL的执行计划</p><p><img src="https://img-blog.csdnimg.cn/20200803173357787.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt=explain></p><p><strong>由此可知，查询范围的字段使用到了索引，但是范围<code>之后</code>的索引字段会失效。</strong></p><p><strong>口诀：范围之后全失效。</strong></p><h2 id=覆盖索引尽量用>覆盖索引尽量用
<a class=anchor href=#%e8%a6%86%e7%9b%96%e7%b4%a2%e5%bc%95%e5%b0%bd%e9%87%8f%e7%94%a8>#</a></h2><p>在写SQL的不要使用<code>SELECT *</code>，用什么字段就查询什么字段。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 没有用到覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;manager&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;manager&#39;</span>;
</span></span></code></pre></div><p><img src="https://img-blog.csdnimg.cn/20200803213031893.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt=使用覆盖索引></p><p><strong>口诀：查询一定不用<code>*</code></strong>。</p><h2 id=不等有时会失效>不等有时会失效
<a class=anchor href=#%e4%b8%8d%e7%ad%89%e6%9c%89%e6%97%b6%e4%bc%9a%e5%a4%b1%e6%95%88>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 会使用到覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 索引失效 全表扫描 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span>;
</span></span></code></pre></div><h2 id=like百分加右边>like百分加右边
<a class=anchor href=#like%e7%99%be%e5%88%86%e5%8a%a0%e5%8f%b3%e8%be%b9>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 索引失效 全表扫描 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%ing%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 索引失效 全表扫描 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%ing&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用索引范围查询 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;Rin%&#39;</span>;
</span></span></code></pre></div><p><strong>口诀：<code>like</code>百分加右边。</strong></p><p>如果一定要使用<code>%like</code>，而且还要保证索引不失效，那么使用覆盖索引来编写SQL。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%na&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 索引失效 全表扫描 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>age<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>pos<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>add_time<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%in&#39;</span>;
</span></span></code></pre></div><p><img src=https://img-blog.csdnimg.cn/20200803220743206.png alt=模糊查询百分号一定加前边></p><p><strong>口诀：覆盖索引保两边。</strong></p><h2 id=字符要加单引号>字符要加单引号
<a class=anchor href=#%e5%ad%97%e7%ac%a6%e8%a6%81%e5%8a%a0%e5%8d%95%e5%bc%95%e5%8f%b7>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Ringo&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 使用到了覆盖索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 索引失效 全表扫描 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>staffs<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2000</span>;
</span></span></code></pre></div><p>这里name = 2000在MySQL中会发生强制类型转换，将数字转成字符串。</p><p><strong>口诀：字符要加单引号。</strong></p><h2 id=索引相关题目>索引相关题目
<a class=anchor href=#%e7%b4%a2%e5%bc%95%e7%9b%b8%e5%85%b3%e9%a2%98%e7%9b%ae>#</a></h2><p><strong>假设index(a,b,c)</strong></p><table><thead><tr><th>Where语句</th><th>索引是否被使用</th></tr></thead><tbody><tr><td>where a = 3</td><td>Y，使用到a</td></tr><tr><td>where a = 3 and b = 5</td><td>Y，使用到a，b</td></tr><tr><td>where a = 3 and b = 5</td><td>Y，使用到a，b，c</td></tr><tr><td>where b = 3 或者 where b = 3 and c = 4 或者 where c = 4</td><td>N，没有用到a字段</td></tr><tr><td>where a = 3 and c = 5</td><td>使用到a，但是没有用到c，因为b断了</td></tr><tr><td>where a = 3 and b > 4 and c = 5</td><td>使用到a，b，但是没有用到c，因为c在范围之后</td></tr><tr><td>where a = 3 and b like &lsquo;kk%&rsquo; and c = 4</td><td>Y，a，b，c都用到</td></tr><tr><td>where a = 3 and b like &lsquo;%kk&rsquo; and c = 4</td><td>只用到a</td></tr><tr><td>where a = 3 and b like &lsquo;%kk%&rsquo; and c = 4</td><td>只用到a</td></tr><tr><td>where a = 3 and b like &lsquo;k%kk%&rsquo; and c = 4</td><td>Y，a，b，c都用到</td></tr></tbody></table><h2 id=面试题分析>面试题分析
<a class=anchor href=#%e9%9d%a2%e8%af%95%e9%a2%98%e5%88%86%e6%9e%90>#</a></h2><blockquote><p>数据准备</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 创建表 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span>(
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> INT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> CHAR(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> CHAR(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span> CHAR(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> CHAR(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span> CHAR(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 插入数据 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;a1&#39;</span>,<span style=color:#e6db74>&#39;a2&#39;</span>,<span style=color:#e6db74>&#39;a3&#39;</span>,<span style=color:#e6db74>&#39;a4&#39;</span>,<span style=color:#e6db74>&#39;a5&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;b1&#39;</span>,<span style=color:#e6db74>&#39;b22&#39;</span>,<span style=color:#e6db74>&#39;b3&#39;</span>,<span style=color:#e6db74>&#39;b4&#39;</span>,<span style=color:#e6db74>&#39;b5&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;c1&#39;</span>,<span style=color:#e6db74>&#39;c2&#39;</span>,<span style=color:#e6db74>&#39;c3&#39;</span>,<span style=color:#e6db74>&#39;c4&#39;</span>,<span style=color:#e6db74>&#39;c5&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;d1&#39;</span>,<span style=color:#e6db74>&#39;d2&#39;</span>,<span style=color:#e6db74>&#39;d3&#39;</span>,<span style=color:#e6db74>&#39;d4&#39;</span>,<span style=color:#e6db74>&#39;d5&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span>(<span style=color:#e6db74>&#39;e1&#39;</span>,<span style=color:#e6db74>&#39;e2&#39;</span>,<span style=color:#e6db74>&#39;e3&#39;</span>,<span style=color:#e6db74>&#39;e4&#39;</span>,<span style=color:#e6db74>&#39;e5&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 创建复合索引 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> idx_test03_c1234 <span style=color:#66d9ef>ON</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span>(<span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span>);
</span></span></code></pre></div><blockquote><p>题目</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* 最好索引怎么创建的，就怎么用，按照顺序使用，避免让MySQL再自己去翻译一次 */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 1.全值匹配 用到索引c1 c2 c3 c4全字段 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a3&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a4&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 2.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a4&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a3&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 3.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a4&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a3&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 4.用到索引c1 c2 c3字段，c4字段失效，范围之后全失效 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span> <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;a3&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a4&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 5.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;a4&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a3&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>   6.用到了索引c1 c2 c3三个字段, c1和c2两个字段用于查找,  c3字段用于排序了但是没有统计到key_len中，c4字段失效
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a4&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 7.用到了索引c1 c2 c3三个字段，c1和c2两个字段用于查找, c3字段用于排序了但是没有统计到key_len中*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>   8.用到了索引c1 c2两个字段，c4失效，c1和c2两个字段用于查找，c4字段排序产生了Using filesort说明排序没有用到c4字段 
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 9.用到了索引c1 c2 c3三个字段，c1用于查找，c2和c3用于排序 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a5&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 10.用到了c1一个字段，c1用于查找，c3和c2两个字段索引失效，产生了Using filesort */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a5&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 11.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span>  <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> c2, c3;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 12.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span>  <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a5&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> c2, c3;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>   13.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 没有产生Using filesort 
</span></span></span><span style=display:flex><span><span style=color:#75715e>      因为之前c2这个字段已经确定了是&#39;a2&#39;了，这是一个常量，再去ORDER BY c3,c2 这时候c2已经不用排序了！
</span></span></span><span style=display:flex><span><span style=color:#75715e>      所以没有产生Using filesort 和(10)进行对比学习！
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a2&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c5<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a5&#39;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> c3, c2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* GROUP BY 表面上是叫做分组，但是分组之前必定排序。 */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 14.用到c1 c2 c3三个字段，c1用于查找，c2 c3用于排序，c4失效 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a4&#39;</span> <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> <span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 15.用到c1这一个字段，c4失效，c2和c3排序失效产生了Using filesort */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test03<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>c1<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a1&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#f92672>`</span>c4<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a4&#39;</span> <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> <span style=color:#f92672>`</span>c3<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>c2<span style=color:#f92672>`</span>;
</span></span></code></pre></div><p><code>GROUP BY</code>基本上都需要进行排序，索引优化几乎和<code>ORDER BY</code>一致，但是<code>GROUP BY</code>会有临时表的产生。</p><h2 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><p>索引优化的一般性建议：</p><ul><li>对于单值索引，尽量选择针对当前<code>query</code>过滤性更好的索引。</li><li>在选择复合索引的时候，当前<code>query</code>中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li><li>在选择复合索引的时候，尽量选择可以能够包含当前<code>query</code>中的<code>where</code>子句中更多字段的索引。</li><li>尽可能通过分析统计信息和调整<code>query</code>的写法来达到选择合适索引的目的。</li></ul><p>口诀：</p><ul><li>带头大哥不能死。</li><li>中间兄弟不能断。</li><li>索引列上不计算。</li><li>范围之后全失效。</li><li>覆盖索引尽量用。</li><li>不等有时会失效。</li><li>like百分加右边。</li><li>字符要加单引号。</li><li>一般SQL少用or。</li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#索引>索引</a><ul><li><a href=#索引简介>索引简介</a></li><li><a href=#索引分类>索引分类</a></li><li><a href=#索引数据结构>索引数据结构</a></li><li><a href=#哪些情况需要建索引>哪些情况需要建索引</a></li><li><a href=#那些情况不要建索引>那些情况不要建索引</a></li></ul></li><li><a href=#索引分析>索引分析</a><ul><li><a href=#单表索引分析--范围之后的索引会失效>单表索引分析&ndash;>范围之后的索引会失效</a><ul><li></li></ul></li><li><a href=#两表索引分析---左连接将索引创建在右表上更合适>两表索引分析&mdash;>左连接将索引创建在右表上更合适</a><ul><li></li></ul></li><li><a href=#三张表索引分析>三张表索引分析</a><ul><li></li></ul></li><li><a href=#结论>结论</a></li></ul></li><li><a href=#索引失效>索引失效</a><ul><li><a href=#索引失效的情况>索引失效的情况</a></li><li><a href=#最佳左前缀法则>最佳左前缀法则</a></li><li><a href=#索引列上不计算>索引列上不计算</a></li><li><a href=#范围之后全失效>范围之后全失效</a></li><li><a href=#覆盖索引尽量用>覆盖索引尽量用</a></li><li><a href=#不等有时会失效>不等有时会失效</a></li><li><a href=#like百分加右边>like百分加右边</a></li><li><a href=#字符要加单引号>字符要加单引号</a></li><li><a href=#索引相关题目>索引相关题目</a></li><li><a href=#面试题分析>面试题分析</a></li><li><a href=#总结>总结</a></li></ul></li></ul></nav></div></aside></main></body></html>