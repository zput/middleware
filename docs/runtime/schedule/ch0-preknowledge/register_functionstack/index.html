<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="伪寄存器 & 函数栈 # 伪寄存器 # 伪寄存器常用的一般是下面的四个:
FP: Frame pointer: arguments and locals. PC: Program counter: jumps and branches. SB: Static base pointer: global symbols. SP: Stack pointer: top of stack. 下面我们来翻译一下 官网1的对他们的解释，然后做一个总结,方便理解。
FP # FP伪寄存器是一个用于引用函数参数的虚拟帧指针。编译器维护一个虚拟帧指针，并将堆栈上的参数引用为该伪寄存器的偏移量。因此0(FP)是函数的第一个参数，8(FP)是第二个参数(在64位机器上)，以此类推。但是，当以这种方式引用一个函数参数时，有必要将名称放在开头，如first_arg+0(FP)和second_arg+8(FP)。(偏移量的含义(从帧指针出发的偏移量)与它在SB中的使用不同，在SB中，它是从符号出发的偏移量。) 汇编器强制执行这个约定，拒绝普通的0(FP)和8(FP)。实际的名称在语义上是不相关的，但应该用来记录参数的名称。值得强调的是，FP始终是一个伪寄存器，而不是硬件寄存器，即使在具有硬件帧指针的架构上也是如此。
The FP pseudo-register is a virtual frame pointer used to refer to function arguments. The compilers maintain a virtual frame pointer and refer to the arguments on the stack as offsets from that pseudo-register."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="伪寄存器与函数栈帧"><meta property="og:description" content="伪寄存器 & 函数栈 # 伪寄存器 # 伪寄存器常用的一般是下面的四个:
FP: Frame pointer: arguments and locals. PC: Program counter: jumps and branches. SB: Static base pointer: global symbols. SP: Stack pointer: top of stack. 下面我们来翻译一下 官网1的对他们的解释，然后做一个总结,方便理解。
FP # FP伪寄存器是一个用于引用函数参数的虚拟帧指针。编译器维护一个虚拟帧指针，并将堆栈上的参数引用为该伪寄存器的偏移量。因此0(FP)是函数的第一个参数，8(FP)是第二个参数(在64位机器上)，以此类推。但是，当以这种方式引用一个函数参数时，有必要将名称放在开头，如first_arg+0(FP)和second_arg+8(FP)。(偏移量的含义(从帧指针出发的偏移量)与它在SB中的使用不同，在SB中，它是从符号出发的偏移量。) 汇编器强制执行这个约定，拒绝普通的0(FP)和8(FP)。实际的名称在语义上是不相关的，但应该用来记录参数的名称。值得强调的是，FP始终是一个伪寄存器，而不是硬件寄存器，即使在具有硬件帧指针的架构上也是如此。
The FP pseudo-register is a virtual frame pointer used to refer to function arguments. The compilers maintain a virtual frame pointer and refer to the arguments on the stack as offsets from that pseudo-register."><meta property="og:type" content="article"><meta property="og:url" content="https://zput.github.io/go-goroutine/docs/runtime/schedule/ch0-preknowledge/register_functionstack/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2019-02-28T15:03:00+00:00"><meta property="article:modified_time" content="2019-02-28T15:03:00+00:00"><title>伪寄存器与函数栈帧 | go调度源码分析</title><link rel=manifest href=/go-goroutine/manifest.json><link rel=icon href=/go-goroutine/favicon.png type=image/x-icon><link rel=stylesheet href=/go-goroutine/book.min.76f6dbe75c94e688c018dd8b54e7f880916b14ab4cf3881b81f75d6bb916603c.css integrity="sha256-dvbb51yU5ojAGN2LVOf4gJFrFKtM84gbgfdda7kWYDw=" crossorigin=anonymous><script defer src=/go-goroutine/flexsearch.min.js></script>
<script defer src=/go-goroutine/en.search.min.75f3025a21511955ad10f181cae208dd296ce24ee2a06def487a11decfa675f1.js integrity="sha256-dfMCWiFRGVWtEPGByuII3Sls4k7ioG3vSHoR3s+mdfE=" crossorigin=anonymous></script>
<script defer src=/go-goroutine/sw.min.ec96d6e09af3075a94dd4de723a2edddf2ef138381c7e1e5b5a1f2c0578ee8bd.js integrity="sha256-7JbW4JrzB1qU3U3nI6Lt3fLvE4OBx+HltaHywFeO6L0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/go-goroutine/><span>go调度源码分析</span></a></h2><div class=magic><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64><div class="book-search-spinner spinner hidden"></div><ul id=book-search-results></ul></div><div class=book-switch><label class=switch><input id=dark-mode-checkbox type=checkbox onchange=darkmode()>
<span class=slider></span></label></div></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>Zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><hr><ul><li><span>基础知识</span><ul><li><a href=/go-goroutine/docs/foundation/golang_basic/>基本用法</a></li></ul></li><li><span>鲁棒和性能</span><ul><li><a href=/go-goroutine/docs/robustness_and_performance/golang_test/>测试相关函数</a></li></ul></li><li><span>运行时</span><ul><li><a href=/go-goroutine/docs/runtime/golang_gmp/>GMP</a></li><li><a href=/go-goroutine/docs/runtime/golang_gc/>垃圾回收</a></li><li><a href=/go-goroutine/docs/runtime/schedule/>调度</a><ul><li><span>前置知识</span><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/memory/>内存大小端</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/register_functionstack/ class=active>伪寄存器与函数栈帧</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/similar_assemble/>类汇编</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/go_underlying_struct/>底层重要结构</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/2_init_before_enter_main_function/>初始化</a></li><li><a href=/go-goroutine/docs/runtime/schedule/3_exit_goroutine/>退出</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/>调度挑选策略</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/take_goroutine_from_globalorlocal_p/>从全局/本P队列</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/steal_goroutine_from_other_p/>从其他P队列</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/>调度到达时机</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/active_scheduling/>主动调度</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/passive_scheduling/>被动调度</a></li><li><input type=checkbox id=section-99f41010918d678e89a7af90330cabe1 class=toggle>
<label for=section-99f41010918d678e89a7af90330cabe1 class="flex justify-between"><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/>剥夺调度</a></label><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/start_sysmon/>开启系统监控</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/user_code_preemption/>执行太久</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/system_call_preemption/>系统调用抢占</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script><script src=/go-goroutine/magic.js></script>
<script src=/go-goroutine/dark.js></script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/go-goroutine/svg/menu.svg class=book-icon alt=Menu></label>
<strong>伪寄存器与函数栈帧</strong>
<label for=toc-control><img src=/go-goroutine/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#伪寄存器--函数栈>伪寄存器 & 函数栈</a><ul><li><a href=#伪寄存器>伪寄存器</a><ul><li><a href=#fp>FP</a></li><li><a href=#sp>SP</a></li><li><a href=#总结>总结</a></li></ul></li><li><a href=#函数调用栈分析>函数调用栈分析</a><ul><li><a href=#例子>例子</a></li></ul></li><li><a href=#伪寄存器的位置>伪寄存器的位置</a></li><li><a href=#添加汇编>添加汇编</a></li><li><a href=#golang汇编>golang汇编</a></li><li><a href=#附录>附录</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=伪寄存器--函数栈>伪寄存器 & 函数栈
<a class=anchor href=#%e4%bc%aa%e5%af%84%e5%ad%98%e5%99%a8--%e5%87%bd%e6%95%b0%e6%a0%88>#</a></h1><h2 id=伪寄存器>伪寄存器
<a class=anchor href=#%e4%bc%aa%e5%af%84%e5%ad%98%e5%99%a8>#</a></h2><p>伪寄存器常用的一般是下面的四个:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>FP</span>: <span style=color:#a6e22e>Frame</span> <span style=color:#a6e22e>pointer</span>: <span style=color:#a6e22e>arguments</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>locals</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>PC</span>: <span style=color:#a6e22e>Program</span> <span style=color:#a6e22e>counter</span>: <span style=color:#a6e22e>jumps</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>branches</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>SB</span>: <span style=color:#a6e22e>Static</span> <span style=color:#a6e22e>base</span> <span style=color:#a6e22e>pointer</span>: <span style=color:#a6e22e>global</span> <span style=color:#a6e22e>symbols</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>SP</span>: <span style=color:#a6e22e>Stack</span> <span style=color:#a6e22e>pointer</span>: <span style=color:#a6e22e>top</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>stack</span>.
</span></span></code></pre></div><p>下面我们来翻译一下
<a href=https://golang.org/doc/asm#symbols>官网<sup>1</sup></a>的对他们的解释，然后做一个总结,方便理解。</p><h3 id=fp>FP
<a class=anchor href=#fp>#</a></h3><blockquote><p>FP伪寄存器是一个用于引用<strong>函数参数</strong>的虚拟帧指针。编译器维护一个虚拟帧指针，并将堆栈上的参数引用为该伪寄存器的偏移量。因此0(FP)是函数的第一个参数，8(FP)是第二个参数(在64位机器上)，以此类推。但是，当以这种方式引用一个函数参数时，有必要将名称放在开头，如first_arg+0(FP)和second_arg+8(FP)。(偏移量的含义(从帧指针出发的偏移量)与它在SB中的使用不同，在SB中，它是从符号出发的偏移量。) 汇编器强制执行这个约定，拒绝普通的0(FP)和8(FP)。实际的名称在语义上是不相关的，但应该用来记录参数的名称。值得强调的是，FP始终是一个伪寄存器，而不是硬件寄存器，即使在具有硬件帧指针的架构上也是如此。</p></blockquote><blockquote><p>The FP pseudo-register is a virtual frame pointer used to refer to function arguments. The compilers maintain a virtual frame pointer and refer to the arguments on the stack as offsets from that pseudo-register. Thus 0(FP) is the first argument to the function, 8(FP) is the second (on a 64-bit machine), and so on. However, when referring to a function argument this way, it is necessary to place a name at the beginning, as in first_arg+0(FP) and second_arg+8(FP). (The meaning of the offset—offset from the frame pointer—distinct from its use with SB, where it is an offset from the symbol.) The assembler enforces this convention, rejecting plain 0(FP) and 8(FP). The actual name is semantically irrelevant but should be used to document the argument&rsquo;s name. It is worth stressing that FP is always a pseudo-register, not a hardware register, even on architectures with a hardware frame pointer.</p></blockquote><blockquote><p>对于带有Go原型的汇编函数，go vet会检查参数名和偏移量是否匹配。在32位系统上，64位值的低位和高位32位是通过在名称中添加一个_lo或_hi后缀来区分的，如arg_lo+0(FP)或arg_hi+4(FP)。如果一个Go原型没有给它的结果命名，那么预期的汇编名是ret。</p></blockquote><blockquote><p>For assembly functions with Go prototypes, go vet will check that the argument names and offsets match. On 32-bit systems, the low and high 32 bits of a 64-bit value are distinguished by adding a _lo or _hi suffix to the name, as in arg_lo+0(FP) or arg_hi+4(FP). If a Go prototype does not name its result, the expected assembly name is ret.</p></blockquote><h3 id=sp>SP
<a class=anchor href=#sp>#</a></h3><blockquote><p>SP伪寄存器是一个虚拟栈指针，用于引用帧本地变量和为函数调用准备的参数。它指向本地栈帧的顶部，所以引用时应使用负偏移量，范围为[-framesize，0)：x-8(SP)，y-4(SP)，以此类推。</p></blockquote><blockquote><p>The SP pseudo-register is a virtual stack pointer used to refer to frame-local variables and the arguments being prepared for function calls. It points to the top of the local stack frame, so references should use negative offsets in the range [−framesize, 0): x-8(SP), y-4(SP), and so on.</p></blockquote><blockquote><p>在具有名为SP的硬件寄存器的架构上，名称前缀可以区分对虚拟栈指针的引用和对架构SP寄存器的引用，即x-8(SP)，y-4(SP)，以此类推。也就是说，<code>x-8(SP)</code>和<code>-8(SP)</code>是不同的内存位置：第一个是指虚拟栈指针伪寄存器，而第二个是指硬件的SP寄存器。</p></blockquote><blockquote><p>On architectures with a hardware register named SP, the name prefix distinguishes references to the virtual stack pointer from references to the architectural SP register. That is, x-8(SP) and -8(SP) are different memory locations: the first refers to the virtual stack pointer pseudo-register, while the second refers to the hardware&rsquo;s SP register.</p></blockquote><h3 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h3><ul><li>如何理解伪寄存器FP和SP呢？其实伪寄存器FP和SP相当于plan9伪汇编中的一个助记符，他们是根据当前函数栈空间计算出来的一个相对于物理寄存器SP的一个偏移量坐标。</li><li>伪SP和FP的相对位置是会变的，所以不应该尝试用伪SP寄存器去找那些本用FP+offset来引用的值，例如函数的入参和返回值。</li><li>官方文档中说的伪SP指向栈的top，是有问题的。其指向的局部变量位置实际上是整个栈的栈底（除caller BP 之外），所以说bottom更合适一些。</li><li><code>MOVQ 0(SP), AX</code>,这种前面没有flags的，它相当于<strong>实际的寄存器</strong>的值，<strong>不是</strong>伪寄存器了。</li></ul><h2 id=函数调用栈分析>函数调用栈分析
<a class=anchor href=#%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e6%a0%88%e5%88%86%e6%9e%90>#</a></h2><p>函数调用栈的知识(为方便起见，在函数A1中调用函数A2,我们称A1是caller,A2是callee); 栈指每个进程/线程/goroutine都有自己的调用栈，参数和返回值的传递，函数的局部变量存储通常是通过栈来完成的。和数据结构中的栈一样，内存栈也是后进先出的，地址从高地址开始增长到低地址。栈帧也称为帧,每一帧对应一个尚未返回的函数调用，帧本身以栈的形式存储数据。栈由许多帧组成，它描述函数之间的调用关系.</p><p>如下图所示:内存中的栈从高地址空间向低地址空间增长，栈顶小于栈底，分配栈空间对应sp值减小。</p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220622230646.png alt=20220622230646></p><p>其中caller与callee的关系在go1.17版本以下是下图所示，go1.17+以上返回参数已使用
<a href=https://github.com/golang/go/issues/40724>寄存器方式传递</a></p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220622204818.png alt=20220622204818></p><h3 id=例子>例子
<a class=anchor href=#%e4%be%8b%e5%ad%90>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Sub</span>(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//go:noinline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>a</span> , <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>生成的汇编结果如下:</p><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># disass $pc,+40 </span>
</span></span><span style=display:flex><span><span style=color:#75715e># disass $pc-30, +150</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用help disass查看用法</span>
</span></span><span style=display:flex><span><span style=color:#75715e># $pc-30, +150 打印此范围的汇编结果</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> disass $pc-30, +150
</span></span><span style=display:flex><span>Dump of assembler code from 0x45259f to 0x452635:
</span></span><span style=display:flex><span>   0x000000000045259f:	int3
</span></span><span style=display:flex><span>   0x00000000004525a0 &lt;main.main+0&gt;:	mov    %fs:0xfffffffffffffff8,%rcx
</span></span><span style=display:flex><span>   0x00000000004525a9 &lt;main.main+9&gt;:	cmp    0x10<span style=color:#f92672>(</span>%rcx<span style=color:#f92672>)</span>,%rsp
</span></span><span style=display:flex><span>   0x00000000004525ad &lt;main.main+13&gt;:	jbe    0x4525dd &lt;main.main+61&gt;
</span></span><span style=display:flex><span>   0x00000000004525af &lt;main.main+15&gt;:	sub    $0x20,%rsp
</span></span><span style=display:flex><span>   0x00000000004525b3 &lt;main.main+19&gt;:	mov    %rbp,0x18<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x00000000004525b8 &lt;main.main+24&gt;:	lea    0x18<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>,%rbp
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>&gt; 0x00000000004525bd &lt;main.main+29&gt;:	movq   $0x2,<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x00000000004525c5 &lt;main.main+37&gt;:	movq   $0x1,0x8<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x00000000004525ce &lt;main.main+46&gt;:	callq  0x4525f0 &lt;main.Sub&gt;
</span></span><span style=display:flex><span>   0x00000000004525d3 &lt;main.main+51&gt;:	mov    0x18<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>,%rbp
</span></span><span style=display:flex><span>   0x00000000004525d8 &lt;main.main+56&gt;:	add    $0x20,%rsp
</span></span><span style=display:flex><span>   0x00000000004525dc &lt;main.main+60&gt;:	retq
</span></span><span style=display:flex><span>   0x00000000004525dd &lt;main.main+61&gt;:	callq  0x44a0f0 &lt;runtime.morestack_noctxt&gt;
</span></span><span style=display:flex><span>   0x00000000004525e2 &lt;main.main+66&gt;:	jmp    0x4525a0 &lt;main.main&gt;
</span></span><span style=display:flex><span>   0x00000000004525e4:	int3
</span></span><span style=display:flex><span>   0x00000000004525e5:	int3
</span></span><span style=display:flex><span>   0x00000000004525e6:	int3
</span></span><span style=display:flex><span>   0x00000000004525e7:	int3
</span></span><span style=display:flex><span>   0x00000000004525e8:	int3
</span></span><span style=display:flex><span>   0x00000000004525e9:	int3
</span></span><span style=display:flex><span>   0x00000000004525ea:	int3
</span></span><span style=display:flex><span>   0x00000000004525eb:	int3
</span></span><span style=display:flex><span>   0x00000000004525ec:	int3
</span></span><span style=display:flex><span>   0x00000000004525ed:	int3
</span></span><span style=display:flex><span>   0x00000000004525ee:	int3
</span></span><span style=display:flex><span>   0x00000000004525ef:	int3
</span></span><span style=display:flex><span>   0x00000000004525f0 &lt;main.Sub+0&gt;:	sub    $0x10,%rsp
</span></span><span style=display:flex><span>   0x00000000004525f4 &lt;main.Sub+4&gt;:	mov    %rbp,0x8<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x00000000004525f9 &lt;main.Sub+9&gt;:	lea    0x8<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>,%rbp
</span></span><span style=display:flex><span>   0x00000000004525fe &lt;main.Sub+14&gt;:	movq   $0x0,0x28<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x0000000000452607 &lt;main.Sub+23&gt;:	mov    0x18<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>,%rax
</span></span><span style=display:flex><span>   0x000000000045260c &lt;main.Sub+28&gt;:	sub    0x20<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>,%rax
</span></span><span style=display:flex><span>   0x0000000000452611 &lt;main.Sub+33&gt;:	mov    %rax,<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x0000000000452615 &lt;main.Sub+37&gt;:	mov    %rax,0x28<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x000000000045261a &lt;main.Sub+42&gt;:	mov    0x8<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>,%rbp
</span></span><span style=display:flex><span>   0x000000000045261f &lt;main.Sub+47&gt;:	add    $0x10,%rsp
</span></span><span style=display:flex><span>   0x0000000000452623 &lt;main.Sub+51&gt;:	retq
</span></span><span style=display:flex><span>   0x0000000000452624:	add    %al,<span style=color:#f92672>(</span>%rax<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x0000000000452626:	add    %al,<span style=color:#f92672>(</span>%rax<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x0000000000452628:	add    %al,<span style=color:#f92672>(</span>%rax<span style=color:#f92672>)</span>
</span></span></code></pre></div></div></label></div><blockquote><p>这里需要注意一点的是，<strong>上面都是在代码空间的，所以左边都是代码空间的地址，当我们分析栈空间的时候,需要查找栈空间地址的内容</strong></p></blockquote><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># x/10og $rsp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># define rr</span>
</span></span><span style=display:flex><span><span style=color:#75715e># info threads</span>
</span></span><span style=display:flex><span><span style=color:#75715e># info register rbp rsp pc</span>
</span></span><span style=display:flex><span><span style=color:#75715e># end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> rr
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>3496</span> <span style=color:#e6db74>&#34;test&#34;</span>   main.Sub <span style=color:#f92672>(</span>a<span style=color:#f92672>=</span>2, b<span style=color:#f92672>=</span>1, ~r2<span style=color:#f92672>=</span>824634122328<span style=color:#f92672>)</span> at /root/pprof/common_test/main.go:8
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>3500</span> <span style=color:#e6db74>&#34;test&#34;</span>   runtime.usleep <span style=color:#f92672>()</span> at /usr/lib/go-1.13/src/runtime/sys_linux_amd64.s:131
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span>    LWP <span style=color:#ae81ff>3501</span> <span style=color:#e6db74>&#34;test&#34;</span>   runtime.futex <span style=color:#f92672>()</span> at /usr/lib/go-1.13/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>4</span>    LWP <span style=color:#ae81ff>3502</span> <span style=color:#e6db74>&#34;test&#34;</span>   runtime.futex <span style=color:#f92672>()</span> at /usr/lib/go-1.13/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>rbp            0xc000032750        0xc000032750
</span></span><span style=display:flex><span>rsp            0xc000032730        0xc000032730
</span></span><span style=display:flex><span>pc             0x4525f0            0x4525f0 &lt;main.Sub&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>  x/10og $rsp
</span></span><span style=display:flex><span>0xc000032730:	021222723	<span style=color:#ae81ff>02</span>
</span></span><span style=display:flex><span>0xc000032740:	01	<span style=color:#ae81ff>014000001420130</span>
</span></span><span style=display:flex><span>0xc000032750:	014000000623530	<span style=color:#ae81ff>020463176</span>
</span></span><span style=display:flex><span>0xc000032760:	014000001420000	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0xc000032770:	014000001420000	<span style=color:#ae81ff>0</span>
</span></span></code></pre></div></div></label></div><p>下面来一步一步来看下调用的过程:</p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220622193033.png alt=20220622193033></p><hr><h2 id=伪寄存器的位置>伪寄存器的位置
<a class=anchor href=#%e4%bc%aa%e5%af%84%e5%ad%98%e5%99%a8%e7%9a%84%e4%bd%8d%e7%bd%ae>#</a></h2><ul><li>下面来做下实验。<ul><li>确认伪FP， SP相对于真实存在的寄存器的位置点<ul><li>我们伪FP应该在caller&rsquo;s next pc + 8byte</li><li>伪SP应该在caller&rsquo;s BP</li></ul></li></ul></li></ul><blockquote><p>main.go</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>test_FP_SP</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int64</span>)(<span style=color:#a6e22e>first</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>second</span> <span style=color:#66d9ef>uintptr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>(){
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>first</span>, <span style=color:#a6e22e>second</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>test_FP_SP</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>first</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>second</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>first</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>test_FP_SP.s</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// func test_FP_SP(a, b int64)(first uintptr, second uintptr)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>test_FP_SP</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1040</span><span style=color:#f92672>-</span><span style=color:#ae81ff>16</span>    <span style=color:#75715e>// 这里的16是为了存caller调用call指令的时候，把它下一个pc地圵放入栈中与caller&#39;s BP,所以就减16
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>LEAQ</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>DI</span>         <span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>first</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>FP</span>)    <span style=color:#75715e>// 将原伪寄存器SP偏移量存入返回值first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>MOVQ</span>    <span style=color:#a6e22e>SP</span>, <span style=color:#a6e22e>BP</span>           <span style=color:#75715e>// 存储物理SP偏移量到BP寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>ADDQ</span>    <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>512</span>, <span style=color:#a6e22e>SP</span>        <span style=color:#75715e>// 将物理SP偏移增加 0.5K
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LEAQ</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>SI</span>         <span style=color:#75715e>// 在上面中只改变了一个值就是SP这个寄存器，然后再次一模一样的把x-0(SP)给到了SI.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* 第一个 MOVQ    BP, SP */</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>MOVQ</span>    <span style=color:#a6e22e>BP</span>, <span style=color:#a6e22e>SP</span>           <span style=color:#75715e>// 恢复物理SP，因为修改物理SP后，伪寄存器FP/SP随之改变，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                 <span style=color:#75715e>// 为了正确访问FP，先恢复物理SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>second</span><span style=color:#f92672>+</span><span style=color:#ae81ff>24</span>(<span style=color:#a6e22e>FP</span>)   <span style=color:#75715e>// 将偏移后的伪寄存器SP偏移量存入返回值second
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* 第二个 MOVQ    BP, SP */</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//MOVQ    BP, SP         
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RET</span>					    <span style=color:#75715e>// 从输出的second-first来看，正好相差 0.5K
</span></span></span></code></pre></div><p>编译一下源代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># linux</span>
</span></span><span style=display:flex><span>go build -gcflags <span style=color:#e6db74>&#34;-N -l&#34;</span> -o test .
</span></span><span style=display:flex><span><span style=color:#75715e># or </span>
</span></span><span style=display:flex><span>go build -gcflags <span style=color:#e6db74>&#34;all=-N -l&#34;</span> -o test .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># xos:</span>
</span></span><span style=display:flex><span>go build -gcflags <span style=color:#e6db74>&#34;all=-N -l&#34;</span> -ldflags<span style=color:#f92672>=</span>-compressdwarf<span style=color:#f92672>=</span>false   -o test .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># result</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@iZf8z14idfp0rwhiicngwqZ FP_SP<span style=color:#f92672>]</span><span style=color:#75715e># tree .</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── main.go
</span></span><span style=display:flex><span>├── test
</span></span><span style=display:flex><span>└── test_FP_SP.s
</span></span></code></pre></div><p>我们用到的gdb命令:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span>gdb ./test
</span></span><span style=display:flex><span>list
</span></span><span style=display:flex><span>b <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>display /25i $pc-8
</span></span><span style=display:flex><span>si
</span></span><span style=display:flex><span>si
</span></span><span style=display:flex><span>si
</span></span></code></pre></div><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>disass</span> <span style=color:#66d9ef>$pc</span>, <span style=color:#960050;background-color:#1e0010>+</span> <span style=color:#ae81ff>240</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Dump</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>assembler</span> <span style=color:#66d9ef>code</span> <span style=color:#66d9ef>from</span> <span style=color:#ae81ff>0x4591dd</span> <span style=color:#66d9ef>to</span> <span style=color:#ae81ff>0x4592cd</span>:
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>=&gt;</span> <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004591dd</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>29</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>movq</span>   <span style=color:#66d9ef>$0x1</span>,(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004591e5</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>37</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>movq</span>   <span style=color:#66d9ef>$0x2</span>,<span style=color:#ae81ff>0x8</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004591ee</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>46</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>callq</span>  <span style=color:#ae81ff>0x459240</span> &lt;<span style=color:#66d9ef>main.test_FP_SP</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004591f3</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>51</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x10</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004591f8</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>56</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,<span style=color:#ae81ff>0x38</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004591fd</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>61</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x18</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459202</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>66</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,<span style=color:#ae81ff>0x30</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459207</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>71</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x38</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045920c</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>76</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,<span style=color:#ae81ff>0x28</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459211</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>81</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x30</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459216</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>86</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,<span style=color:#ae81ff>0x20</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045921b</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>91</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x28</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459220</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>96</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>sub</span>    <span style=color:#ae81ff>0x20</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459225</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>101</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,<span style=color:#ae81ff>0x28</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045922a</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>106</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x40</span>(%rsp),%rbp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045922f</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>111</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>add</span>    <span style=color:#66d9ef>$0x48</span>,%rsp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459233</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>115</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>retq</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459234</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>116</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>callq</span>  <span style=color:#ae81ff>0x450c70</span> &lt;<span style=color:#66d9ef>runtime.morestack_noctxt</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459239</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.main</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>121</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jmp</span>    <span style=color:#ae81ff>0x4591c0</span> &lt;<span style=color:#66d9ef>main.main</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x000000000045923b:	<span style=color:#a6e22e>int3</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x000000000045923c:	<span style=color:#a6e22e>int3</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x000000000045923d:	<span style=color:#a6e22e>int3</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x000000000045923e:	<span style=color:#a6e22e>int3</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x000000000045923f:	<span style=color:#a6e22e>int3</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459240</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %fs:<span style=color:#ae81ff>0xfffffffffffffff8</span>,%rcx
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459249</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>9</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    -<span style=color:#ae81ff>0x398</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459251</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>17</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>cmp</span>    <span style=color:#ae81ff>0x10</span>(%rcx),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459255</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>21</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jbe</span>    <span style=color:#ae81ff>0x4592ab</span> &lt;<span style=color:#66d9ef>main.test_FP_SP</span>+<span style=color:#ae81ff>107</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459257</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>23</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>sub</span>    <span style=color:#66d9ef>$0x418</span>,%rsp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045925e</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>30</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rbp,<span style=color:#ae81ff>0x410</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459266</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>38</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#ae81ff>0x410</span>(%rsp),%rbp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045926e</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>46</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#ae81ff>0x410</span>(%rsp),%rdi
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459276</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>54</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rdi,<span style=color:#ae81ff>0x430</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045927e</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>62</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rsp,%rbp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459281</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>65</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>add</span>    <span style=color:#66d9ef>$0x200</span>,%rsp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459288</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>72</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#ae81ff>0x410</span>(%rsp),%rsi
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459290</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>80</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rbp,%rsp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459293</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>83</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rsi,<span style=color:#ae81ff>0x438</span>(%rsp)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000045929b</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>91</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x410</span>(%rsp),%rbp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004592a3</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>99</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>add</span>    <span style=color:#66d9ef>$0x418</span>,%rsp
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004592aa</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>106</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>retq</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004592ab</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>107</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>callq</span>  <span style=color:#ae81ff>0x450c70</span> &lt;<span style=color:#66d9ef>runtime.morestack_noctxt</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004592b0</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>112</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jmp</span>    <span style=color:#ae81ff>0x459240</span> &lt;<span style=color:#66d9ef>main.test_FP_SP</span>&gt;
</span></span></code></pre></div></div></label></div><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><ul><li><p>si: To execute one line of code, type &ldquo;step&rdquo; or &ldquo;s&rdquo;. If the line to be executed is a function call, gdb will step into that function and start executing its code one line at a time</p></li><li><p>n: If you want to execute the entire function with one keypress, type &ldquo;next&rdquo; or &ldquo;n&rdquo;</p></li><li><p>set pagination off</p><ul><li>关闭按页打印</li></ul></li><li><p>定义函数:</p></li></ul><pre tabindex=0><code>define rr
info threads
info register rbp rsp pc
end
</code></pre><ul><li>打印指定地址的值<ul><li>x/10og 0xc000032738</li><li>x/40xg</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> help x
</span></span><span style=display:flex><span>Examine memory: x/FMT ADDRESS.
</span></span><span style=display:flex><span>ADDRESS is an expression <span style=color:#66d9ef>for</span> the memory address to examine.
</span></span><span style=display:flex><span>FMT is a repeat count followed by a format letter and a size letter.
</span></span><span style=display:flex><span>Format letters are o<span style=color:#f92672>(</span>octal<span style=color:#f92672>)</span>, x<span style=color:#f92672>(</span>hex<span style=color:#f92672>)</span>, d<span style=color:#f92672>(</span>decimal<span style=color:#f92672>)</span>, u<span style=color:#f92672>(</span>unsigned decimal<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>  t<span style=color:#f92672>(</span>binary<span style=color:#f92672>)</span>, f<span style=color:#f92672>(</span>float<span style=color:#f92672>)</span>, a<span style=color:#f92672>(</span>address<span style=color:#f92672>)</span>, i<span style=color:#f92672>(</span>instruction<span style=color:#f92672>)</span>, c<span style=color:#f92672>(</span>char<span style=color:#f92672>)</span> and s<span style=color:#f92672>(</span>string<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>  T<span style=color:#f92672>(</span>OSType<span style=color:#f92672>)</span>, A<span style=color:#f92672>(</span>floating point values in hex<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Size letters are b<span style=color:#f92672>(</span>byte<span style=color:#f92672>)</span>, h<span style=color:#f92672>(</span>halfword<span style=color:#f92672>)</span>, w<span style=color:#f92672>(</span>word<span style=color:#f92672>)</span>, g<span style=color:#f92672>(</span>giant, <span style=color:#ae81ff>8</span> bytes<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>The specified number of objects of the specified size are printed
</span></span><span style=display:flex><span>according to the format.
</span></span></code></pre></div><ul><li><p>打印变量的值&地址</p><ul><li>p first</li><li>p &first</li></ul></li><li><p>查看汇编源码，注意找准开始点</p><ul><li>help disass</li><li><del>disass $pc-1,+100</del></li><li>disass $pc,+40</li></ul></li></ul><blockquote><p><strong>disass会从你指定的位置解析，如果当前指定的值是在某个指令的中间，那么它的后面会错误的解析</strong>
So, for example, if you want to disassemble function bar in file foo.c you must type &ldquo;disassemble &lsquo;foo.c&rsquo;::bar&rdquo; and not &ldquo;disassemble foo.c:bar&rdquo;</p></blockquote></div></label></div><p>从上面的图中可以看出，go assemble中的<code>x-0(SP)</code>与<code>first+16(FP)</code>,其实都是与SP寄存器关联的，其中SP，伪FP，与伪SP的位置，在下图中已经标识出来了;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>                 +------------------------+                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |         second         |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |-------------------------                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |         first          |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |------------------------|                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |         b              |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |------------------------|                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |         a              |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>            伪FP +------------------------+                       
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>                 |     caller<span style=color:#e6db74>&#39;s pc        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |                        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 +------------------------+                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |                        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |                        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |     caller&#39;</span>s BP        |                                  
</span></span><span style=display:flex><span>                 |                        |                                  
</span></span><span style=display:flex><span>伪SP|callee<span style=color:#e6db74>&#39;s BP +------------------------+ 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |                        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |                        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |        ...             |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |                        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 |                        |                                  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>真实寄存器SP等于   +------------------------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     caller&#39;</span>s SP - caller<span style=color:#e6db74>&#39;s next CP(8) - callee&#39;</span>s stack size
</span></span><span style=display:flex><span>     上图已标识
</span></span></code></pre></div><hr><p>当我们把<code>/* 第一个 MOVQ BP, SP */</code>下面的注释掉，执行的话会panic，是因为PC寄存器读取错误，而不是注释掉的下一行导致的。</p><p>可以实验下:我们把<code>/* 第二个 MOVQ BP, SP */</code>取消注释，它就正常执行，只是返回值不对而已。</p><h2 id=添加汇编>添加汇编
<a class=anchor href=#%e6%b7%bb%e5%8a%a0%e6%b1%87%e7%bc%96>#</a></h2><p>go编译器在函数头添加额外汇编，判断当前<strong>Goroutine栈</strong>是否将越界,如将越界,需加空间</p><ul><li>go version go1.13.8 linux/amd64</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459240</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %fs:<span style=color:#ae81ff>0xfffffffffffffff8</span>,%rcx
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459249</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>9</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    -<span style=color:#ae81ff>0x398</span>(%rsp),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459251</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>17</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>cmp</span>    <span style=color:#ae81ff>0x10</span>(%rcx),%rax
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000459255</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>21</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jbe</span>    <span style=color:#ae81ff>0x4592ab</span> &lt;<span style=color:#66d9ef>main.test_FP_SP</span>+<span style=color:#ae81ff>107</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004592ab</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>107</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>callq</span>  <span style=color:#ae81ff>0x450c70</span> &lt;<span style=color:#66d9ef>runtime.morestack_noctxt</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00000000004592b0</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>112</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jmp</span>    <span style=color:#ae81ff>0x459240</span> &lt;<span style=color:#66d9ef>main.test_FP_SP</span>&gt;
</span></span></code></pre></div><ul><li>go version go1.15</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>=&gt;</span> <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x459240</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %fs:<span style=color:#ae81ff>0xfffffffffffffff8</span>,%rcx
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x459249</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>9</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x10</span>(%rcx),%rsi
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x45924d</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>13</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>cmp</span>    <span style=color:#66d9ef>$0xfffffffffffffade</span>,%rsi
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x459254</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>20</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>je</span>     <span style=color:#ae81ff>0x4592bd</span> &lt;<span style=color:#66d9ef>main.test_FP_SP</span>+<span style=color:#ae81ff>125</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#a6e22e>...</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x4592bd</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>125</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>callq</span>  <span style=color:#ae81ff>0x450c70</span> &lt;<span style=color:#66d9ef>runtime.morestack_noctxt</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x4592c2</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>main.test_FP_SP</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>130</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jmpq</span>   <span style=color:#ae81ff>0x459240</span> &lt;<span style=color:#66d9ef>main.test_FP_SP</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x4592c7:	<span style=color:#a6e22e>add</span>    %al,(%rax)
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x4592c9:	<span style=color:#a6e22e>add</span>    %al,(%rax)
</span></span></code></pre></div><p>可以观察到是在头和尾部加上了跳转代码</p><ul><li><code>0x10(%rcx)</code></li><li><code>$0xfffffffffffffade</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stack</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lo</span> <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hi</span> <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>g</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stack parameters.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// stack describes the actual stack memory: [stack.lo, stack.hi).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// stackguard0 is the stack pointer compared in the Go stack growth prologue.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// stackguard1 is the stack pointer compared in the C stack growth prologue.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// It is stack.lo+StackGuard on g0 and gsignal stacks.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stack</span>       <span style=color:#a6e22e>stack</span>   <span style=color:#75715e>// offset known to runtime/cgo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stackguard0</span> <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stackguard1</span> <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//...
</span></span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220626164439.png alt=20220626164439></p><p>其中rcx是g的地址，所以<code>0x10(%rcx)</code>是就是g.stackguard0的值，当被设置需要抢占的时候，其值是:
<a href=https://github.com/golang/go/blob/0e85fd7561de869add933801c531bf25dee9561c/src/cmd/internal/objabi/stack.go#L17><code>StackPreempt = -1314 // 也就是 0xfff...fade</code></a></p><p>当设置需要抢占的时候，程序会会跳转到函数尾部的<code>runtime.morestack_noctxt</code>函数</p><h2 id=golang汇编>golang汇编
<a class=anchor href=#golang%e6%b1%87%e7%bc%96>#</a></h2><p>Addressing modes:</p><ul><li>(DI)(BX<em>2): The location at address DI plus BX</em>2.</li><li>64(DI)(BX<em>2): The location at address DI plus BX</em>2 plus 64. These modes accept only 1, 2, 4, and 8 as scale factors.</li></ul><h2 id=附录>附录
<a class=anchor href=#%e9%99%84%e5%bd%95>#</a></h2><ul><li><p><a href=https://lrita.github.io/2017/12/12/golang-asm/#interface>https://lrita.github.io/2017/12/12/golang-asm/#interface</a></p></li><li><p><a href=https://github.com/cch123/golang-notes/blob/master/assembly.md#plan9-assembly-%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90>https://github.com/cch123/golang-notes/blob/master/assembly.md#plan9-assembly-%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90</a></p></li><li><p><a href=https://mzh.io/about>https://mzh.io/about</a></p></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#伪寄存器--函数栈>伪寄存器 & 函数栈</a><ul><li><a href=#伪寄存器>伪寄存器</a><ul><li><a href=#fp>FP</a></li><li><a href=#sp>SP</a></li><li><a href=#总结>总结</a></li></ul></li><li><a href=#函数调用栈分析>函数调用栈分析</a><ul><li><a href=#例子>例子</a></li></ul></li><li><a href=#伪寄存器的位置>伪寄存器的位置</a></li><li><a href=#添加汇编>添加汇编</a></li><li><a href=#golang汇编>golang汇编</a></li><li><a href=#附录>附录</a></li></ul></li></ul></nav></div></aside></main></body></html>