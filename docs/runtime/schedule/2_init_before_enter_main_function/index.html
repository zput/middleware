<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="进入main函数前的初始化 # 我们首先来gdb调试一下这个程序
// main.go package main import &#34;fmt&#34; // the function's body is empty func add(x, y int64) int64 func main() { gg:=add(2, 3) fmt.Println(gg) } // add_amd.s TEXT ·add(SB),$0-24 MOVQ x+0(FP), BX MOVQ y+8(FP), BP ADDQ BP, BX MOVQ BX, ret+16(FP) RET 编译一下源代码: go build -gcflags &#34;-N -l&#34; -o test ..
程序加载到内存入口 # Expand ↕ (gdb) info files Symbols from &#34;/tmp/kubernets/test&#34;. Local exec file: `/tmp/kubernets/test', file type elf64-x86-64."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="初始化"><meta property="og:description" content="进入main函数前的初始化 # 我们首先来gdb调试一下这个程序
// main.go package main import &#34;fmt&#34; // the function's body is empty func add(x, y int64) int64 func main() { gg:=add(2, 3) fmt.Println(gg) } // add_amd.s TEXT ·add(SB),$0-24 MOVQ x+0(FP), BX MOVQ y+8(FP), BP ADDQ BP, BX MOVQ BX, ret+16(FP) RET 编译一下源代码: go build -gcflags &#34;-N -l&#34; -o test ..
程序加载到内存入口 # Expand ↕ (gdb) info files Symbols from &#34;/tmp/kubernets/test&#34;. Local exec file: `/tmp/kubernets/test', file type elf64-x86-64."><meta property="og:type" content="article"><meta property="og:url" content="https://zput.github.io/go-goroutine/docs/runtime/schedule/2_init_before_enter_main_function/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-01-20T10:03:00+00:00"><meta property="article:modified_time" content="2020-01-20T10:03:00+00:00"><title>初始化 | go调度源码分析</title><link rel=manifest href=/go-goroutine/manifest.json><link rel=icon href=/go-goroutine/favicon.png type=image/x-icon><link rel=stylesheet href=/go-goroutine/book.min.76f6dbe75c94e688c018dd8b54e7f880916b14ab4cf3881b81f75d6bb916603c.css integrity="sha256-dvbb51yU5ojAGN2LVOf4gJFrFKtM84gbgfdda7kWYDw=" crossorigin=anonymous><script defer src=/go-goroutine/flexsearch.min.js></script>
<script defer src=/go-goroutine/en.search.min.75f3025a21511955ad10f181cae208dd296ce24ee2a06def487a11decfa675f1.js integrity="sha256-dfMCWiFRGVWtEPGByuII3Sls4k7ioG3vSHoR3s+mdfE=" crossorigin=anonymous></script>
<script defer src=/go-goroutine/sw.min.ec96d6e09af3075a94dd4de723a2edddf2ef138381c7e1e5b5a1f2c0578ee8bd.js integrity="sha256-7JbW4JrzB1qU3U3nI6Lt3fLvE4OBx+HltaHywFeO6L0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/go-goroutine/><span>go调度源码分析</span></a></h2><div class=magic><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64><div class="book-search-spinner spinner hidden"></div><ul id=book-search-results></ul></div><div class=book-switch><label class=switch><input id=dark-mode-checkbox type=checkbox onchange=darkmode()>
<span class=slider></span></label></div></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>Zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><hr><ul><li><span>基础知识</span><ul><li><a href=/go-goroutine/docs/foundation/golang_basic/>基本用法</a></li></ul></li><li><span>鲁棒和性能</span><ul><li><a href=/go-goroutine/docs/robustness_and_performance/golang_test/>测试相关函数</a></li></ul></li><li><span>运行时</span><ul><li><a href=/go-goroutine/docs/runtime/golang_gmp/>GMP</a></li><li><a href=/go-goroutine/docs/runtime/golang_gc/>垃圾回收</a></li><li><a href=/go-goroutine/docs/runtime/schedule/>调度</a><ul><li><span>前置知识</span><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/memory/>内存大小端</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/register_functionstack/>伪寄存器与函数栈帧</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/similar_assemble/>类汇编</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/go_underlying_struct/>底层重要结构</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/2_init_before_enter_main_function/ class=active>初始化</a></li><li><a href=/go-goroutine/docs/runtime/schedule/3_exit_goroutine/>退出</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/>调度挑选策略</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/take_goroutine_from_globalorlocal_p/>从全局/本P队列</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/steal_goroutine_from_other_p/>从其他P队列</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/>调度到达时机</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/active_scheduling/>主动调度</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/passive_scheduling/>被动调度</a></li><li><input type=checkbox id=section-99f41010918d678e89a7af90330cabe1 class=toggle>
<label for=section-99f41010918d678e89a7af90330cabe1 class="flex justify-between"><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/>剥夺调度</a></label><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/start_sysmon/>开启系统监控</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/user_code_preemption/>执行太久</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/system_call_preemption/>系统调用抢占</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script><script src=/go-goroutine/magic.js></script>
<script src=/go-goroutine/dark.js></script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/go-goroutine/svg/menu.svg class=book-icon alt=Menu></label>
<strong>初始化</strong>
<label for=toc-control><img src=/go-goroutine/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#进入main函数前的初始化>进入main函数前的初始化</a><ul><li><a href=#程序加载到内存入口>程序加载到内存入口</a></li><li><a href=#进行初始化全局变量>进行初始化全局变量</a><ul><li><a href=#初始化全局变量g0>初始化全局变量g0</a></li><li><a href=#m0和g0绑定在一起>m0和g0绑定在一起</a></li><li><a href=#设置ncpump的个数初始化m0allp>设置nCPU/M/P的个数,初始化m0,allp</a></li><li><a href=#创建main-goroutine>创建main goroutine</a></li></ul></li><li><a href=#开始m>开始M</a><ul><li><a href=#mstart>mstart</a></li><li><a href=#mstart1>mstart1</a></li><li><a href=#保存pcsp到g0>保存pc,sp到g0</a></li><li><a href=#schedule函数>schedule函数</a></li><li><a href=#execute函数>execute函数</a></li><li><a href=#gogo>gogo</a></li></ul></li><li><a href=#进入main函数>进入main函数</a></li></ul></li><li><a href=#总结图>总结图</a><ul><li><a href=#附录>附录</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=进入main函数前的初始化>进入main函数前的初始化
<a class=anchor href=#%e8%bf%9b%e5%85%a5main%e5%87%bd%e6%95%b0%e5%89%8d%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96>#</a></h1><p>我们首先来gdb调试一下这个程序</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// main.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the function&#39;s body is empty
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gg</span><span style=color:#f92672>:=</span><span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>gg</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// add_amd.s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>y</span><span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDQ</span> <span style=color:#a6e22e>BP</span>, <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>ret</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>FP</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><p>编译一下源代码: <code>go build -gcflags "-N -l" -o test .</code>.</p><h2 id=程序加载到内存入口>程序加载到内存入口
<a class=anchor href=#%e7%a8%8b%e5%ba%8f%e5%8a%a0%e8%bd%bd%e5%88%b0%e5%86%85%e5%ad%98%e5%85%a5%e5%8f%a3>#</a></h2><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220622230646.png alt=20220622230646></p><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><pre tabindex=0><code>(gdb) info files
Symbols from &#34;/tmp/kubernets/test&#34;.
Local exec file:
	`/tmp/kubernets/test&#39;, file type elf64-x86-64.
	Entry point: 0x454e00
	0x0000000000401000 - 0x000000000048cfd3 is .text
	0x000000000048d000 - 0x00000000004dc550 is .rodata
	0x00000000004dc720 - 0x00000000004dd38c is .typelink
	0x00000000004dd390 - 0x00000000004dd3e0 is .itablink
	0x00000000004dd3e0 - 0x00000000004dd3e0 is .gosymtab
	0x00000000004dd3e0 - 0x0000000000548adf is .gopclntab
	0x0000000000549000 - 0x0000000000549020 is .go.buildinfo
	0x0000000000549020 - 0x0000000000556118 is .noptrdata
	0x0000000000556120 - 0x000000000055d110 is .data
	0x000000000055d120 - 0x0000000000578990 is .bss
	0x00000000005789a0 - 0x000000000057b108 is .noptrbss
	0x0000000000400f9c - 0x0000000000401000 is .note.go.buildid
(gdb) b *0x454e00
Breakpoint 1 at 0x454e00: file /usr/lib/golang/src/runtime/rt0_linux_amd64.s, line 8. //跳到这个文件来了
(gdb) run
Starting program: /tmp/kubernets/test

Breakpoint 1, _rt0_amd64_linux () at /usr/lib/golang/src/runtime/rt0_linux_amd64.s:8 //跳到这个文件来了
8		JMP	_rt0_amd64(SB)

(gdb) info registers bp sp
bp             0x0	0
sp             0x7fffffffe4d0	0x7fffffffe4d0

(gdb) next
16		LEAQ	8(SP), SI	// argv
(gdb) list
11	// internal linking. This is the entry point for the program from the
12	// kernel for an ordinary -buildmode=exe program. The stack holds the
13	// number of arguments and the C-style argv.
14	TEXT _rt0_amd64(SB),NOSPLIT,$-8
15		MOVQ	0(SP), DI	// argc
16		LEAQ	8(SP), SI	// argv
17		JMP	runtime·rt0_go(SB)
(gdb) next
runtime.rt0_go () at /usr/lib/golang/src/runtime/asm_amd64.s:89 //跳到这个文件来了
89		MOVQ	DI, AX		// argc
(gdb) list
84	DATA _rt0_amd64_lib_argv&lt;&gt;(SB)/8, $0
85	GLOBL _rt0_amd64_lib_argv&lt;&gt;(SB),NOPTR, $8
86
87	TEXT runtime·rt0_go(SB),NOSPLIT,$0
88		// copy arguments forward on an even stack
89		MOVQ	DI, AX		// argc
90		MOVQ	SI, BX		// argv
91		SUBQ	$(4*8+7), SP		// 2args 2auto
92		ANDQ	$~15, SP
93		MOVQ	AX, 16(SP)
</code></pre></div></label></div><p>从上面的调试来看,最终到到达了<code>src/runtime/asm_amd64.s:89</code>的
<a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/asm_amd64.s#L87>runtime.rt0_go</a>函数.</p><pre tabindex=0><code class=language-file data-lang=file>file /usr/lib/golang/src/runtime/rt0_linux_amd64.s, line 8. //跳到这个文件来
_rt0_amd64_linux () at /usr/lib/golang/src/runtime/rt0_linux_amd64.s:8 //跳到这个文件来
runtime.rt0_go () at /usr/lib/golang/src/runtime/asm_amd64.s:89 //跳到这个文件来
</code></pre><h2 id=进行初始化全局变量>进行初始化全局变量
<a class=anchor href=#%e8%bf%9b%e8%a1%8c%e5%88%9d%e5%a7%8b%e5%8c%96%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f>#</a></h2><p>主要是<code>rt0_go()</code>函数</p><h3 id=初始化全局变量g0>初始化全局变量g0
<a class=anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8fg0>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>rt0_go</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// copy arguments forward on an even stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>AX</span>		<span style=color:#75715e>// argc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>BX</span>		<span style=color:#75715e>// argv
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>SUBQ</span>	<span style=color:#960050;background-color:#1e0010>$</span>(<span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#ae81ff>8</span><span style=color:#f92672>+</span><span style=color:#ae81ff>7</span>), <span style=color:#a6e22e>SP</span>		<span style=color:#75715e>// 2args 2auto
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ANDQ</span>	<span style=color:#960050;background-color:#1e0010>$~</span><span style=color:#ae81ff>15</span>, <span style=color:#a6e22e>SP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>SP</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, <span style=color:#ae81ff>24</span>(<span style=color:#a6e22e>SP</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>//TODO zxc 调整栈顶寄存器使其按16字节对齐; argc放在SP + 16字节处; argv放在SP + 24字节处
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// create istack out of the given (operating system) stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// _cgo_init may update stackguard.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>g0</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>DI</span>     <span style=color:#75715e>//全局的变量g0的地址放入DI寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>LEAQ</span>	(<span style=color:#f92672>-</span><span style=color:#ae81ff>64</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1024</span><span style=color:#f92672>+</span><span style=color:#ae81ff>104</span>)(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>g_stackguard0</span>(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>g_stackguard1</span>(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_stack</span><span style=color:#f92672>+</span><span style=color:#a6e22e>stack_lo</span>)(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>SP</span>, (<span style=color:#a6e22e>g_stack</span><span style=color:#f92672>+</span><span style=color:#a6e22e>stack_hi</span>)(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO zxc 始初始化全局变量g0, g0的栈大约有64K，地址范围为 SP - 64*1024 + 104 ～ SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>    ...省略一些CPU相关的汇编
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span><span style=color:#f92672>+</span><span style=color:#a6e22e>m_tls</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>DI</span>  <span style=color:#75715e>// //DI = &amp;m0.tls，取m0的tls成员的地址到DI寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>settls</span>(<span style=color:#a6e22e>SB</span>)        <span style=color:#75715e>// 调用settls设置线程本地存储，settls函数的参数在DI寄存器中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// store through it, to make sure it works // 可以看做是单元测试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x123</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span><span style=color:#f92672>+</span><span style=color:#a6e22e>m_tls</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x123</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JEQ</span> <span style=color:#ae81ff>2</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>abort</span>(<span style=color:#a6e22e>SB</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span></code></pre></div><p>关于这个函数,可以看下前文&lt;类汇编.tls相关函数>一节</p><h3 id=m0和g0绑定在一起>m0和g0绑定在一起
<a class=anchor href=#m0%e5%92%8cg0%e7%bb%91%e5%ae%9a%e5%9c%a8%e4%b8%80%e8%b5%b7>#</a></h3><p>我们继续下面的<code>runtime·rt0_go</code>函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ok</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>// set the per-goroutine and per-mach &#34;registers&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>g0</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>CX</span> <span style=color:#75715e>//取的g0的在堆上的地址放入CX--&gt;CX = g0的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>CX</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>BX</span>)          <span style=color:#75715e>//把g0的地址保存在线程本地存储里面，也就是*TLS=&amp;g0 --&gt; m0.tls[0]=&amp;g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span> <span style=color:#75715e>//AX=&amp;m0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// save m-&gt;g0 = g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>CX</span>, <span style=color:#a6e22e>m_g0</span>(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// save m0 to g0-&gt;m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#a6e22e>g_m</span>(<span style=color:#a6e22e>CX</span>)
</span></span></code></pre></div><p>把m0和g0绑定在一起，之后在主线程中通过get_tls可以获取到g0，通过g0的m成员又可以找到m0，就可实现了m0和g0与主线程之间的关联.</p><p>从这里还可以看到，保存在主线程本地存储中的值是g0的地址，也就是说工作线程的私有全局变量其实是一个指向g的指针而不是指向m的指针</p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220623172503.png alt=20220623172503></p><h3 id=设置ncpump的个数初始化m0allp>设置nCPU/M/P的个数,初始化m0,allp
<a class=anchor href=#%e8%ae%be%e7%bd%aencpump%e7%9a%84%e4%b8%aa%e6%95%b0%e5%88%9d%e5%a7%8b%e5%8c%96m0allp>#</a></h3><p>我们继续下面的<code>runtime·rt0_go</code>函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>  	<span style=color:#a6e22e>CLD</span>				<span style=color:#75715e>// convention is D is always left cleared 不需要关心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>check</span>(<span style=color:#a6e22e>SB</span>) <span style=color:#75715e>//不需要关心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVL</span>	<span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>AX</span>		<span style=color:#75715e>// copy argc;  AX = argc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVL</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>)       <span style=color:#75715e>// argc放在栈顶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>24</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>AX</span>		<span style=color:#75715e>// copy argv;  AX = argv
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>SP</span>)       <span style=color:#75715e>// argv放在SP + 8的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>args</span>(<span style=color:#a6e22e>SB</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>osinit</span>(<span style=color:#a6e22e>SB</span>) <span style=color:#75715e>//全局变量 ncpu = CPU核数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>schedinit</span>(<span style=color:#a6e22e>SB</span>)
</span></span></code></pre></div><h4 id=schedinit初始化>schedinit初始化
<a class=anchor href=#schedinit%e5%88%9d%e5%a7%8b%e5%8c%96>#</a></h4><p>schedinit主要也是进行一些初始化工作, 设置M的最大个数,P的个数(优先设置为环境变量GOMAXPROCS,如环境变量不存在就设置为系统CPU核数),初始化m0</p><blockquote><p><a href=https://github.com/golang/go/blob/5c2c6d3fbf4f0a1299b5e41463847d242eae19ca/src/runtime/proc.go#L535>sr/runtime/proc.go</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// The bootstrap sequence is:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	call osinit
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	call schedinit
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	make &amp; queue new G
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	call runtime·mstart
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The new G calls runtime·main.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>schedinit</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// raceinit must be the first call to race detector.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// In particular, it must be done before mallocinit below calls racemapshadow.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>    getg函数在源代码中没有对应的定义，由编译器插入类似下面两行代码
</span></span></span><span style=display:flex><span><span style=color:#75715e>    get_tls(CX) // CX=TLS
</span></span></span><span style=display:flex><span><span style=color:#75715e>    MOVQ g(CX), BX; BX存器里面现在放的是当前g结构体对象的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>    可以参考这个,根据https://github.com/golang/go/blob/d029058b5912312963225c40ae4bf44e3cb4be76/src/runtime/HACKING.md
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>maxmcount</span> = <span style=color:#ae81ff>10000</span> <span style=color:#75715e>// 最多启动10000个操作系统线程，也是最多10000个M
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mcommoninit</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>) <span style=color:#75715e>//初始化m0，因为从前面的代码我们知道g0-&gt;m = &amp;m0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>procs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ncpu</span>  <span style=color:#75715e>//系统中有多少核，就创建和初始化多少个p结构体对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atoi32</span>(<span style=color:#a6e22e>gogetenv</span>(<span style=color:#e6db74>&#34;GOMAXPROCS&#34;</span>)); <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>n</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>procs</span> = <span style=color:#a6e22e>n</span>  <span style=color:#75715e>//如果指定了GOMAXPROCS大于0，则创建指定数量的p
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>procresize</span>(<span style=color:#a6e22e>procs</span>) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unknown runnable goroutine during bootstrap&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h5 id=mcommoninit>mcommoninit
<a class=anchor href=#mcommoninit>#</a></h5><p><a href=https://github.com/golang/go/blob/5c2c6d3fbf4f0a1299b5e41463847d242eae19ca/src/runtime/proc.go#L641>mcommoninit</a>主要是判断m是否超过个数,然后放入全局m链表,防止垃圾回收</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>m0</span>.<span style=color:#a6e22e>p</span> = <span style=color:#a6e22e>allp</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>allp</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>m</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m0</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mcommoninit</span>(<span style=color:#a6e22e>mp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>m</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// g0 stack won&#39;t make sense for user (and is not necessary unwindable).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>g0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>callers</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>createstack</span>[:])
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> &lt; <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: thread ID overflow&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>checkmcount</span>() <span style=color:#75715e>//检查m的个数是否超过sched.maxmcoun
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Add to allm so garbage collector doesn&#39;t free g-&gt;m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// when it is just in a register or thread-local storage.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>alllink</span> = <span style=color:#a6e22e>allm</span> <span style=color:#75715e>//m放入全局链表allm, 防止垃圾回收
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// NumCgoCall() iterates over allm w/o schedlock,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// so we need to publish it safely.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>atomicstorep</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allm</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>mp</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>我们继续回到前面看下一个函数.</p><h5 id=procresize>procresize
<a class=anchor href=#procresize>#</a></h5><p><a href=https://github.com/golang/go/blob/5c2c6d3fbf4f0a1299b5e41463847d242eae19ca/src/runtime/proc.go#L4319>procresize</a>函数,主要初始化allp, m0和allp[0]绑定,初始化后,用户代码还可用<code>GOMAXPROCS()</code>函数,调用它来再次创建和初始化p结构体对象，先看初始化代码.</p><ul><li>使用<code>make([]*p, nprocs)</code>初始化全局变量<code>allp</code>，把旧的allp拷贝到新的nallp里面,然后<code>allp = make([]*p, nprocs)</code></li><li>循环<code>allp</code>中的每个p,如果是nill的就进行创建, 然后每个都初始化,不管是新的还是旧的.</li><li>把<code>m0</code>和<code>allp[0]</code>绑定在一起，即<code>m0.p = allp[0], allp[0].m = m0</code></li><li>把除了<code>allp[0]</code>之外的所有<code>p</code>放入到全局变量<code>sched</code>的<code>pidle</code>空闲队列之中</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>procresize</span>(<span style=color:#a6e22e>nprocs</span> <span style=color:#66d9ef>int32</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>old</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gomaxprocs</span> <span style=color:#75715e>//系统初始化时 gomaxprocs = 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span> &lt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>nprocs</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;procresize: invalid arg&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grow allp if necessary.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nprocs</span> &gt; int32(len(<span style=color:#a6e22e>allp</span>)) { <span style=color:#75715e>//初始化时 len(allp) == 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Synchronize with retake, which could be running
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// concurrently since it doesn&#39;t run on a P.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allpLock</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nprocs</span> <span style=color:#f92672>&lt;=</span> int32(cap(<span style=color:#a6e22e>allp</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>allp</span> = <span style=color:#a6e22e>allp</span>[:<span style=color:#a6e22e>nprocs</span>]
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>//初始化时进入此分支，创建allp 切片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>nallp</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>nprocs</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Copy everything up to allp&#39;s cap so we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// never lose old allocated Ps.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            copy(<span style=color:#a6e22e>nallp</span>, <span style=color:#a6e22e>allp</span>[:cap(<span style=color:#a6e22e>allp</span>)]) <span style=color:#75715e>//把旧的allp拷贝到新的nallp里面
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>allp</span> = <span style=color:#a6e22e>nallp</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allpLock</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// initialize new P&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>old</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>nprocs</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span> = new(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>i</span>) <span style=color:#75715e>//每个p然后进行初始化 旧的也需要重新进行初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>atomicstorep</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>pp</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()  <span style=color:#75715e>// _g_ = g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>id</span> &lt; <span style=color:#a6e22e>nprocs</span> {<span style=color:#75715e>//初始化时m0-&gt;p还未初始化，所以不会执行这个分支
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// continue to use the current P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Prunning</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>mcache</span>.<span style=color:#a6e22e>prepareForSweep</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {<span style=color:#75715e>//初始化时执行这个分支
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// release the current P and acquire allp[0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {<span style=color:#75715e>//初始化时这里不执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>m</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>mcache</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pidle</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>acquirep</span>(<span style=color:#a6e22e>p</span>) <span style=color:#75715e>// --&gt; Associate p and the current m; 在初始化的时候就是把p和m0关联起来,其实是这两个strct的成员相互赋值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>traceGoStart</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// release resources from unused P&#39;s --&gt; zxc 就是释放多余的P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nprocs</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>old</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>destroy</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// TODO zxc can&#39;t free P itself because it can be referenced by an M in syscall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//下面这个for 循环把所有空闲的p放入空闲链表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>runnablePs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nprocs</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>p</span> {<span style=color:#75715e>//不放allp[0],因为它跟m0在上面已经关联了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pidle</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>runqempty</span>(<span style=color:#a6e22e>p</span>) {<span style=color:#75715e>//初始化时除了allp[0]其它p全部执行这个分支，放入空闲链表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>pidleput</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>runnablePs</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220623175954.png alt=内存关系图></p><h3 id=创建main-goroutine>创建main goroutine
<a class=anchor href=#%e5%88%9b%e5%bb%bamain-goroutine>#</a></h3><p>我们继续下面的
<a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/asm_amd64.s#L87>runtime·rt0_go</a>函数.</p><p>创建运行<code>runtime·mainPC</code>函数的goroutine</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>	<span style=color:#75715e># create a new goroutine to start program
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#66d9ef>mainPC</span>(<span style=color:#66d9ef>SB</span>), <span style=color:#66d9ef>AX</span> <span style=color:#75715e># entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>PUSHQ</span>	<span style=color:#66d9ef>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PUSHQ</span>	<span style=color:#66d9ef>$0</span> <span style=color:#75715e># arg size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>CALL</span>	<span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#66d9ef>newproc</span>(<span style=color:#66d9ef>SB</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>POPQ</span>	<span style=color:#66d9ef>AX</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200909112003.png alt="main goroutine,第一条指令"></p><h4 id=newproc>newproc
<a class=anchor href=#newproc>#</a></h4><p><a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/proc.go#L3528>newproc; src/runtime/proc.go</a>创建一个新的g(执行参数fn，参数为siz字节),把g放在等待运行的g的队列(<strong>全局g队列</strong>,参见前文查看全局G队列)中。编译器把go语句变成了对它的调用。因为它假定参数在&fn之后,方便可以按顺序使用,所以不能拆分堆栈，如果发生拆分,参数将不会被复制.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Create a new g running fn with siz bytes of arguments.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Put it on the queue of g&#39;s waiting to run.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The compiler turns a go statement into a call to this.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Cannot split the stack because it assumes that the arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e>// are available sequentially after &amp;fn; they would not be
</span></span></span><span style=display:flex><span><span style=color:#75715e>// copied if a stack split occurred.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:nosplit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newproc</span>(<span style=color:#a6e22e>siz</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>fn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>funcval</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>argp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>fn</span>), <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>PtrSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getcallerpc</span>() <span style=color:#75715e>//getcallerpc:返回其调用者的程序计数器（PC）---getcallersp返回其调用者的堆栈指针（SP）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {  <span style=color:#75715e>// systemstack 切到g0的栈和CPU寄存器去执行, 执行完了, 再切换原来的栈和CPU寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>newproc1</span>(<span style=color:#a6e22e>fn</span>, (<span style=color:#f92672>*</span><span style=color:#66d9ef>uint8</span>)(<span style=color:#a6e22e>argp</span>), <span style=color:#a6e22e>siz</span>, <span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>pc</span>) 
</span></span><span style=display:flex><span>		 <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 创建一个新的g运行的fn，参数的字节数从argp开始; 
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 siz: 参数的大小
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 callergp: 调用者的goroutine pointer[caller-callee]
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 callerpc: 调用者的程序计数器
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 */</span> 
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a new g running fn with narg bytes of arguments starting
</span></span></span><span style=display:flex><span><span style=color:#75715e>// at argp. callerpc is the address of the go statement that created
</span></span></span><span style=display:flex><span><span style=color:#75715e>// this. The new g is put on the queue of g&#39;s waiting to run.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newproc1</span>(<span style=color:#a6e22e>fn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>funcval</span>, <span style=color:#a6e22e>argp</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint8</span>, <span style=color:#a6e22e>narg</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>callergp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>callerpc</span> <span style=color:#66d9ef>uintptr</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fn</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>throwing</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>// do not dump full stacks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;go of nil func value&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>acquirem</span>() <span style=color:#75715e>// disable preemption because it can be holding p in a local var // TODO zxc 禁止抢占
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>siz</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>narg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>siz</span> = (<span style=color:#a6e22e>siz</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span>) <span style=color:#f92672>&amp;^</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// We could allocate a larger initial stack if necessary.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Not worth it: this is almost always an error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 4*sizeof(uintreg): extra space added below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// sizeof(uintreg): caller&#39;s LR (arm) or return address (x86, in gostartcall).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>siz</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>_StackMin</span><span style=color:#f92672>-</span><span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>RegSize</span><span style=color:#f92672>-</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>RegSize</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;newproc: function arguments too large for new goroutine&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_p_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>() <span style=color:#75715e>// 的到m上的p,在这里就是allp[0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>newg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gfget</span>(<span style=color:#a6e22e>_p_</span>) <span style=color:#75715e>// 从本地或者全局队列尝试获取g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {<span style=color:#75715e>// 如果获取失败就构造一个g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>newg</span> = <span style=color:#a6e22e>malg</span>(<span style=color:#a6e22e>_StackMin</span>) <span style=color:#75715e>// 跳转到g0的栈,然后再堆上分配,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>newg</span>, <span style=color:#a6e22e>_Gidle</span>, <span style=color:#a6e22e>_Gdead</span>) <span style=color:#75715e>//_Gidle=iota //0 新创建的默认是0,所以就是idle;修改状态为Gdead,这样gc就是扫描newg上面的栈,来尝试要不要回收.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>allgadd</span>(<span style=color:#a6e22e>newg</span>) <span style=color:#75715e>// publishes with a g-&gt;status of Gdead so GC scanner doesn&#39;t look at uninitialized stack. 这里的把生成的g放入全局allgs []*g//保存所有的g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220623184236.png alt=为main函数创建一个新的goroutine></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;newproc1: newg missing stack&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>readgstatus</span>(<span style=color:#a6e22e>newg</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_Gdead</span> { <span style=color:#75715e>//不是Gdead就panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;newproc1: new g is not Gdead&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>totalSize</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>RegSize</span> <span style=color:#f92672>+</span> uintptr(<span style=color:#a6e22e>siz</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>MinFrameSize</span> <span style=color:#75715e>// extra space in case of reads slightly beyond frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>totalSize</span> <span style=color:#f92672>+=</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>totalSize</span> <span style=color:#f92672>&amp;</span> (<span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>SpAlign</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)                  <span style=color:#75715e>// align to spAlign
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>totalSize</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>spArg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>usesLR</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// caller&#39;s LR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>*</span>(<span style=color:#f92672>*</span><span style=color:#66d9ef>uintptr</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sp</span>)) = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prepGoExitFrame</span>(<span style=color:#a6e22e>sp</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>spArg</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>MinFrameSize</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>narg</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//memmove copies n bytes from &#34;from&#34; to &#34;to&#34;,把在调用者的栈上的,callee
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>memmove</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>spArg</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>argp</span>), uintptr(<span style=color:#a6e22e>narg</span>))
</span></span><span style=display:flex><span>		<span style=color:#75715e>// This is a stack-to-stack copy. If write barriers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// are enabled and the source stack is grey (the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// destination is always black), then perform a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// barrier copy. We do this *after* the memmove
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// because the destination stack may have garbage on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>writeBarrier</span>.<span style=color:#a6e22e>needed</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span>.<span style=color:#a6e22e>gcscandone</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findfunc</span>(<span style=color:#a6e22e>fn</span>.<span style=color:#a6e22e>fn</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>stkmap</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>stackmap</span>)(<span style=color:#a6e22e>funcdata</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>_FUNCDATA_ArgsPointerMaps</span>))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stkmap</span>.<span style=color:#a6e22e>nbit</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// We&#39;re in the prologue, so it&#39;s always stack map index 0.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>bv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stackmapdata</span>(<span style=color:#a6e22e>stkmap</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>bulkBarrierBitmap</span>(<span style=color:#a6e22e>spArg</span>, <span style=color:#a6e22e>spArg</span>, uintptr(<span style=color:#a6e22e>bv</span>.<span style=color:#a6e22e>n</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>PtrSize</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>bv</span>.<span style=color:#a6e22e>bytedata</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memclrNoHeapPointers</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>)) <span style=color:#75715e>//newg.sched 空间置零
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sp</span> = <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>stktopsp</span> = <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>pc</span> = <span style=color:#a6e22e>funcPC</span>(<span style=color:#a6e22e>goexit</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>PCQuantum</span> <span style=color:#75715e>// +PCQuantum=1 so that previous instruction is in same function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>guintptr</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>newg</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gostartcallfn</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>, <span style=color:#a6e22e>fn</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*      这个函数
</span></span></span><span style=display:flex><span><span style=color:#75715e>			    1. 调整newg的栈空间，把goexit函数的第二条指令的地址入栈，伪造成goexit函数调用了fn，
</span></span></span><span style=display:flex><span><span style=color:#75715e>			        从而使fn执行完成后执行ret指令时返回到goexit继续执行完成最后的清理工作；
</span></span></span><span style=display:flex><span><span style=color:#75715e>			    2. 重新设置newg.buf.pc 为需要执行的函数的地址，即fn，我们这个场景为runtime.main函数的地址。
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// adjust Gobuf as if it executed a call to fn
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// and then did an immediate gosave.
</span></span></span><span style=display:flex><span><span style=color:#75715e>			func gostartcallfn(gobuf *gobuf, fv *funcval) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>				var fn unsafe.Pointer
</span></span></span><span style=display:flex><span><span style=color:#75715e>				if fv != nil {
</span></span></span><span style=display:flex><span><span style=color:#75715e>					fn = unsafe.Pointer(fv.fn)
</span></span></span><span style=display:flex><span><span style=color:#75715e>				} else {
</span></span></span><span style=display:flex><span><span style=color:#75715e>					fn = unsafe.Pointer(funcPC(nilfunc))
</span></span></span><span style=display:flex><span><span style=color:#75715e>				}
</span></span></span><span style=display:flex><span><span style=color:#75715e>				gostartcall(gobuf, fn, unsafe.Pointer(fv))
</span></span></span><span style=display:flex><span><span style=color:#75715e>			}
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// adjust Gobuf as if it executed a call to fn with context ctxt
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// and then did an immediate gosave.
</span></span></span><span style=display:flex><span><span style=color:#75715e>			func gostartcall(buf *gobuf, fn, ctxt unsafe.Pointer) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>				sp := buf.sp
</span></span></span><span style=display:flex><span><span style=color:#75715e>				if sys.RegSize &gt; sys.PtrSize {
</span></span></span><span style=display:flex><span><span style=color:#75715e>					sp -= sys.PtrSize
</span></span></span><span style=display:flex><span><span style=color:#75715e>					*(*uintptr)(unsafe.Pointer(sp)) = 0
</span></span></span><span style=display:flex><span><span style=color:#75715e>				}
</span></span></span><span style=display:flex><span><span style=color:#75715e>				sp -= sys.PtrSize
</span></span></span><span style=display:flex><span><span style=color:#75715e>				*(*uintptr)(unsafe.Pointer(sp)) = buf.pc
</span></span></span><span style=display:flex><span><span style=color:#75715e>				buf.sp = sp
</span></span></span><span style=display:flex><span><span style=color:#75715e>				buf.pc = uintptr(fn)
</span></span></span><span style=display:flex><span><span style=color:#75715e>				buf.ctxt = ctxt
</span></span></span><span style=display:flex><span><span style=color:#75715e>			}
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>gopc</span> = <span style=color:#a6e22e>callerpc</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>ancestors</span> = <span style=color:#a6e22e>saveAncestors</span>(<span style=color:#a6e22e>callergp</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>startpc</span> = <span style=color:#a6e22e>fn</span>.<span style=color:#a6e22e>fn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>newg</span>, <span style=color:#a6e22e>_Gdead</span>, <span style=color:#a6e22e>_Grunnable</span>) <span style=color:#75715e>//修改goroutine状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcacheend</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Sched.goidgen is the last allocated id,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// this batch must be [sched.goidgen+1, sched.goidgen+GoidCacheBatch].
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// At startup sched.goidgen=0, so main goroutine receives goid=1.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> = <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>goidgen</span>, <span style=color:#a6e22e>_GoidCacheBatch</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>_GoidCacheBatch</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcacheend</span> = <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_GoidCacheBatch</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>goid</span> = int64(<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>racectx</span> = <span style=color:#a6e22e>racegostart</span>(<span style=color:#a6e22e>callerpc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>traceGoCreate</span>(<span style=color:#a6e22e>newg</span>, <span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>startpc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runqput</span>(<span style=color:#a6e22e>_p_</span>, <span style=color:#a6e22e>newg</span>, <span style=color:#66d9ef>true</span>) <span style=color:#75715e>//放入本地队列， 或者全局队列  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>npidle</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>nmspinning</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>mainStarted</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wakep</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>} <span style=color:#75715e>//end newproc1 function
</span></span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220623190347.png alt=模拟exit调用main函数></p><hr><h5 id=rbp这个寄存器的值还有用>rbp这个寄存器的值还有用?
<a class=anchor href=#rbp%e8%bf%99%e4%b8%aa%e5%af%84%e5%ad%98%e5%99%a8%e7%9a%84%e5%80%bc%e8%bf%98%e6%9c%89%e7%94%a8>#</a></h5><p>从上面的图中都没有说rbp这个寄存器,它不会保存到新创建的g内的<code>sched.bp</code>字段, 当重新调度这个g,重新观察BP寄存器这一章中我们会看到里面是空的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>g</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stack</span>       <span style=color:#a6e22e>stack</span>   <span style=color:#75715e>// offset known to runtime/cgo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stackguard0</span> <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stackguard1</span> <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_panic</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>_panic</span> <span style=color:#75715e>// innermost panic - offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_defer</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>_defer</span> <span style=color:#75715e>// innermost defer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>m</span>              <span style=color:#f92672>*</span><span style=color:#a6e22e>m</span>      <span style=color:#75715e>// current m; offset known to arm liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sched</span>          <span style=color:#a6e22e>gobuf</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>gobuf</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sp</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>    <span style=color:#a6e22e>guintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctxt</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ret</span>  <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>Uintreg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lr</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bp</span>   <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// for GOEXPERIMENT=framepointer   ------------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><hr><h2 id=开始m>开始M
<a class=anchor href=#%e5%bc%80%e5%a7%8bm>#</a></h2><p>我们继续下面的
<a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/asm_amd64.s#L87>runtime·rt0_go</a>函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// start this M
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>mstart</span>(<span style=color:#a6e22e>SB</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>abort</span>(<span style=color:#a6e22e>SB</span>)	<span style=color:#75715e>// mstart should never return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>RET</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Prevent dead-code elimination of debugCallV1, which is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// intended to be called by debuggers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>debugCallV1</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><h3 id=mstart>mstart
<a class=anchor href=#mstart>#</a></h3><p>mstart 是一个新M切入点, 它主要是再检查下此M对应g0栈是否有创建,设置一下g0的stackguard0.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// mstart is the entry-point for new Ms.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This must not split the stack because we may not even have stack
</span></span></span><span style=display:flex><span><span style=color:#75715e>// bounds set up yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// May run during STW (because it doesn&#39;t have a P yet), so write
</span></span></span><span style=display:flex><span><span style=color:#75715e>// barriers are not allowed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:nosplit
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:nowritebarrierrec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mstart</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()  <span style=color:#75715e>// g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>osStack</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*  ? linux的话， 从runtime·rt0_go我们知道，g0的stack.lo,不是为0的.
</span></span></span><span style=display:flex><span><span style=color:#75715e>		// create istack out of the given (operating system) stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e>		// _cgo_init may update stackguard.
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	$runtime·g0(SB), DI
</span></span></span><span style=display:flex><span><span style=color:#75715e>		LEAQ	(-64*1024+104)(SP), BX
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	BX, g_stackguard0(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	BX, g_stackguard1(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	BX, (g_stack+stack_lo)(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	SP, (g_stack+stack_hi)(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>osStack</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Initialize stack bounds from system stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Cgo may have left stack size in stack.hi.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// minit may update the stack bounds.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>size</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>size</span> = <span style=color:#ae81ff>8192</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>StackGuardMultiplier</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> = uintptr(<span style=color:#a6e22e>noescape</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>size</span>)))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Initialize stack guard so that we can start calling regular
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Go code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_StackGuard</span>  <span style=color:#75715e>//这个stackguard0比stack.lo大，防止越界
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// This is the g0, so we can also call go:systemstack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// functions, which check stackguard1.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard1</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span> <span style=color:#75715e>//stackguard1的作用是栈溢出检查，如果是stackguard0与stackguard1相等，那么是不能放数据到g0栈中了吗
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit this thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;windows&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;solaris&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;illumos&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;plan9&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;darwin&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;aix&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// the stack, but put it in _g_.stack before mstart,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// so the logic above hasn&#39;t set osStack yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>osStack</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mexit</span>(<span style=color:#a6e22e>osStack</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=mstart1>mstart1
<a class=anchor href=#mstart1>#</a></h3><p>重置一下g0的pc/sp为caller的pc/sp, 而mstart1的caller就是mstart</p><p>记录调用者，以便在mcall中作为堆栈顶部使用，并用于终止线程。 我们在调用schedule之后就不会再回到mstart1，所以其他调用可以重复使用当前的帧。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mstart1</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()   <span style=color:#75715e>//g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>g0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;bad runtime·mstart&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Record the caller for use as the top of stack in mcall and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// for terminating the thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// We&#39;re never coming back to mstart1 after we call schedule,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// so other calls can reuse the current frame.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>getcallerpc</span>(), <span style=color:#a6e22e>getcallersp</span>()) <span style=color:#75715e>//就是把pc, sp保存到自己的sched里面， 但是bp寄存器没有保存，因为会重新使用这个栈？
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	这里不是当前的, 因为后面调用schedule函数后，还会再回到mstart1函数,但是永远不会进入到mstart函数
</span></span></span><span style=display:flex><span><span style=color:#75715e>		getcallerpc()返回的是mstart调用mstart1时被call指令压栈的返回地址， bp+1 ?
</span></span></span><span style=display:flex><span><span style=color:#75715e>		getcallersp()函数返回的是调用mstart1函数之前mstart函数的栈顶地址    bp ?
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>asminit</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>minit</span>() <span style=color:#75715e>//初始化信号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Install signal handlers; after minit so that minit can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// prepare the thread to be able to handle the signals.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 安装信号处理程序;所以minit可以准备线程以便能够处理信号, 在minit之后执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mstartm0</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>mstartfn</span>; <span style=color:#a6e22e>fn</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {   <span style=color:#75715e>//如果m的mstartfn不是空的，先执行它
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m0</span> { <span style=color:#75715e>// 如果m不等于m0  就是m0的话,前面m0和allp[0]已经绑定了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>acquirep</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nextp</span>.<span style=color:#a6e22e>ptr</span>()) <span style=color:#75715e>//TODO zxc 这个acquirep函数是把m和m.nextp进行绑定,如果到这里的时候,nextp已经状态不是空闲的状态,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		                            <span style=color:#75715e>//那么会抛出错误?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nextp</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>schedule</span>() <span style=color:#75715e>//进入调度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220623194734.png alt=20220623194734></p><h3 id=保存pcsp到g0>保存pc,sp到g0
<a class=anchor href=#%e4%bf%9d%e5%ad%98pcsp%e5%88%b0g0>#</a></h3><p>save函数保存pc,sp到g0,方便下次再度调度运行g0</p><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><ul><li>list /usr/lib/golang/src/runtime/proc.go:1167</li><li>list /usr/lib/golang/src/runtime/proc.go:1179</li><li>list /usr/lib/golang/src/runtime/proc.go:1190</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>[<span style=color:#a6e22e>root</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>gitlab</span> <span style=color:#a6e22e>kubernets</span>]<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>gdb</span> <span style=color:#a6e22e>test</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>GNU</span> <span style=color:#a6e22e>gdb</span> (<span style=color:#a6e22e>GDB</span>) <span style=color:#a6e22e>Red</span> <span style=color:#a6e22e>Hat</span> <span style=color:#a6e22e>Enterprise</span> <span style=color:#a6e22e>Linux</span> <span style=color:#ae81ff>7.6.1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>119.</span><span style=color:#a6e22e>el7</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Copyright</span> (<span style=color:#a6e22e>C</span>) <span style=color:#ae81ff>2013</span> <span style=color:#a6e22e>Free</span> <span style=color:#a6e22e>Software</span> <span style=color:#a6e22e>Foundation</span>, <span style=color:#a6e22e>Inc</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>License</span> <span style=color:#a6e22e>GPLv3</span><span style=color:#f92672>+</span>: <span style=color:#a6e22e>GNU</span> <span style=color:#a6e22e>GPL</span> <span style=color:#a6e22e>version</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>later</span> &lt;<span style=color:#a6e22e>http</span>:<span style=color:#75715e>//gnu.org/licenses/gpl.html&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>This</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>free</span> <span style=color:#a6e22e>software</span>: <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>free</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>change</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>redistribute</span> <span style=color:#a6e22e>it</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>There</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>NO</span> <span style=color:#a6e22e>WARRANTY</span>, <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>extent</span> <span style=color:#a6e22e>permitted</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>law</span>.  <span style=color:#a6e22e>Type</span> <span style=color:#e6db74>&#34;show copying&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>and</span> <span style=color:#e6db74>&#34;show warranty&#34;</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>details</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>This</span> <span style=color:#a6e22e>GDB</span> <span style=color:#a6e22e>was</span> <span style=color:#a6e22e>configured</span> <span style=color:#a6e22e>as</span> <span style=color:#e6db74>&#34;x86_64-redhat-linux-gnu&#34;</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>For</span> <span style=color:#a6e22e>bug</span> <span style=color:#a6e22e>reporting</span> <span style=color:#a6e22e>instructions</span>, <span style=color:#a6e22e>please</span> <span style=color:#a6e22e>see</span>:
</span></span><span style=display:flex><span>&lt;<span style=color:#a6e22e>http</span>:<span style=color:#75715e>//www.gnu.org/software/gdb/bugs/&gt;...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>Reading</span> <span style=color:#a6e22e>symbols</span> <span style=color:#a6e22e>from</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>tmp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>kubernets</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span><span style=color:#f92672>...</span><span style=color:#a6e22e>done</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>Loading</span> <span style=color:#a6e22e>Go</span> <span style=color:#a6e22e>Runtime</span> <span style=color:#a6e22e>support</span>.
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1162</span>		<span style=color:#75715e>// Go code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1163</span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_StackGuard</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1164</span>		<span style=color:#75715e>// This is the g0, so we can also call go:systemstack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1165</span>		<span style=color:#75715e>// functions, which check stackguard1.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1166</span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard1</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1167</span>		<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>1168</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1169</span>		<span style=color:#75715e>// Exit this thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1170</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;windows&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;solaris&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;illumos&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;plan9&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;darwin&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;aix&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#ae81ff>1171</span>			<span style=color:#75715e>// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>b</span> <span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x42dd09</span>: <span style=color:#a6e22e>file</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>, <span style=color:#a6e22e>line</span> <span style=color:#ae81ff>1167.</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1174</span>			<span style=color:#a6e22e>osStack</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1175</span>		}
</span></span><span style=display:flex><span><span style=color:#ae81ff>1176</span>		<span style=color:#a6e22e>mexit</span>(<span style=color:#a6e22e>osStack</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>1177</span>	}
</span></span><span style=display:flex><span><span style=color:#ae81ff>1178</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1179</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mstart1</span>() {
</span></span><span style=display:flex><span><span style=color:#ae81ff>1180</span>		<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>1181</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1182</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>g0</span> {
</span></span><span style=display:flex><span><span style=color:#ae81ff>1183</span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;bad runtime·mstart&#34;</span>)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>b</span> <span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>2</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x42dd30</span>: <span style=color:#a6e22e>file</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>, <span style=color:#a6e22e>line</span> <span style=color:#ae81ff>1179.</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1190</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1185</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1186</span>		<span style=color:#75715e>// Record the caller for use as the top of stack in mcall and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1187</span>		<span style=color:#75715e>// for terminating the thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1188</span>		<span style=color:#75715e>// We&#39;re never coming back to mstart1 after we call schedule,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1189</span>		<span style=color:#75715e>// so other calls can reuse the current frame.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1190</span>		<span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>getcallerpc</span>(), <span style=color:#a6e22e>getcallersp</span>())
</span></span><span style=display:flex><span><span style=color:#ae81ff>1191</span>		<span style=color:#a6e22e>asminit</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>1192</span>		<span style=color:#a6e22e>minit</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>1193</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1194</span>		<span style=color:#75715e>// Install signal handlers; after minit so that minit can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>b</span> <span style=color:#ae81ff>1190</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x42dd7f</span>: <span style=color:#a6e22e>file</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>, <span style=color:#a6e22e>line</span> <span style=color:#ae81ff>1190.</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>breakpoint</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Num</span>     <span style=color:#a6e22e>Type</span>           <span style=color:#a6e22e>Disp</span> <span style=color:#a6e22e>Enb</span> <span style=color:#a6e22e>Address</span>            <span style=color:#a6e22e>What</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>y</span>   <span style=color:#ae81ff>0x000000000042dd09</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart</span> <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>y</span>   <span style=color:#ae81ff>0x000000000042dd30</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span> <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>y</span>   <span style=color:#ae81ff>0x000000000042dd7f</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span> <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1190</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Starting</span> <span style=color:#a6e22e>program</span>: <span style=color:#f92672>/</span><span style=color:#a6e22e>tmp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>kubernets</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1167</span>		<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1162</span>		<span style=color:#75715e>// Go code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1163</span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_StackGuard</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1164</span>		<span style=color:#75715e>// This is the g0, so we can also call go:systemstack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1165</span>		<span style=color:#75715e>// functions, which check stackguard1.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1166</span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard1</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1167</span>		<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>1168</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1169</span>		<span style=color:#75715e>// Exit this thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1170</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;windows&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;solaris&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;illumos&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;plan9&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;darwin&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;aix&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#ae81ff>1171</span>			<span style=color:#75715e>// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>register</span> <span style=color:#a6e22e>rbp</span> <span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>pc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x7fffffffe490</span>	<span style=color:#ae81ff>0x7fffffffe490</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0x7fffffffe478</span>	<span style=color:#ae81ff>0x7fffffffe478</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x42dd09</span>	<span style=color:#ae81ff>0x42dd09</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart</span><span style=color:#f92672>+</span><span style=color:#ae81ff>105</span>&gt;
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Continuing</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1179</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mstart1</span>() {
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>register</span> <span style=color:#a6e22e>rbp</span> <span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>pc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x7fffffffe490</span>	<span style=color:#ae81ff>0x7fffffffe490</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0x7fffffffe470</span>	<span style=color:#ae81ff>0x7fffffffe470</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x42dd30</span>	<span style=color:#ae81ff>0x42dd30</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span>&gt;
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>x</span><span style=color:#f92672>/</span><span style=color:#ae81ff>8</span><span style=color:#a6e22e>xb</span> <span style=color:#ae81ff>0x7fffffffe470</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x7fffffffe470</span>:	<span style=color:#ae81ff>0x0e</span>	<span style=color:#ae81ff>0xdd</span>	<span style=color:#ae81ff>0x42</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>frame</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Stack</span> <span style=color:#a6e22e>frame</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x7fffffffe478</span>:
</span></span><span style=display:flex><span> <span style=color:#a6e22e>rip</span> = <span style=color:#ae81ff>0x42dd30</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span> (<span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>1179</span>); <span style=color:#a6e22e>saved</span> <span style=color:#a6e22e>rip</span> <span style=color:#ae81ff>0x42dd0e</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>called</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>frame</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x7fffffffe4a0</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>source</span> <span style=color:#a6e22e>language</span> <span style=color:#a6e22e>unknown</span>.
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Arglist</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x7fffffffe468</span>, <span style=color:#a6e22e>args</span>:
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Locals</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x7fffffffe468</span>, <span style=color:#a6e22e>Previous</span> <span style=color:#a6e22e>frame</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>sp</span> <span style=color:#a6e22e>is</span> <span style=color:#ae81ff>0x7fffffffe478</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Saved</span> <span style=color:#a6e22e>registers</span>:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rip</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x7fffffffe470</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>)
</span></span></code></pre></div></div></label></div><h4 id=反汇编看下mstart1到save函数的汇编代码>反汇编看下mstart1到save函数的汇编代码
<a class=anchor href=#%e5%8f%8d%e6%b1%87%e7%bc%96%e7%9c%8b%e4%b8%8bmstart1%e5%88%b0save%e5%87%bd%e6%95%b0%e7%9a%84%e6%b1%87%e7%bc%96%e4%bb%a3%e7%a0%81>#</a></h4><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>disass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Dump</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>assembler</span> <span style=color:#a6e22e>code</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span>:
</span></span><span style=display:flex><span>=&gt; <span style=color:#ae81ff>0x000000000042dd30</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span> <span style=color:#75715e>// rcx = &amp;g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd39</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>9</span>&gt;:	<span style=color:#a6e22e>cmp</span>    <span style=color:#ae81ff>0x10</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>             <span style=color:#75715e>// g0.stackguard0与rsp(0x7fffffffe470)判断是否达到栈顶部
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd3d</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>13</span>&gt;:	<span style=color:#a6e22e>jbe</span>    <span style=color:#ae81ff>0x42de2e</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span><span style=color:#f92672>+</span><span style=color:#ae81ff>254</span>&gt;  <span style=color:#75715e>// jump below equal &lt;=, 就panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd43</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>19</span>&gt;:	<span style=color:#a6e22e>sub</span>    <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x20</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span> <span style=color:#75715e>// rsp=0x7fffffffe470-0x20=0x7fffffffe450
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd47</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>23</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>,<span style=color:#ae81ff>0x18</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>) <span style=color:#75715e>//rsp(0x7fffffffe450)+0x18 = rbp ==&gt; caller&#39;s栈底(rbp)入callee的栈
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 (gdb) x/8xb 0x7fffffffe468
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe468:	0x90	0xe4	0xff	0xff	0xff	0x7f	0x00	0x00 
</span></span></span><span style=display:flex><span><span style=color:#75715e>		从前面 info register rbp rsp pc返回可以看到,就是rbp的值
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042dd4c</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>28</span>&gt;:	<span style=color:#a6e22e>lea</span>    <span style=color:#ae81ff>0x18</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span> <span style=color:#75715e>//取地址不取引用,得到rbp=0x7fffffffe468; 所以callee[mstart1函数]新的栈底rbp就指向这
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 (gdb) info register rbp
</span></span></span><span style=display:flex><span><span style=color:#75715e>		rbp            0x7fffffffe468	0x7fffffffe468
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042dd51</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>33</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span> <span style=color:#75715e>// rax = &amp;g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd5a</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>42</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x30</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span> <span style=color:#75715e>//rcx = g0.m.g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd5e</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>46</span>&gt;:	<span style=color:#a6e22e>cmp</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,(<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>)     <span style=color:#75715e>// g0是否与g0.m.g0相等
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd61</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>49</span>&gt;:	<span style=color:#a6e22e>jne</span>    <span style=color:#ae81ff>0x42de14</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mstart1</span><span style=color:#f92672>+</span><span style=color:#ae81ff>228</span>&gt; <span style=color:#75715e>//跳转到...如果不等于
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd67</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>55</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,<span style=color:#ae81ff>0x10</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>) <span style=color:#75715e>// rsp(0x7fffffffe450)+0x10 = 0x7fffffffe460的地方保存g0的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042dd6c</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>60</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x20</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span> <span style=color:#75715e>//rsp(0x7fffffffe450)+0x20 = 0x7fffffffe470的地址内容放到rax //这里就是caller&#39;s pc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd71</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>65</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>) <span style=color:#75715e>//所以从下面可以看出0x7fffffffe470与0x7fffffffe450内容是一样的都是caller&#39;s pc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd75</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>69</span>&gt;:	<span style=color:#a6e22e>lea</span>    <span style=color:#ae81ff>0x28</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span> <span style=color:#75715e>//rsp(0x7fffffffe450)+0x28 = 0x7fffffffe478这个值,不是里面的值放到rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042dd7a</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>74</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,<span style=color:#ae81ff>0x8</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>) <span style=color:#75715e>//rsp(0x7fffffffe450)+0x8 = 0x7fffffffe458 ==&gt;所以这个go语言里面的sp是从自调用返回后,sp里的值,它不包括caller调用callee的时候,call指令临时保存的pc,所以地址是0x7fffffffe478而不是0x7fffffffe470
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 (gdb) info register rsp
</span></span></span><span style=display:flex><span><span style=color:#75715e>		rsp            0x7fffffffe450	0x7fffffffe450
</span></span></span><span style=display:flex><span><span style=color:#75715e>		(gdb) x/64xb 0x7fffffffe450
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe450:	0x0e	0xdd	0x42	0x00	0x00	0x00	0x00	0x00 //caller&#39;s pc
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe458:	0x78	0xe4	0xff	0xff	0xff	0x7f	0x00	0x00 //caller&#39;s sp
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe460:	0xc0	0xda	0x55	0x00	0x00	0x00	0x00	0x00 //局部变量_g_也就是全局变量g0的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe468:	0x90	0xe4	0xff	0xff	0xff	0x7f	0x00	0x00 // caller&#39;s rbp
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe470:	0x0e	0xdd	0x42	0x00	0x00	0x00	0x00	0x00 // caller&#39;s pc
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe478:	0x74	0x15	0x45	0x00	0x00	0x00	0x00	0x00
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe480:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
</span></span></span><span style=display:flex><span><span style=color:#75715e>		0x7fffffffe488:	0x08	0xe5	0xfe	0xff	0xff	0x7f	0x00	0x00 
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042dd7f</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>79</span>&gt;:	<span style=color:#a6e22e>callq</span>  <span style=color:#ae81ff>0x431bd0</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>save</span>&gt; <span style=color:#75715e>// save(getcallerpc(), getcallersp())
</span></span></span></code></pre></div></div></label></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220623194006.png alt="gdb调试的时候发现,info frame中sp没有包括pc"></p><h3 id=schedule函数>schedule函数
<a class=anchor href=#schedule%e5%87%bd%e6%95%b0>#</a></h3><p>schedule函数:死循环的查找可运行的goroutine，然后执行它.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// One round of scheduler: find a runnable goroutine and execute it.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Never returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>schedule</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>() <span style=color:#75715e>// get g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>top</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>inheritTime</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Normal goroutines will check for need to wakeP in ready,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// but GCworkers and tracereaders will not, so the check must
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// be done here instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tryWakeP</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>//一般的goroutines会在准备好的时候检查是否需要wakeP。gcworker, tracereaders需要现在唤醒P.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>shutdown</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span> = <span style=color:#a6e22e>traceReader</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunnable</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>traceGoUnpark</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>tryWakeP</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>gcBlackenEnabled</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span> = <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>findRunnableGCWorker</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tryWakeP</span> = <span style=color:#a6e22e>tryWakeP</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Check the global runnable queue once in a while to ensure fairness.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Otherwise two goroutines can completely occupy the local runqueue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// by constantly respawning each other.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>schedtick</span><span style=color:#f92672>%</span><span style=color:#ae81ff>61</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>runqsize</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gp</span> = <span style=color:#a6e22e>globrunqget</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>(), <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>inheritTime</span> = <span style=color:#a6e22e>runqget</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>spinning</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;schedule: spinning with local work&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>inheritTime</span> = <span style=color:#a6e22e>findrunnable</span>() <span style=color:#75715e>// blocks until work is available
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This thread is going to run a goroutine and is not spinning anymore,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// so if it was marked as spinning we need to reset it now and potentially
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// start a new spinning M.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>spinning</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resetspinning</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>disable</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>schedEnabled</span>(<span style=color:#a6e22e>gp</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Scheduling of this goroutine is disabled. Put it on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// the list of pending runnable goroutines for when we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// re-enable user scheduling and look again.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>schedEnabled</span>(<span style=color:#a6e22e>gp</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Something re-enabled scheduling while we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// were acquiring the lock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>disable</span>.<span style=color:#a6e22e>runnable</span>.<span style=color:#a6e22e>pushBack</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>disable</span>.<span style=color:#a6e22e>n</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>top</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If about to schedule a not-normal goroutine (a GCworker or tracereader),
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// wake a P if there is one.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tryWakeP</span> { <span style=color:#75715e>//a GCworker or tracereader,需要唤醒P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>npidle</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>nmspinning</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wakep</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>inheritTime</span>) <span style=color:#75715e>// 执行G
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><ul><li><p>schedule()函数主要是获取一个Goroutine.</p><ul><li>调用<code>globrunqget()</code>和<code>runqget()</code>函数分别从全局运行队列和当前工作线程的本地运行队列中选取下一个需要运行的goroutine;</li><li>如果这两个队列都没有需要运行的goroutine则通过<code>findrunnable()</code>函数从其它p的运行队列中盗取goroutine.</li></ul></li><li><p>一旦找到下一个需要运行的goroutine，则调用excute函数从g0切换到该goroutine去运行.</p><ul><li>否则一直阻塞在findrunnable上面(<code>gp, inheritTime = findrunnable() // blocks until work is available</code>)</li></ul></li></ul><h3 id=execute函数>execute函数
<a class=anchor href=#execute%e5%87%bd%e6%95%b0>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Schedules gp to run on the current M.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// If inheritTime is true, gp inherits the remaining time in the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// current time slice. Otherwise, it starts a new time slice.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Never returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Write barriers are allowed because this is called immediately after
</span></span></span><span style=display:flex><span><span style=color:#75715e>// acquiring a P in several places.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:yeswritebarrierrec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>inheritTime</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>() <span style=color:#75715e>// g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Grunnable</span>, <span style=color:#a6e22e>_Grunning</span>) <span style=color:#75715e>//修改将要运行的gp的状态.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waitsince</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>preempt</span> = <span style=color:#66d9ef>false</span> <span style=color:#75715e>//抢占标志位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>stackguard0</span> = <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_StackGuard</span> <span style=color:#75715e>//设置栈顶的保护,比栈地址的最低位高点,防止栈越界
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>inheritTime</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>schedtick</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span> = <span style=color:#a6e22e>gp</span> <span style=color:#75715e>//这里就开始设置M的curg为gp,而不是g0了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>  <span style=color:#75715e>// m.curg = gp and gp.m = m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gogo</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>sched</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>execute函数主要为将要被调度运行的gorouine的g设置状态,与M相互关联</p><h3 id=gogo>gogo
<a class=anchor href=#gogo>#</a></h3><p>gogo把将要运行的main函数的goroutine从gobuf中取出到寄存器中,同时把gobuf清0,有助于垃圾回收.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># list /usr/lib/golang/src/runtime/proc.go:2165</span>
</span></span><span style=display:flex><span><span style=color:#75715e># gdb查看发现又到了asm_amd64.s文件</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> step
</span></span><span style=display:flex><span>runtime.gogo <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:272
</span></span><span style=display:flex><span>272	TEXT runtime·gogo<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>, NOSPLIT, $16-8
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> list
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#75715e># func gogo(buf *gobuf)
</span></span></span><span style=display:flex><span><span style=color:#75715e># restore state from Gobuf; longjmp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#66d9ef>gogo</span>(<span style=color:#66d9ef>SB</span>), <span style=color:#66d9ef>NOSPLIT</span>, <span style=color:#66d9ef>$16-8</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>buf</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0</span>(<span style=color:#66d9ef>FP</span>), <span style=color:#66d9ef>BX</span>		<span style=color:#75715e># gobuf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>MOVQ</span>	<span style=color:#66d9ef>gobuf_g</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#66d9ef>DX</span>), <span style=color:#66d9ef>CX</span>		<span style=color:#75715e># make sure g != nil //防止g.gobuf.g里面的值是空的,空的取地址会panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>get_tls</span>(<span style=color:#66d9ef>CX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>DX</span>, <span style=color:#66d9ef>g</span>(<span style=color:#66d9ef>CX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_sp</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>SP</span>	<span style=color:#75715e># restore SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>MOVQ</span>	<span style=color:#66d9ef>gobuf_ret</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_ctxt</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_bp</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_sp</span>(<span style=color:#66d9ef>BX</span>)	<span style=color:#75715e># clear to help garbage collector
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_ret</span>(<span style=color:#66d9ef>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_ctxt</span>(<span style=color:#66d9ef>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_bp</span>(<span style=color:#66d9ef>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_pc</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JMP</span>	<span style=color:#66d9ef>BX</span>
</span></span></code></pre></div><p><strong>从下面的跳转语句，可知它将跳到前面创建main goroutine时定义的(<code>runtime·mainPC(SB)</code>)函数中去了</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>    <span style=color:#75715e>#...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_pc</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JMP</span>	<span style=color:#66d9ef>BX</span>
</span></span></code></pre></div><h5 id=重新观察bp寄存器>重新观察BP寄存器
<a class=anchor href=#%e9%87%8d%e6%96%b0%e8%a7%82%e5%af%9fbp%e5%af%84%e5%ad%98%e5%99%a8>#</a></h5><blockquote><p>当调度这个main函数的goroutine,从g.sched中恢复的寄存器的值,其中恢复后BP寄存器的值就是0</p></blockquote><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>Expand</span>
<span>↕</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>breakpoints</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Num</span>     <span style=color:#a6e22e>Type</span>           <span style=color:#a6e22e>Disp</span> <span style=color:#a6e22e>Enb</span> <span style=color:#a6e22e>Address</span>            <span style=color:#a6e22e>What</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>y</span>   <span style=color:#ae81ff>0x000000000042fe3e</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>execute</span> <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>2171</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>breakpoint</span> <span style=color:#a6e22e>already</span> <span style=color:#a6e22e>hit</span> <span style=color:#ae81ff>1</span> <span style=color:#a6e22e>time</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>y</span>   <span style=color:#ae81ff>0x00000000004515ce</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>gogo</span> <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>281</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>y</span>   <span style=color:#ae81ff>0x00000000004515d2</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>gogo</span> <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>282</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>program</span> <span style=color:#a6e22e>being</span> <span style=color:#a6e22e>debugged</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>been</span> <span style=color:#a6e22e>started</span> <span style=color:#a6e22e>already</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>Start</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>beginning</span><span style=color:#960050;background-color:#1e0010>?</span> (<span style=color:#a6e22e>y</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>n</span>) <span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Starting</span> <span style=color:#a6e22e>program</span>: <span style=color:#f92672>/</span><span style=color:#a6e22e>tmp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>kubernets</span><span style=color:#f92672>/</span>.<span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>execute</span> (<span style=color:#a6e22e>gp</span>=<span style=color:#ae81ff>0xc000000300</span>, <span style=color:#a6e22e>inheritTime</span>=<span style=color:#66d9ef>true</span>) <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>2171</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2171</span>		<span style=color:#a6e22e>gogo</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>sched</span>)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Continuing</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>gogo</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>281</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>281</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_bp</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>BP</span> <span style=color:#75715e>//这里打了断点,观察下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>276</span>		<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>277</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DX</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>278</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_sp</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>SP</span>	<span style=color:#75715e>// restore SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>279</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_ret</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>280</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_ctxt</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>DX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>281</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_bp</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>BP</span>     <span style=color:#75715e>//这里打了断点,观察下  ------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>282</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_sp</span>(<span style=color:#a6e22e>BX</span>)	 <span style=color:#75715e>//这里打了断点,观察下  ------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>283</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_ret</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>284</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_ctxt</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>285</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_bp</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>register</span> <span style=color:#a6e22e>rbp</span> <span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>pc</span> <span style=color:#a6e22e>bp</span> <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x7fffffffe3c8</span>	<span style=color:#ae81ff>0x7fffffffe3c8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x4515ce</span>	<span style=color:#ae81ff>0x4515ce</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>gogo</span><span style=color:#f92672>+</span><span style=color:#ae81ff>46</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>bp</span>             <span style=color:#ae81ff>0xe3c8</span>	<span style=color:#f92672>-</span><span style=color:#ae81ff>7224</span> <span style=color:#75715e>//其值开始不是0  ------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>sp</span>             <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>step</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>gogo</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>282</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>282</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_sp</span>(<span style=color:#a6e22e>BX</span>)	<span style=color:#75715e>//这里打了断点,观察下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>register</span> <span style=color:#a6e22e>rbp</span> <span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>pc</span> <span style=color:#a6e22e>bp</span> <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x0</span>	<span style=color:#ae81ff>0x0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x4515d2</span>	<span style=color:#ae81ff>0x4515d2</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>gogo</span><span style=color:#f92672>+</span><span style=color:#ae81ff>50</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>bp</span>             <span style=color:#ae81ff>0x0</span>	<span style=color:#ae81ff>0</span><span style=color:#75715e>//其值的确是为0  ------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>sp</span>             <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>)
</span></span></code></pre></div></div></label></div><h2 id=进入main函数>进入main函数
<a class=anchor href=#%e8%bf%9b%e5%85%a5main%e5%87%bd%e6%95%b0>#</a></h2><p>断点到这个函数,然后查看它前几个汇编代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// list /usr/lib/golang/src/runtime/proc.go:113
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>113</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>108</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>109</span>	<span style=color:#75715e>// Value to use for signal mask for newly created M&#39;s.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>110</span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>initSigmask</span> <span style=color:#a6e22e>sigset</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>111</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>112</span>	<span style=color:#75715e>// The main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>113</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span><span style=color:#ae81ff>114</span>		<span style=color:#a6e22e>g</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>115</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>116</span>		<span style=color:#75715e>// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>117</span>		<span style=color:#75715e>// It must not be used for anything else.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>b</span> <span style=color:#ae81ff>113</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>4</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x42aea0</span>: <span style=color:#a6e22e>file</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>, <span style=color:#a6e22e>line</span> <span style=color:#ae81ff>113.</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Continuing</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>main</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>113</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>113</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>108</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>109</span>	<span style=color:#75715e>// Value to use for signal mask for newly created M&#39;s.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>110</span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>initSigmask</span> <span style=color:#a6e22e>sigset</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>111</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>112</span>	<span style=color:#75715e>// The main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>113</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span><span style=color:#ae81ff>114</span>		<span style=color:#a6e22e>g</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>115</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>116</span>		<span style=color:#75715e>// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>117</span>		<span style=color:#75715e>// It must not be used for anything else.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>register</span> <span style=color:#a6e22e>rbp</span> <span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>pc</span> <span style=color:#a6e22e>bp</span> <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x0</span>	<span style=color:#ae81ff>0x0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x42aea0</span>	<span style=color:#ae81ff>0x42aea0</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>main</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>bp</span>             <span style=color:#ae81ff>0x0</span>	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sp</span>             <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>disas</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Dump</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>assembler</span> <span style=color:#a6e22e>code</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>main</span>:
</span></span><span style=display:flex><span>=&gt; <span style=color:#ae81ff>0x000000000042aea0</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>&gt;:	    <span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aea9</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>9</span>&gt;:	    <span style=color:#a6e22e>cmp</span>    <span style=color:#ae81ff>0x10</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aead</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>13</span>&gt;:	<span style=color:#a6e22e>jbe</span>    <span style=color:#ae81ff>0x42b1ea</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>main</span><span style=color:#f92672>+</span><span style=color:#ae81ff>842</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aeb3</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>19</span>&gt;:	<span style=color:#a6e22e>sub</span>    <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x78</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aeb7</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>23</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>,<span style=color:#ae81ff>0x70</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aebc</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>28</span>&gt;:	<span style=color:#a6e22e>lea</span>    <span style=color:#ae81ff>0x70</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aec1</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>33</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aeca</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>42</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,<span style=color:#ae81ff>0x68</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aecf</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>47</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x30</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aed3</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>51</span>&gt;:	<span style=color:#a6e22e>mov</span>    (<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aed6</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>54</span>&gt;:	<span style=color:#a6e22e>movq</span>   <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x0</span>,<span style=color:#ae81ff>0x130</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aee1</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>65</span>&gt;:	<span style=color:#a6e22e>movq</span>   <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x3b9aca00</span>,<span style=color:#ae81ff>0x11e234</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rip</span>)        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#ae81ff>0x549120</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>maxstacksize</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042aeec</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>76</span>&gt;:	<span style=color:#a6e22e>movb</span>   <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x1</span>,<span style=color:#ae81ff>0x14dabc</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rip</span>)        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#ae81ff>0x5789af</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mainStarted</span>&gt;
</span></span></code></pre></div><ul><li>虽然这个rbp是0,是空的,但是还是保存到栈里面去了.</li></ul><pre tabindex=0><code>   0x000000000042aeb3 &lt;+19&gt;:	sub    $0x78,%rsp
   0x000000000042aeb7 &lt;+23&gt;:	mov    %rbp,0x70(%rsp)
   0x000000000042aebc &lt;+28&gt;:	lea    0x70(%rsp),%rbp
</code></pre><h1 id=总结图>总结图
<a class=anchor href=#%e6%80%bb%e7%bb%93%e5%9b%be>#</a></h1><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220623204521.png alt=20220623204521></p><p>g0栈->刚创建的main Goroutine栈:</p><ul><li>mstart->mstart1->save函数调用链保存g0的调度信息(sp/cp 到 g0.sched对应成员之中)</li><li>schedule函数找可运行状态的Goroutine,这里只有我们刚创建的main Goroutine</li><li>gogo函数从g0栈切换到main Goroutine的栈(使用sched里的值填充到寄存器里去),jmp指定跳转到main Goroutine中g.sched.pc(也就是我们创造main Goroutine时设置的main函数)</li><li>main goroutine运行</li></ul><p>已经讲解了图上的上半部分，下节接续</p><h2 id=附录>附录
<a class=anchor href=#%e9%99%84%e5%bd%95>#</a></h2></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#进入main函数前的初始化>进入main函数前的初始化</a><ul><li><a href=#程序加载到内存入口>程序加载到内存入口</a></li><li><a href=#进行初始化全局变量>进行初始化全局变量</a><ul><li><a href=#初始化全局变量g0>初始化全局变量g0</a></li><li><a href=#m0和g0绑定在一起>m0和g0绑定在一起</a></li><li><a href=#设置ncpump的个数初始化m0allp>设置nCPU/M/P的个数,初始化m0,allp</a></li><li><a href=#创建main-goroutine>创建main goroutine</a></li></ul></li><li><a href=#开始m>开始M</a><ul><li><a href=#mstart>mstart</a></li><li><a href=#mstart1>mstart1</a></li><li><a href=#保存pcsp到g0>保存pc,sp到g0</a></li><li><a href=#schedule函数>schedule函数</a></li><li><a href=#execute函数>execute函数</a></li><li><a href=#gogo>gogo</a></li></ul></li><li><a href=#进入main函数>进入main函数</a></li></ul></li><li><a href=#总结图>总结图</a><ul><li><a href=#附录>附录</a></li></ul></li></ul></nav></div></aside></main></body></html>