<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="goroutine退出过程 # goroutine退出,即执行完callee代码后，返回到caller中去，前面一节我们看到，编译器自己把goexit()的地址设置为了caller的pc保存到栈上方,所以退出后，会执行goexit()函数,但是main goroutine比较特殊，这个groutine运行的代码 main函数直接调用了操作系统exit()这个API退出,没有机会返回到caller层.
main goroutine的退出 # 在上节中我们看到程序执行到了 mian函数
// The main goroutine. func main() { g := getg() //... //main包 init函数，递归的调用import包中定义的init函数 fn := main_init // make an indirect call, as the linker doesn't know the address of the main package when laying down the runtime fn() //... //调用main.main函数(用户定义的main函数):进行间接调用是因为链接器在放置运行时不知道主包的地址 fn = main_main // make an indirect call, as the linker doesn't know the address of the main package when laying down the runtime fn() //."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="退出"><meta property="og:description" content="goroutine退出过程 # goroutine退出,即执行完callee代码后，返回到caller中去，前面一节我们看到，编译器自己把goexit()的地址设置为了caller的pc保存到栈上方,所以退出后，会执行goexit()函数,但是main goroutine比较特殊，这个groutine运行的代码 main函数直接调用了操作系统exit()这个API退出,没有机会返回到caller层.
main goroutine的退出 # 在上节中我们看到程序执行到了 mian函数
// The main goroutine. func main() { g := getg() //... //main包 init函数，递归的调用import包中定义的init函数 fn := main_init // make an indirect call, as the linker doesn't know the address of the main package when laying down the runtime fn() //... //调用main.main函数(用户定义的main函数):进行间接调用是因为链接器在放置运行时不知道主包的地址 fn = main_main // make an indirect call, as the linker doesn't know the address of the main package when laying down the runtime fn() //."><meta property="og:type" content="article"><meta property="og:url" content="https://zput.github.io/go-goroutine/docs/runtime/schedule/3_exit_goroutine/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-02-10T10:09:00+00:00"><meta property="article:modified_time" content="2020-02-10T10:09:00+00:00"><title>退出 | go调度源码分析</title><link rel=manifest href=/go-goroutine/manifest.json><link rel=icon href=/go-goroutine/favicon.png type=image/x-icon><link rel=stylesheet href=/go-goroutine/book.min.76f6dbe75c94e688c018dd8b54e7f880916b14ab4cf3881b81f75d6bb916603c.css integrity="sha256-dvbb51yU5ojAGN2LVOf4gJFrFKtM84gbgfdda7kWYDw=" crossorigin=anonymous><script defer src=/go-goroutine/flexsearch.min.js></script>
<script defer src=/go-goroutine/en.search.min.75f3025a21511955ad10f181cae208dd296ce24ee2a06def487a11decfa675f1.js integrity="sha256-dfMCWiFRGVWtEPGByuII3Sls4k7ioG3vSHoR3s+mdfE=" crossorigin=anonymous></script>
<script defer src=/go-goroutine/sw.min.ec96d6e09af3075a94dd4de723a2edddf2ef138381c7e1e5b5a1f2c0578ee8bd.js integrity="sha256-7JbW4JrzB1qU3U3nI6Lt3fLvE4OBx+HltaHywFeO6L0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/go-goroutine/><span>go调度源码分析</span></a></h2><div class=magic><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64><div class="book-search-spinner spinner hidden"></div><ul id=book-search-results></ul></div><div class=book-switch><label class=switch><input id=dark-mode-checkbox type=checkbox onchange=darkmode()>
<span class=slider></span></label></div></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>Zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><hr><ul><li><span>基础知识</span><ul><li><a href=/go-goroutine/docs/foundation/golang_basic/>基本用法</a></li></ul></li><li><span>鲁棒和性能</span><ul><li><a href=/go-goroutine/docs/robustness_and_performance/golang_test/>测试相关函数</a></li></ul></li><li><span>运行时</span><ul><li><a href=/go-goroutine/docs/runtime/golang_gmp/>GMP</a></li><li><a href=/go-goroutine/docs/runtime/golang_gc/>垃圾回收</a></li><li><a href=/go-goroutine/docs/runtime/schedule/>调度</a><ul><li><span>前置知识</span><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/memory/>内存大小端</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/register_functionstack/>伪寄存器与函数栈帧</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/similar_assemble/>类汇编</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/go_underlying_struct/>底层重要结构</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/2_init_before_enter_main_function/>初始化</a></li><li><a href=/go-goroutine/docs/runtime/schedule/3_exit_goroutine/ class=active>退出</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/>调度挑选策略</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/take_goroutine_from_globalorlocal_p/>从全局/本P队列</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/steal_goroutine_from_other_p/>从其他P队列</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/>调度到达时机</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/active_scheduling/>主动调度</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/passive_scheduling/>被动调度</a></li><li><input type=checkbox id=section-99f41010918d678e89a7af90330cabe1 class=toggle>
<label for=section-99f41010918d678e89a7af90330cabe1 class="flex justify-between"><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/>剥夺调度</a></label><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/start_sysmon/>开启系统监控</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/user_code_preemption/>执行太久</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/system_call_preemption/>系统调用抢占</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script><script src=/go-goroutine/magic.js></script>
<script src=/go-goroutine/dark.js></script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/go-goroutine/svg/menu.svg class=book-icon alt=Menu></label>
<strong>退出</strong>
<label for=toc-control><img src=/go-goroutine/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#goroutine退出过程>goroutine退出过程</a><ul><li><a href=#main-goroutine的退出>main goroutine的退出</a></li><li><a href=#非main-goroutine退出>非main goroutine退出</a><ul><li><a href=#gdb断点>gdb断点</a></li><li><a href=#退出三部曲>退出三部曲</a></li><li><a href=#mcall函数>mcall函数</a></li><li><a href=#goexit0函数>goexit0函数</a></li></ul></li><li><a href=#退出流程>退出流程</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=goroutine退出过程>goroutine退出过程
<a class=anchor href=#goroutine%e9%80%80%e5%87%ba%e8%bf%87%e7%a8%8b>#</a></h1><p>goroutine退出,即执行完callee代码后，返回到caller中去，前面一节我们看到，编译器自己把<code>goexit()</code>的地址设置为了caller的pc保存到栈上方,所以退出后，会执行<code>goexit()</code>函数,但是main goroutine比较特殊，这个groutine运行的代码
<a href=https://github.com/golang/go/blob/release-branch.go1.15/src/runtime/proc.go#L114>main函数</a>直接调用了操作系统exit()这个API退出,没有机会返回到caller层.</p><h2 id=main-goroutine的退出>main goroutine的退出
<a class=anchor href=#main-goroutine%e7%9a%84%e9%80%80%e5%87%ba>#</a></h2><p>在上节中我们看到程序执行到了
<a href=https://github.com/golang/go/blob/release-branch.go1.15/src/runtime/proc.go#L114>mian函数</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// The main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>//main包 init函数，递归的调用import包中定义的init函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>main_init</span> <span style=color:#75715e>// make an indirect call, as the linker doesn&#39;t know the address of the main package when laying down the runtime
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     
</span></span><span style=display:flex><span>    <span style=color:#75715e>//调用main.main函数(用户定义的main函数):进行间接调用是因为链接器在放置运行时不知道主包的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fn</span> = <span style=color:#a6e22e>main_main</span> <span style=color:#75715e>// make an indirect call, as the linker doesn&#39;t know the address of the main package when laying down the runtime
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>//系统API:exit函数,退出进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> { 
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>*</span><span style=color:#a6e22e>x</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// 无效指针代码，会导致程序退出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>exit(0)</code>函数与最底部的<code>for</code>循环会让程序不可能回到caller层</li></ul><h2 id=非main-goroutine退出>非main goroutine退出
<a class=anchor href=#%e9%9d%9emain-goroutine%e9%80%80%e5%87%ba>#</a></h2><p>我们首先来gdb调试一下这个程序</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// main.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the function&#39;s body is empty
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  add_amd.s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>y</span><span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDQ</span> <span style=color:#a6e22e>BP</span>, <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>ret</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>FP</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><p>编译一下源代码: <code>go build -gcflags "-N -l" -o test .</code>.</p><h3 id=gdb断点>gdb断点
<a class=anchor href=#gdb%e6%96%ad%e7%82%b9>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span></span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// //list /tmp/kubernets/main.go:3 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// list /tmp/kubernets/add_amd.s:3
</span></span></span><span style=display:flex><span><span style=color:#75715e>// list /usr/lib/golang/src/runtime/asm_amd64.s:1356
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>disas</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>Dump</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>assembler</span> <span style=color:#a6e22e>code</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>add</span>:
</span></span><span style=display:flex;background-color:#3c3d38><span>   <span style=color:#ae81ff>0x0000000000456b40</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>&gt;:     <span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x8</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>   <span style=color:#ae81ff>0x0000000000456b45</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>5</span>&gt;:     <span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x10</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>   <span style=color:#ae81ff>0x0000000000456b4a</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>10</span>&gt;:    <span style=color:#a6e22e>add</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>   <span style=color:#ae81ff>0x0000000000456b4d</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>13</span>&gt;:    <span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>,<span style=color:#ae81ff>0x18</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>=&gt; <span style=color:#ae81ff>0x0000000000456b52</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>&gt;:    <span style=color:#a6e22e>retq</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>End</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>assembler</span> <span style=color:#a6e22e>dump</span>.
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>step</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Single</span> <span style=color:#a6e22e>stepping</span> <span style=color:#a6e22e>until</span> <span style=color:#a6e22e>exit</span> <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>add</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>which</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>no</span> <span style=color:#a6e22e>line</span> <span style=color:#a6e22e>number</span> <span style=color:#a6e22e>information</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>goexit</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>1358</span>
</span></span><span style=display:flex><span>    		<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>goexit1</span>(<span style=color:#a6e22e>SB</span>)	<span style=color:#75715e>// does not return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>	<span style=color:#75715e>// The top-most function running on a goroutine
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>	<span style=color:#75715e>// returns to goexit+PCQuantum.
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>	<span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>goexit</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>		<span style=color:#a6e22e>BYTE</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x90</span>	<span style=color:#75715e>// NOP
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>		<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>goexit1</span>(<span style=color:#a6e22e>SB</span>)	<span style=color:#75715e>// does not return
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>		<span style=color:#75715e>// traceback from goexit1 must hit code range of goexit
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>		<span style=color:#a6e22e>BYTE</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x90</span>	<span style=color:#75715e>// NOP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This is called from .init_array and follows the platform, not Go, ABI.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>)
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>step</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>goexit1</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>2663</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>goexit1</span>() {
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#75715e>//...
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>		<span style=color:#a6e22e>mcall</span>(<span style=color:#a6e22e>goexit0</span>)     <span style=color:#75715e>// goexist1()--&gt;mcall(goexit0)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>step</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  	<span style=color:#75715e>// func mcall(fn func(*g))
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>  	<span style=color:#75715e>// Switch to m-&gt;g0&#39;s stack, call fn(g).
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>  	<span style=color:#75715e>// Fn must never return. It should gogo(&amp;g-&gt;sched)
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>  	<span style=color:#75715e>// to keep running g.
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>  	<span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>mcall</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>NOSPLIT</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>fn</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  
</span></span><span style=display:flex;background-color:#3c3d38><span>  		<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>  		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>), <span style=color:#a6e22e>AX</span>	<span style=color:#75715e>// save state in g-&gt;sched
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>  		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>BX</span>	<span style=color:#75715e>// caller&#39;s PC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>)</span></span></code></pre></td></tr></table></div></div><h3 id=退出三部曲>退出三部曲
<a class=anchor href=#%e9%80%80%e5%87%ba%e4%b8%89%e9%83%a8%e6%9b%b2>#</a></h3><p>从调试结果可以看到从add函数返回后的跳转:</p><table><thead><tr><th>第一步</th><th>第二步</th><th>第三步</th></tr></thead><tbody><tr><td>src/runtime/asm_amd64.s</td><td>src/runtime/proc.go</td><td>src/runtime/asm_amd64.s</td></tr><tr><td>runtime.goexit ()</td><td>goexit1()</td><td>runtime.mcall()</td></tr></tbody></table><p>再看一下源码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// The top-most function running on a goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e>// returns to goexit+PCQuantum.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>goexit</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>BYTE</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x90</span>	<span style=color:#75715e>// NOP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>goexit1</span>(<span style=color:#a6e22e>SB</span>)	<span style=color:#75715e>// does not return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// traceback from goexit1 must hit code range of goexit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>BYTE</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x90</span>	<span style=color:#75715e>// NOP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Finishes execution of the current goroutine.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>goexit1</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {   <span style=color:#75715e>//忽略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>racegoend</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {   <span style=color:#75715e>//忽略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>traceGoEnd</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mcall</span>(<span style=color:#a6e22e>goexit0</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// func mcall(fn func(*g))
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Switch to m-&gt;g0&#39;s stack, call fn(g).
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Fn must never return. It should gogo(&amp;g-&gt;sched)
</span></span></span><span style=display:flex><span><span style=color:#75715e>// to keep running g.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>mcall</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>NOSPLIT</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>fn</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>DI</span> <span style=color:#75715e>//参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>), <span style=color:#a6e22e>AX</span> <span style=color:#75715e>// save state in gN-&gt;sched
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>BX</span> <span style=color:#75715e>// caller&#39;s PC   --&gt;看下方的图
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_pc</span>)(<span style=color:#a6e22e>AX</span>) <span style=color:#75715e>//保存caller&#39;s pc到正在运行的gN.sched.pc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>fn</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span> <span style=color:#75715e>// caller&#39;s SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_sp</span>)(<span style=color:#a6e22e>AX</span>) <span style=color:#75715e>//保存caller&#39;s sp到正在运行的gN.sched.sp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_g</span>)(<span style=color:#a6e22e>AX</span>) <span style=color:#75715e>//保存gN到正在运行的gN.sched.g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BP</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_bp</span>)(<span style=color:#a6e22e>AX</span>) <span style=color:#75715e>//保存bp到正在运行的gN.sched.bp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// switch to m-&gt;g0 &amp; its stack, call fn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>), <span style=color:#a6e22e>BX</span> <span style=color:#75715e>// bx=gN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g_m</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>BX</span> <span style=color:#75715e>// bx=gN.m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>m_g0</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>SI</span> <span style=color:#75715e>// si=gN.m.g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>AX</span> <span style=color:#75715e>// if g == m-&gt;g0 call badmcall; 这个gN不能等于g0, g0应该是用户调度用的.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>JNE</span>	<span style=color:#ae81ff>3</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>badmcall</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JMP</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>)	<span style=color:#75715e>// g = m-&gt;g0; 就是把m.tls[0](TLS)的值从gN的地址换为g0的地址,这样线程通过fs寄存器能找到g0继而找到m   -----------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	(<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_sp</span>)(<span style=color:#a6e22e>SI</span>), <span style=color:#a6e22e>SP</span> <span style=color:#75715e>// sp = m-&gt;g0-&gt;sched.sp,把g0的寄存器SP恢复到真实的SP   ---------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>PUSHQ</span>	<span style=color:#a6e22e>AX</span> <span style=color:#75715e>//gN压栈,作为后面call的参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>DX</span> <span style=color:#75715e>//dx = di(fn函数结构体)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>DI</span>), <span style=color:#a6e22e>DI</span> <span style=color:#75715e>//所以这里是取真正的fn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>DI</span> <span style=color:#75715e>//开始调用fn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>POPQ</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>badmcall2</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JMP</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><h3 id=mcall函数>mcall函数
<a class=anchor href=#mcall%e5%87%bd%e6%95%b0>#</a></h3><p>总结mcall:</p><ul><li>保存当前g的调度信息,寄存器保存到g.sched;</li><li>把g0设置到tls中，修改CPU的rsp寄存器使其指向g0的栈;</li><li>以当前运行的g(我们这个场景是gN)为参数调用fn函数(此处为goexit0).</li></ul><p>看下这个mcall函数的形参,它不是一个直接指向函数代码的指针，而是一个指向funcval结构体对象的指针，funcval结构体对象的第一个成员fn才是真正指向函数代码的指针.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#66d9ef>DI</span>, <span style=color:#66d9ef>DX</span>        <span style=color:#75715e># dx = di(fn函数)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>MOVQ</span> <span style=color:#ae81ff>0</span>(<span style=color:#66d9ef>DI</span>), <span style=color:#66d9ef>DI</span>     <span style=color:#75715e># 所以这里是取真正的fn
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>funcval</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// variable-size, fn-specific data here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><hr><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220624171607.png alt=20220624171607></p><ul><li>g0 -> gN: <strong>gogo</strong>会进行栈的切换,同时里面的jmp指令会跳转到gN的g结构schdt.pc保存的地址去执行.</li><li>gN -> g0: <strong>mcall</strong>会进行栈的切换,它从上游用户代码退出后，进入的goexit函数就已经是go系统代码了，直接继续执行下去就好，不需要jmp跳转.<ul><li>这里恢复栈是只恢复了sp,没有把<strong>pc重置!!!</strong></li></ul></li></ul><h3 id=goexit0函数>goexit0函数
<a class=anchor href=#goexit0%e5%87%bd%e6%95%b0>#</a></h3><ul><li>更改g状态:_Grunning -> _Gdead</li><li>调用dropg函数解除g和m之间的关系，其实就是设置g->m = nil, m->currg = nil</li><li>调用gfput函数<ul><li>把g放入p的freeg队列缓存起来供下次创建g时利用,不用再重新生成一个新g</li><li>如本地gfree列表太长，则放到全局去</li></ul></li><li>调用schedule函数再次进行调度</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// goexit continuation on g0.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>goexit0</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>() <span style=color:#75715e>// g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Grunning</span>, <span style=color:#a6e22e>_Gdead</span>) <span style=color:#75715e>// 修改gN的状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isSystemGoroutine</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>ngsys</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>locked</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>lockedm</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>lockedm</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>lockedg</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>paniconfault</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>_defer</span> = <span style=color:#66d9ef>nil</span> <span style=color:#75715e>// should be true already but just in case.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>_panic</span> = <span style=color:#66d9ef>nil</span> <span style=color:#75715e>// non-nil for Goexit during panic. points at stack-allocated data.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>writebuf</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waitreason</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>labels</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Note that gp&#39;s stack scan is now &#34;valid&#34; because it has no
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>gcscanvalid</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dropg</span>() <span style=color:#75715e>//dropg函数解除g和m之间的关系，其实就是设置g-&gt;m = nil, m-&gt;currg = nil.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gfput</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>(), <span style=color:#a6e22e>gp</span>) <span style=color:#75715e>//放在gfree列表中,如果本地列表太长，则将一个批次转移到全局列表中.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>schedule</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=退出流程>退出流程
<a class=anchor href=#%e9%80%80%e5%87%ba%e6%b5%81%e7%a8%8b>#</a></h2><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20220624171805.png alt=20220624171805></p><ul><li>上图蓝色框起来的就是退出调用的函数链:</li></ul><pre tabindex=0><code>goexit()-&gt;goexit1()-&gt;mcall()-&gt;goexit0()-&gt;schedule()
______________gN栈_________|__________g0栈_________|
</code></pre></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#goroutine退出过程>goroutine退出过程</a><ul><li><a href=#main-goroutine的退出>main goroutine的退出</a></li><li><a href=#非main-goroutine退出>非main goroutine退出</a><ul><li><a href=#gdb断点>gdb断点</a></li><li><a href=#退出三部曲>退出三部曲</a></li><li><a href=#mcall函数>mcall函数</a></li><li><a href=#goexit0函数>goexit0函数</a></li></ul></li><li><a href=#退出流程>退出流程</a></li></ul></li></ul></nav></div></aside></main></body></html>